

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Python module &mdash; Gromacs External Interfaces</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Gromacs External Interfaces" href="../index.html"/>
        <link rel="up" title="Implementation layers" href="../layers.html"/>
        <link rel="next" title="Low-level Python API" href="bindings.html"/>
        <link rel="prev" title="Implementation layers" href="../layers.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Gromacs API
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Documentation sections</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userguide.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developerguide.html">Architecture and design notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components.html">Components</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../layers.html">Implementation layers</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Python module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#other-python-gromacs-interfaces">Other Python Gromacs interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="#existing-python-tools-to-leverage">Existing Python tools to leverage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#naming">Naming</a></li>
<li class="toctree-l3"><a class="reference internal" href="#python-version">Python version</a></li>
<li class="toctree-l3"><a class="reference internal" href="#use-cases-and-scenarios">Use cases and Scenarios</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#traditional-hpc-scenarios">Traditional HPC scenarios</a></li>
<li class="toctree-l4"><a class="reference internal" href="#target-scenarios">Target scenarios</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#set-up-and-run-a-simple-simulation">Set up and run a simple simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#trajectory-analysis">Trajectory analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sea-level-scenario-simulate-counter-ion-effects-on-peptide-from-pdb">Sea-level Scenario: Simulate counter-ion effects on peptide from PDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="#construct-topology-and-structure-objects">Construct topology and structure objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-with-frozen-n-and-c-terminals">Run with frozen N and C terminals</a></li>
<li class="toctree-l4"><a class="reference internal" href="#trajectory-manipulation-tasks">Trajectory Manipulation tasks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#tensorflow-analogy">TensorFlow analogy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="bindings.html">Low-level Python API</a></li>
<li class="toctree-l2"><a class="reference internal" href="middleware.html">Execution context abstraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="cppapi.html">C++ API</a></li>
<li class="toctree-l2"><a class="reference internal" href="library.html">Core Gromacs library</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change Log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Gromacs API</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../layers.html">Implementation layers</a> &raquo;</li>
        
      <li>Python module</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/layers/python.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="python-module">
<h1>Python module<a class="headerlink" href="#python-module" title="Permalink to this headline">¶</a></h1>
<p>Goal: Expose Gromacs functionality in an interface
that can be easily driven and interacted with from Python (or other
high-level languages) and external APIs for e.g. &#8220;cloud&#8221; computing resources,
container systems, work flow / compute resource managers. Data graph execution
at various levels may be deferred to other tools, but should at least be
facilitated by the design.</p>
<p>There are several broad classes of use cases that warrant different levels of access,
abstraction, performance, and invasiveness into the existing code.
In rough order of increasing invasiveness.</p>
<ol class="arabic simple">
<li>Post-run analysis (expose and extend the current C++ API, file readers, wrapped tools)</li>
<li>Preparation, preprocessing, and editing of simulation jobs or on-disk information (encapsulation of tools like <cite>pdb2gmx</cite>, <cite>grompp</cite>, <cite>trajedit</cite>, <cite>solvate</cite>, and of data structures such as topologies, <cite>tpr</cite> files, trajectories and checkpoints)</li>
<li>Controlling Gromacs code (scripting, managing compute resources, high level workflow and data flow, clearly separating model parameters / simulation parameters / workflow parameters / runtime parameters)</li>
<li>Live analysis (hooks into MD loop: callbacks, custom loggers)</li>
<li>Extension of Gromacs code (adding custom potentials, logic, low level workflow and data flow)</li>
</ol>
<p>The APIs developed should allow access to these functionalities.
A user should be able to link together tasks programatically, dynamically, and
with no requirements of filesystem I/O.</p>
<p>Gromacs command-line functionality should be easily achieved in a Python script. This
does not mean that all CLI tools should be simply exposed to Python, since
many represent trivial data transformations, tasks that are well-handled by other
Python-based tools, or easily-scripted tasks. Common scriptable tasks can be
provided by high-level convenience functions or &#8220;bottled&#8221; workflows. More
elemental functionality that should be available through the C++ API can be
exposed through bindings to the Python API.</p>
<p>With Python&#8217;s reference counting and conceptual differences about the mutability
of data, it is appropriate to support a few different modes of access to Gromacs
data structures in the C++ API. When it is necessary to copy data, explicit API syntax should
make it clear to the user. When possible, the Python buffer protocol can be used
to give Python direct access to memory shared by C++ data structures. In general,
though, for data and objects that exist only to be used in subsequent API calls,
proxy objects can be used at a high level with interactions between objects
deferred to the C++ library API where the parallelism framework and optimizations
already exist. This also helps with the notion that the Python interpreter
expects to &#8220;own&#8221; objects that are handed to it through bindings.</p>
<p>The design should emphasize idiomatic Python usage.</p>
<div class="section" id="other-python-gromacs-interfaces">
<h2>Other Python Gromacs interfaces<a class="headerlink" href="#other-python-gromacs-interfaces" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/pslacerda/gmx">gmxscript</a> : all-python CLI
wrapper manages files, provides &#8220;checkpointed&#8221; re-runnable workflow with
mdp rewriting and CLI replacement</p>
<p><a class="reference external" href="http://gromacswrapper.readthedocs.io/en/latest/">GromacsWrapper</a>
(Beckstein) : all-python CLI wrapper provides thorough scriptable
interface with error handling</p>
<p><a class="reference external" href="https://github.com/dseeliger/pmx">pmx</a> (D. Seeliger) : Manipulate
Gromacs files and data structures</p>
<p><a class="reference external" href="https://github.com/GromPy">grompy</a> (Rene Pool) : patches old Gromacs
code to provide ctypes interface to Gromacs libraries</p>
<p><a class="reference external" href="https://github.com/khuston/gmx_wrapper">gmx_wrapper</a> : very
bare-bones CLI wrapper</p>
<p><a class="reference external" href="https://biod.pnpi.spb.ru/gitweb/?p=alexxy/gromacs.git;a=commit;h=1241cd15da38bf7afd65a924100730b04e430475">GromacsPipeline</a>
(Redmine 1625) adds SIP bindings to run Gromacs analysis modules in a
single pass on a trajectory</p>
</div>
<div class="section" id="existing-python-tools-to-leverage">
<h2>Existing Python tools to leverage<a class="headerlink" href="#existing-python-tools-to-leverage" title="Permalink to this headline">¶</a></h2>
<p>Some of the tools available from the <code class="docutils literal"><span class="pre">gmx</span></code> command-line interface
are bundled largely for convenience,
and Python users may be better served by turning to other projects
rather than relying on exposing
redundant functionality from <code class="docutils literal"><span class="pre">libgromacs</span></code>.
In other cases, Gromacs developers may simply want to be aware of the
other tools and interoperability requirements.</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/williamgilpin/pypdb">pypdb</a> A Python API for
the RCSB Protein Data Bank (PDB)</li>
<li><a class="reference external" href="http://chemlab.github.io/chemlab/">chemlab</a> Qt-powered molecular
viewer</li>
<li><a class="reference external" href="https://github.com/gabrielelanaro/chemview">chemview</a> molecular
viewer for IPython from the author of chemlab</li>
<li><a class="reference external" href="http://mdtraj.org/">MDTraj</a> Read, write and analyze MD
trajectories</li>
<li><a class="reference external" href="http://www.mdanalysis.org">MDAnalysis</a> analyze trajectories from
molecular dynamics</li>
<li><a class="reference external" href="https://github.com/biopython/biopython">Biopython</a> tools for
computational molecular biology</li>
<li>several packages named &#8220;Biopy&#8221; do not seem relevant</li>
<li><a class="reference external" href="http://www.pymol.org/">PyMOL</a> molecular viewer</li>
<li><a class="reference external" href="http://pymmlib.sourceforge.net/">mmLib</a> Python Macromolecular
Library analysis, manipulation, and viewing</li>
<li><a class="reference external" href="http://msmbuilder.org/">msmbuilder</a> Statistical models for
Biomolecular Dynamics</li>
<li><a class="reference external" href="http://emma-project.org/">PyEMMA</a> estimation, validation and
analysis Markov models from molecular dynamics (MD) data</li>
<li><a class="reference external" href="http://extasy-project.org">ExSTACY</a> Collection of tools that
couples large ensemble Molecular Dynamics calculations with analysis
to provide improvements in sampling. Includes</li>
<li><a class="reference external" href="https://github.com/radical-cybertools/radical.ensemblemd">EnsembleMD</a>
framework for running ensemble workflows</li>
<li><a class="reference external" href="https://bitbucket.org/extasy-project/coco">COCO</a></li>
<li><a class="reference external" href="https://sourceforge.net/projects/lsdmap/">LSDMap</a> Locally Scaled
Diffusion Maps</li>
<li><a class="reference external" href="https://bitbucket.org/ramonbsc/pypcazip">pyPcazip</a> principle
component analysis</li>
<li><a class="reference external" href="http://www.plumed.org">Plumed</a> free energy calculation using
collective variables</li>
<li>pdb tools</li>
<li>OpenMM</li>
<li>msmbuilder</li>
<li>BioXL</li>
</ul>
</div>
<div class="section" id="naming">
<h2>Naming<a class="headerlink" href="#naming" title="Permalink to this headline">¶</a></h2>
<p>The package should have a name that does not collide with other known
projects, particularly any projects on pypi.
&#8220;gmx&#8221; is available on pypi, but similar existing package names include</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">gmx-script</span></code></li>
<li><code class="docutils literal"><span class="pre">python-gmx</span></code></li>
</ul>
<p><code class="docutils literal"><span class="pre">pygmx</span></code> is the name used for a bindings package posted to the Gromacs
list that resides at <a class="reference external" href="https://biod">https://biod</a>. pnpi.spb.ru/~alexxy/pygmx</p>
<p>There are several packages named <code class="docutils literal"><span class="pre">grompy</span></code></p>
<p>The Beckstein lab has <code class="docutils literal"><span class="pre">GromacsWrapper</span></code> which exists on
PythonHosted.org, GitHub, and PyPi.</p>
</div>
<div class="section" id="python-version">
<h2>Python version<a class="headerlink" href="#python-version" title="Permalink to this headline">¶</a></h2>
<p>Python 3.3 has a lot of improvements and changes, including better 2.7 compatibility</p>
<p>Python 3.4</p>
<ul class="simple">
<li>built-in pip</li>
<li>enum types</li>
<li>new pickle protocol</li>
</ul>
<p>Python 3.5</p>
<ul class="simple">
<li>typing and coroutines</li>
<li>RecursionError exception</li>
<li>Generators have gi_yieldfrom</li>
<li>memoryview tuple indexing</li>
<li>hexadecimal methods</li>
</ul>
<p>Linux distributions released after June 2013 and supported at least to June 2019.</p>
<div class="line-block">
<div class="line">Ubuntu 14.04 (trusty): Python 3.4</div>
<div class="line">Ubuntu 16.04 (denial): Python 3.5</div>
<div class="line">Debian 8 (jessie): Python 3.4</div>
<div class="line">Debian 9 (stretch): Python 3.5</div>
<div class="line">Linux Mint 18 (rosa): 3.4</div>
<div class="line">Linux Mint 17 (sarah): 3.5</div>
<div class="line">Fedora 23: 3.4</div>
<div class="line">Fedora 24+: 3.5</div>
<div class="line">RHEL 7: n/a</div>
<div class="line">CentOS 7: n/a</div>
</div>
<p>Suggestion: Initially support Python 2.7 and 3.3, with both immediately
depracated. Plan to require Python 3.4+ when Python 2.7 is end-of-lifed in 2020.
Python 3.4 is widely supported by distributions that, as of a projected public
release, will have been released less than five years ago and will be supported
for at least another year. Built-in <cite>pip</cite> and enum types would be very nice to
be able to rely on. If Python 2.7 is supported, then we should not support less
than Python 3.3, but it may be hard enough to take advantage of features in 3.4+
that there isn&#8217;t a good reason to require it without motivation from a clear
roadmap of which versions Gromacs will support in the future.</p>
</div>
<div class="section" id="use-cases-and-scenarios">
<h2>Use cases and Scenarios<a class="headerlink" href="#use-cases-and-scenarios" title="Permalink to this headline">¶</a></h2>
<div class="section" id="traditional-hpc-scenarios">
<h3>Traditional HPC scenarios<a class="headerlink" href="#traditional-hpc-scenarios" title="Permalink to this headline">¶</a></h3>
<p>An incomplete list of some contemporary modes of scientific computing.</p>
<div class="section" id="large-scale-mpi-job-on-hpc-cluster">
<h4>large-scale MPI job on HPC cluster<a class="headerlink" href="#large-scale-mpi-job-on-hpc-cluster" title="Permalink to this headline">¶</a></h4>
<p>Traditional large-scale MPI job on HPC cluster</p>
<div class="line-block">
<div class="line">1. User submits job requesting many resources (e.g. N m-core ranks)</div>
<div class="line">2. Queuing system simultaneously launches N processes with access to MPI
environments and interconnect libraries installed on the compute nodes</div>
<div class="line">3. Each process uses its linked MPI library and runtime environment to access its MPI communicator</div>
<div class="line">4. Each process runs a copy of the same object code with different(ly processed) input</div>
<div class="line">5. Processes communicate through the MPI communicator as needed</div>
<div class="line">6. Processes terminate individually (but hopefully simultaneously) and job
completes, leaving results in a shared filesystem or first transferring data to a master rank</div>
</div>
</div>
<div class="section" id="user-managed-bag-of-jobs-on-hpc-cluster">
<h4>user-managed bag-of-jobs on HPC cluster<a class="headerlink" href="#user-managed-bag-of-jobs-on-hpc-cluster" title="Permalink to this headline">¶</a></h4>
<p>Traditional independent bag-of-jobs on HPC cluster with shared storage</p>
<div class="line-block">
<div class="line">1. User submits many isolated job scripts</div>
<div class="line">2. Queuing system executes job script on reserved resources as available.</div>
<div class="line">3. Job script uses unique parameters, environment variables, and job ID to run a unique simulation asynchronously.</div>
<div class="line">4. User retrieves and/or analyzes data</div>
</div>
<p>Alternate scenarios</p>
<div class="line-block">
<div class="line">1b. User submits a job script many times (or as a job array) with different parameters</div>
<div class="line">4b. Queuing system job dependencies chain tasks (unreliable in practice) using shared filesystem</div>
</div>
</div>
<div class="section" id="pilot-managed-jobs-on-hpc-cluster">
<h4>pilot-managed jobs on HPC cluster<a class="headerlink" href="#pilot-managed-jobs-on-hpc-cluster" title="Permalink to this headline">¶</a></h4>
<p>Traditional independent bag-of-jobs on pilot-managed HPC resource allocation</p>
<div class="line-block">
<div class="line">1. User submits pilot job</div>
<div class="line">2. Queuing system notifies user when pilot job is running</div>
<div class="line">3a. User submits bag-of-jobs to pilot manager</div>
<div class="line">4a. Pilot manager transfers scripts and data and connects to compute nodes to execute tasks as resources are available in the pilot job</div>
</div>
<p>Alternate scenario: Managed ensemble workflow on pilot-managed HPC resource allocation</p>
<div class="line-block">
<div class="line">3b. User specifies workflow elements and parameters to ensemble manager
(e.g. cross-correlate all permutations of trajectory pairs)</div>
<div class="line">4b. Ensemble manager generates pilot work units using pilot interface</div>
<div class="line">5. Pilot manager finds available resources, transfers data and connects to
compute nodes to execute remote commands (which may invoke single processes,
multi-threaded processes, or MPI process groups).</div>
<div class="line">6. Ensemble manager collates results</div>
</div>
</div>
<div class="section" id="commodity-cloud-computing">
<h4>commodity cloud computing<a class="headerlink" href="#commodity-cloud-computing" title="Permalink to this headline">¶</a></h4>
<p>Various scenarious, depending on environment and user preferences, involving VMs
or Docker images. Avoiding expensive data storage costs can require a lot of
scripting and testing of chained tasks.</p>
</div>
</div>
<div class="section" id="target-scenarios">
<h3>Target scenarios<a class="headerlink" href="#target-scenarios" title="Permalink to this headline">¶</a></h3>
<p>Following are an assortment of tasks that we are targeting with the Python
interface and API design.</p>
<div class="section" id="programmatically-launch-many-similar-simulations">
<h4>Programmatically launch many similar simulations<a class="headerlink" href="#programmatically-launch-many-similar-simulations" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="run-analyze-run-chained-tasks-in-pipeline">
<h4>Run -&gt; analyze -&gt; run chained tasks in pipeline<a class="headerlink" href="#run-analyze-run-chained-tasks-in-pipeline" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="data-graph-execution">
<h4>Data graph execution<a class="headerlink" href="#data-graph-execution" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="implement-adapt-a-new-execution-manager">
<h4>Implement/adapt a new execution manager<a class="headerlink" href="#implement-adapt-a-new-execution-manager" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="scripted-workflow">
<h4>Scripted workflow<a class="headerlink" href="#scripted-workflow" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">1. <a class="reference internal" href="#load-pdb-data">Load pdb data</a></div>
<div class="line">2. <a class="reference internal" href="#perform-energy-minimization">Perform energy minimization</a></div>
<div class="line">3. <a class="reference internal" href="#solvate">Solvate</a></div>
<div class="line">4. <a class="reference internal" href="#add-ions">Add ions</a></div>
<div class="line">5. <a class="reference internal" href="#perform-energy-minimization">Perform energy minimization</a></div>
<div class="line">6. <a class="reference internal" href="#equilibration">Equilibration</a></div>
<div class="line-block">
<div class="line">6.1. NVT</div>
<div class="line">6.2. NpT</div>
</div>
<div class="line">7. Launch simulation job</div>
</div>
</div>
<div class="section" id="load-pdb-data">
<h4>Load pdb data<a class="headerlink" href="#load-pdb-data" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">1. Read and clean pdb file</div>
<div class="line">2. Get topology from factory using built-in force field definition</div>
<div class="line">3. Produce <code class="docutils literal"><span class="pre">.gro</span></code> and <code class="docutils literal"><span class="pre">.top</span></code> files</div>
<div class="line">4. <a class="reference internal" href="#set-up-a-simulation-box">Set up a simulation box</a></div>
</div>
<p>Alternate: bottled workflow</p>
<div class="line-block">
<div class="line">1a. use a utility / helper function <code class="docutils literal"><span class="pre">like</span> <span class="pre">pdb2gmx</span></code></div>
<div class="line-block">
<div class="line">1.1. proceed to 4.</div>
</div>
</div>
<p>Alternate: non-automated topology construction</p>
<div class="line-block">
<div class="line">2a. Start from an empty or existing Topology object</div>
<div class="line-block">
<div class="line">2a.1. get or define a forcefield data structure</div>
<div class="line">2a.2. use member functions of Topology object to modify</div>
</div>
</div>
</div>
<div class="section" id="set-up-a-simulation-box">
<h4>Set up a simulation box<a class="headerlink" href="#set-up-a-simulation-box" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">1. Read a structure (<code class="docutils literal"><span class="pre">.gro</span></code>) file</div>
<div class="line">2. Edit data</div>
<div class="line">3. Write out new structure file</div>
</div>
<p>Alternate: no file I/O</p>
<div class="line-block">
<div class="line">1a. Create or reuse a AtomData object</div>
<div class="line-block">
<div class="line">1a.1 set box parameters for object</div>
<div class="line">1a.2 done</div>
</div>
</div>
</div>
<div class="section" id="perform-energy-minimization">
<h4>Perform energy minimization<a class="headerlink" href="#perform-energy-minimization" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">1. Create input record</div>
<div class="line-block">
<div class="line">1.1 Read mdp file</div>
<div class="line">1.2 Save tpr file</div>
</div>
<div class="line">2. Optionally configure filesystem output and then run.</div>
</div>
<p>Alternate: avoid redundant file I/O</p>
<div class="line-block">
<div class="line">1a. Operate on and produce Topology, Particles, and System objects without
file I/O using previously generated objects and mdp file</div>
<div class="line">2a. Run energy minimizer with no filesystem output</div>
</div>
<p>Alternate: skip mdp file</p>
<div class="line-block">
<div class="line">1b. Skip mdp file with granular functionality and parameters in Python data structures</div>
<div class="line-block">
<div class="line">1.1 set parameters for minimizer, general integrator, and neighborlist</div>
<div class="line">1.2 create System and Context objects</div>
<div class="line">1.3 create minimizer object and bind everything together</div>
</div>
</div>
<p>or</p>
<div class="line-block">
<div class="line">1c. reuse the last minimizer System and Context</div>
<div class="line-block">
<div class="line">1c.1. update minimizer parameters and configuration</div>
<div class="line">1c.2. proceed to 2.</div>
</div>
</div>
<p>Alternate: additional logging</p>
<div class="line-block">
<div class="line">2d. Optionally configure Reporter objects before running</div>
</div>
</div>
<div class="section" id="solvate">
<h4>Solvate<a class="headerlink" href="#solvate" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Load solvent and coordinates files</li>
<li>Use utility to create new configuration from appropriate data</li>
<li>Save solvated <code class="docutils literal"><span class="pre">.gro</span></code> file</li>
</ol>
<p>Alternate: use package data instead of files</p>
<div class="line-block">
<div class="line">1a. Specify solvent molecule accessed through the module</div>
</div>
<p>Alternates: System methods instead of utility functions</p>
<div class="line-block">
<div class="line">2a. Update an existing System with provided solvent data</div>
<div class="line">2b. Update an existing System with the default solvent</div>
</div>
</div>
<div class="section" id="add-ions">
<h4>Add ions<a class="headerlink" href="#add-ions" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">1. Get configuration with force field</div>
<div class="line-block">
<div class="line">1.1 Read new mdp file</div>
<div class="line">1.2 Save new tpr file</div>
</div>
<div class="line">2. Use utility to insert ions and produce a new System object</div>
<div class="line">3. Optionally save new configuration</div>
</div>
<p>Alternate:</p>
<div class="line-block">
<div class="line">1a. re-use an instantiated System</div>
</div>
<p>User alternative:</p>
<div class="line-block">
<div class="line">2a. new system constructed with fancy constructor</div>
</div>
<p>Implementation alternative:</p>
<div class="line-block">
<div class="line">2b. utility produces just a configuration</div>
</div>
<p>Alternate: operate on objects</p>
<div class="line-block">
<div class="line">2c. Use generic <code class="docutils literal"><span class="pre">change_residues</span></code> method with various modes of operation.</div>
</div>
</div>
<div class="section" id="equilibration">
<h4>Equilibration<a class="headerlink" href="#equilibration" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">1. Configure from mdp and other files using convenience function to
construct System</div>
<div class="line">2. Optionally save input record</div>
<div class="line">3. Run simulation</div>
<div class="line">4. Optionally save output to file or just retain object for later API call</div>
</div>
<p>Implementation option:</p>
<div class="line-block">
<div class="line">1a. convenience function can handle a variety of input argument types and
forward to an appropriate helper function for files, current instances, etc.</div>
</div>
</div>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="set-up-and-run-a-simple-simulation">
<h3>Set up and run a simple simulation<a class="headerlink" href="#set-up-and-run-a-simple-simulation" title="Permalink to this headline">¶</a></h3>
<p>Consider the entire workflow as a directed acyclic graph.</p>
<p>With various implicit functionality and helper functions, a simple script may
look like this.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">system</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s1">&#39;nvt.mdp&#39;</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">pdbsource</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">pdbsource</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>

<span class="c1"># Custom analysis code can be attached as an API oject, or a convenient but</span>
<span class="c1"># lower performing call-back.</span>
<span class="n">system</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">callback</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">timestep</span><span class="p">:</span> <span class="n">do_something</span><span class="p">(</span><span class="n">timestep</span><span class="p">),</span>
                    <span class="n">period</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">ps</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>

<span class="c1"># System is only allowed to have one &quot;runnable&quot; object bound,</span>
<span class="c1"># which is implicitly system.integrator</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</pre></div>
</div>
<p>Here I use a lambda to indicate callback signature. Though it is conceivable
to serialize lambdas and closures for non-local execution contexts, it is
questionable whether this is a rabbit-hole we would want to go down. The
context layer can, however, do some introspection and in the worst case
can just implicitly retrieve state to the calling Python interpreter every
<code class="docutils literal"><span class="pre">period</span></code> timesteps. In such a case, it would be the remote execution
context that holds a thin proxy object representing the (Sink) callback node.</p>
<p>Note that rather than try to figure out what data a call-back needs, the call-back can be constructed as a functor or with a closure that binds to the system or integrator API objects before the simulation launches, allowing the library freedom to provide a call-back with only the access and data it needs.</p>
<p>Continuing the notion that data constitutes graph edges and computation constitutes
graph nodes. Special terminal nodes are Source and Sink objects that only provide
ports for data flow in one direction. The following assumes a framework in which
standard data stream types have standard names or other means of discovery.
Non-standard data streams could be extracted from catch-all bundled data or
represented with classes defined in additional extensions.</p>
<p>The above script implicitly translates to the following, which a user could
just as well use if desiring more control or additional data handles.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Or use other tools for preparation...</span>
<span class="kn">import</span> <span class="nn">pypdb</span>
<span class="n">pdbfile</span> <span class="o">=</span> <span class="n">pypdb</span><span class="o">.</span><span class="n">get_pdb_file</span><span class="p">(</span><span class="n">somerecord</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s1">&#39;pdb&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># repair sequence errors, sanitizing</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">myscripts</span><span class="o">.</span><span class="n">clean_pdb</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">)</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">TopologyBuilder</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">forcefields</span><span class="o">.</span><span class="n">amber99sb</span><span class="o">-</span><span class="n">ildn</span><span class="p">,</span> <span class="n">water</span><span class="o">=</span><span class="s1">&#39;tip3p&#39;</span><span class="p">)</span>
<span class="c1"># Create an object that is both a StructureSource and TopologySource</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">from_pdb</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

<span class="c1"># set up a (set of) simulation(s) with API calls, and include energy log</span>
<span class="n">options</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">from_mdp</span><span class="p">(</span><span class="s1">&#39;nvt.mdp&#39;</span><span class="p">)</span>
<span class="n">options</span><span class="o">.</span><span class="n">temperature_coupling</span><span class="p">(</span><span class="s1">&#39;Nose-Hoover&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="mi">323</span><span class="p">,</span> <span class="mi">323</span><span class="p">,</span> <span class="mi">323</span><span class="p">]</span>
<span class="n">options</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="s1">&#39;Verlet&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ns_type</span> <span class="o">=</span> <span class="s1">&#39;grid&#39;</span>

<span class="c1"># Set and initialize electrostatics options::</span>

<span class="n">pme</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">coulombtype</span><span class="p">(</span><span class="s1">&#39;PME&#39;</span><span class="p">)</span>
<span class="n">pme</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">pme</span><span class="o">.</span><span class="n">fourierspacing</span> <span class="o">=</span> <span class="mf">0.16</span>
<span class="n">nvt</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">Integrator</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

<span class="c1"># Create an object that is a VelocitySource with trivial iterator.</span>
<span class="c1"># Initialize with temperature atomic mass data. No inputs. Yields a set of</span>
<span class="c1"># velocities.</span>
<span class="n">v_init</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">ThermalVelocities</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

<span class="c1"># Note:</span>
<span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">VelocitySource</span><span class="p">(</span><span class="n">v_init</span><span class="p">)</span> <span class="ow">is</span> <span class="n">v_init</span><span class="o">.</span><span class="n">velocity</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">record</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">record</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">v_init</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">nvt</span>

<span class="c1"># Remove the last logger-like object, if any</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nvt</span><span class="o">.</span><span class="n">observers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span>
        <span class="n">nvt</span><span class="o">.</span><span class="n">observers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># Add outputs</span>
<span class="n">gmx</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">FileLogger</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="o">**</span><span class="n">log_params</span><span class="p">)</span>
<span class="n">gmx</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TrajectoryFile</span><span class="p">(</span><span class="n">nvt</span><span class="p">,</span> <span class="o">**</span><span class="n">trajout_params</span><span class="p">)</span>

<span class="c1"># Custom analysis code can still be attached as above, or a convenient but</span>
<span class="c1"># lower performing call-back used.</span>
<span class="n">nvt</span><span class="o">.</span><span class="n">callback</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">timestep</span><span class="p">:</span> <span class="n">do_something</span><span class="p">(</span><span class="n">timestep</span><span class="p">),</span>
                    <span class="n">period</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">ps</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>

<span class="c1"># run simulation(s)</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">nvt</span><span class="p">)</span>

<span class="c1"># Check for energy convergence and rerun</span>

<span class="k">def</span> <span class="nf">converged</span><span class="p">(</span><span class="n">quantity</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">something_clever</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>

<span class="k">while</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">(</span><span class="n">nvt</span><span class="o">.</span><span class="n">potential_energy</span><span class="p">):</span>
    <span class="n">options</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">+=</span> <span class="mi">10000</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">nvt</span><span class="p">)</span>
</pre></div>
</div>
<p>Note: A task like energy minimization can be implemented as a &#8220;bottled workflow&#8221; implemented at the highest level, as a series of API objects connected in the simulation&#8211;analysis graph, as a plugin, or as an &#8220;integrator&#8221;.</p>
<p>For additional musings, see <a class="reference internal" href="library.html"><span class="doc">Core Gromacs library</span></a></p>
</div>
<div class="section" id="trajectory-analysis">
<h3>Trajectory analysis<a class="headerlink" href="#trajectory-analysis" title="Permalink to this headline">¶</a></h3>
<div class="section" id="implicit-context-management">
<h4>Implicit context management<a class="headerlink" href="#implicit-context-management" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gmx</span>
<span class="kn">from</span> <span class="nn">gmx</span> <span class="kn">import</span> <span class="n">TrajectoryFile</span>

<span class="c1"># instantiate trajectory file object</span>
<span class="n">mytraj</span> <span class="o">=</span> <span class="n">TrajectoryFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="c1"># note nothing is in it yet</span>
<span class="nb">dir</span><span class="p">(</span><span class="n">mytraj</span><span class="p">)</span>

<span class="c1"># add my_filter to to tool chain</span>
<span class="n">my_filter</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="n">mytraj</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">my_filter</span><span class="p">)</span> <span class="c1"># we see the output streams available</span>

<span class="c1"># bind low-pass output to saxs modeling to tool chain</span>
<span class="n">mysaxs</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Saxs</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="n">my_filter</span><span class="o">.</span><span class="n">lowpass</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mytraj</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
<span class="n">filehandle</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">DataFile</span><span class="p">(</span><span class="s1">&#39;saxs.xvg&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mysaxs</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># get data handle to high-pass output and process into numpy</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">extract</span><span class="p">(),</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">mytraj</span><span class="p">]</span>
<span class="k">except</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">e</span><span class="o">.</span><span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;No execution context&quot;</span>
<span class="c1"># No context is active, and initializing one implicitly could cause poorly-</span>
<span class="c1"># defined behavior for the unevaluated API objects, partiularly if more are</span>
<span class="c1"># added after the extract</span>

<span class="c1"># evaluate remaining tasks and finish</span>
<span class="n">gmx</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="c1"># or</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="o">**</span><span class="n">runtime_params</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>

<span class="c1"># only get the last frame</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mytraj</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">extract</span><span class="p">(),</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="explicit-context-management">
<h4>Explicit context management<a class="headerlink" href="#explicit-context-management" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># instantiate trajectory file object</span>
<span class="n">mytraj</span> <span class="o">=</span> <span class="n">TrajectoryFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="c1"># note nothing is in it yet</span>
<span class="nb">dir</span><span class="p">(</span><span class="n">mytraj</span><span class="p">)</span>

<span class="c1"># add filter to to tool chain</span>
<span class="n">my_filter</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="n">mytraj</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">my_filter</span><span class="p">)</span> <span class="c1"># we see the output streams available</span>

<span class="c1"># bind low-pass output to saxs modeling to tool chain</span>
<span class="n">mysaxs</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Saxs</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="n">my_filter</span><span class="o">.</span><span class="n">lowpass</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mytraj</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
<span class="n">gmx</span><span class="o">.</span><span class="n">DataFile</span><span class="p">(</span><span class="s1">&#39;saxs.xvg&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mysaxs</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">LocalContext</span><span class="p">()</span>
<span class="n">mytraj</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
<span class="c1"># get data handle to high-pass output and process into numpy</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">extract</span><span class="p">(),</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">my_filter</span><span class="o">.</span><span class="n">highpass</span><span class="p">]</span>

<span class="c1"># evaluate remaining tasks and finish</span>
<span class="n">context</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="idiomatic-context-management">
<h4>Idiomatic context management<a class="headerlink" href="#idiomatic-context-management" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">context</span><span class="p">,</span> <span class="n">gmx</span><span class="o">.</span><span class="n">DataFile</span><span class="p">(</span><span class="s1">&#39;saxs.xvg&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="c1"># API objects can create or discover the initialized context from the library</span>
    <span class="c1"># context must be initialized in the library in order to perform extract</span>
    <span class="c1"># instantiate trajectory file object</span>
    <span class="n">mytraj</span> <span class="o">=</span> <span class="n">TrajectoryFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="c1"># add filter to to tool chain</span>
    <span class="n">my_filter</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="n">mytraj</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>

    <span class="c1"># bind low-pass output to saxs modeling to tool chain</span>
    <span class="n">mysaxs</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Saxs</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="n">my_filter</span><span class="o">.</span><span class="n">lowpass</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mytraj</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mysaxs</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># get data handle to high-pass output and process into numpy</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">extract</span><span class="p">(),</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">mytraj</span><span class="p">]</span>
    <span class="c1"># Triggers evaluation and data retrieval</span>

    <span class="c1"># evaluate remaining tasks and finish by leaving the ``with`` block</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">extract</span><span class="p">(),</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">mytraj</span><span class="p">]</span>
<span class="n">catch</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">e</span><span class="o">.</span><span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;No data&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sea-level-scenario-simulate-counter-ion-effects-on-peptide-from-pdb">
<h3>Sea-level Scenario: Simulate counter-ion effects on peptide from PDB<a class="headerlink" href="#sea-level-scenario-simulate-counter-ion-effects-on-peptide-from-pdb" title="Permalink to this headline">¶</a></h3>
<p>Note:: To do: the following syntax is out of date.</p>
<p>Reimplement the CLI workflow described in the funnel web spider toxin
tutorial at
<a class="reference external" href="http://cinjweb.umdnj.edu/~kerrigje/pdf_files/fwspidr_tutor.pdf">http://cinjweb.umdnj.edu/~kerrigje/pdf_files/fwspidr_tutor.pdf</a></p>
<ol class="arabic simple">
<li>Prepare a configuration from PDB data</li>
<li>In vacuo energy minimization</li>
<li>Solvate</li>
<li>Add ions</li>
<li>Solvated energy minimization</li>
<li>Two-step equilibration</li>
</ol>
<p>Assumes</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gmx</span>
</pre></div>
</div>
<div class="section" id="prepare-a-configuration-from-pdb-data">
<h4>Prepare a configuration from PDB data<a class="headerlink" href="#prepare-a-configuration-from-pdb-data" title="Permalink to this headline">¶</a></h4>
<p>Read and clean pdb file.</p>
<p>Consume <code class="docutils literal"><span class="pre">fws.pdb</span></code> and produces <code class="docutils literal"><span class="pre">.gro</span></code> and <code class="docutils literal"><span class="pre">.top</span></code> files. e.g.
<code class="docutils literal"><span class="pre">pdb2gmx</span> <span class="pre">-ignh</span> <span class="pre">-ff</span> <span class="pre">amber99sb-ildn</span> <span class="pre">-f</span> <span class="pre">fws.pdb</span> <span class="pre">-o</span> <span class="pre">fws.gro</span> <span class="pre">-p</span> <span class="pre">fws.top</span> <span class="pre">-water</span> <span class="pre">tip3p</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Depending on how pdb2gmx is currently implemented...</span>
<span class="n">cleanpdb</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">clean_pdb</span><span class="p">(</span><span class="s1">&#39;fws.pdb&#39;</span><span class="p">,</span> <span class="n">ignore_hydrogens</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">topology</span><span class="p">)</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">pdb2gmx</span><span class="p">(</span><span class="n">cleanpdb</span><span class="p">,</span>
                        <span class="n">forcefield</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">amber99sb</span><span class="o">-</span><span class="n">ildn</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">topology</span><span class="p">)</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">pdb2gmx</span><span class="p">(</span><span class="s1">&#39;fws.pdb&#39;</span><span class="p">,</span>
                        <span class="n">forcefield</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">amber99sb</span><span class="o">-</span><span class="n">ildn</span><span class="p">,</span>
                        <span class="n">ignore_hydrogens</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Alternatively</span>
<span class="kn">import</span> <span class="nn">pypdb</span>
<span class="n">pdbfile</span> <span class="o">=</span> <span class="n">pypdb</span><span class="o">.</span><span class="n">get_pdb_file</span><span class="p">(</span><span class="s1">&#39;1OMB&#39;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s1">&#39;pdb&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># Then use other tools to &quot;clean&quot; the PDB record</span>
</pre></div>
</div>
<p>Build topology using force field and structure data</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># return a gmx.Topology object for atoms in pdbfile</span>
<span class="n">topology</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">TopologyBuilder</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">forcefields</span><span class="o">.</span><span class="n">amber99sb</span><span class="o">-</span><span class="n">ildn</span><span class="p">)</span><span class="o">.</span><span class="n">from_pdb</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">)</span>
<span class="c1"># then extend topology information with chosen water model</span>
<span class="n">topology</span><span class="o">.</span><span class="n">add_moleculetype</span><span class="p">(</span><span class="s1">&#39;SOL&#39;</span><span class="p">,</span> <span class="n">gmx</span><span class="o">.</span><span class="n">amber99sb</span><span class="o">-</span><span class="n">ildn</span><span class="o">.</span><span class="n">tip3p_flexible</span><span class="p">)</span>
</pre></div>
</div>
<p>Produce .gro and .top files
with a convenience function.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">gmx</span><span class="o">.</span><span class="n">AtomData</span><span class="o">.</span><span class="n">from_pdb</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;fws.gro&#39;</span><span class="p">)</span>
<span class="n">topology</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;fws.top&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Use utility to read and write files. Bottled workflow.</span>
<span class="n">gmx</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">pdb2gmx</span><span class="p">(</span><span class="n">force_field</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">amber99sb</span><span class="o">-</span><span class="n">ildn</span><span class="p">,</span>
                                <span class="n">pdb_file</span><span class="o">=</span><span class="s2">&quot;fws.pdb&quot;</span><span class="p">,</span>
                                <span class="n">coords_file</span><span class="o">=</span><span class="s2">&quot;fws.gro&quot;</span><span class="p">,</span>
                                <span class="n">topology_file</span><span class="o">=</span><span class="s2">&quot;fws.top&quot;</span><span class="p">,</span>
                                <span class="n">water</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">amber99sb</span><span class="o">-</span><span class="n">ildn</span><span class="o">.</span><span class="n">tip3p</span><span class="p">)</span>
</pre></div>
</div>
<p>Includes: Set up the box</p>
</div>
<div class="section" id="set-up-the-box">
<h4>Set up the box.<a class="headerlink" href="#set-up-the-box" title="Permalink to this headline">¶</a></h4>
<p>e.g. <code class="docutils literal"><span class="pre">editconf</span> <span class="pre">-f</span> <span class="pre">fws.gro</span> <span class="pre">-o</span> <span class="pre">fws-PBC.gro</span> <span class="pre">-bt</span> <span class="pre">dodecahedron</span> <span class="pre">-d</span> <span class="pre">1.2</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1">#Read the file into a Atom data object, intuiting the file type by extension</span>
<span class="n">grofile</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">AtomData</span><span class="p">(</span><span class="s1">&#39;fws.gro&#39;</span><span class="p">)</span>
<span class="c1"># Edit the atom data object</span>
<span class="n">grofile</span><span class="o">.</span><span class="n">set_box</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">SimulationBox</span><span class="p">(</span><span class="n">pbc</span><span class="o">=</span><span class="s1">&#39;dodecahedron&#39;</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">1.2</span><span class="p">))</span>
<span class="c1"># Write out file using the appropriate writer for the file extension</span>
<span class="n">grofile</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;fws-PBC.gro&#39;</span><span class="p">)</span>

<span class="c1"># or</span>

<span class="c1"># Edit the atom data object</span>
<span class="n">atoms</span><span class="o">.</span><span class="n">set_box</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">SimulationBox</span><span class="p">(</span><span class="n">pbc</span><span class="o">=</span><span class="s1">&#39;dodecahedron&#39;</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">1.2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="in-vacuo-energy-minimization">
<h4>In vacuo energy minimization<a class="headerlink" href="#in-vacuo-energy-minimization" title="Permalink to this headline">¶</a></h4>
<p>Prepare input record. e.g. <code class="docutils literal"><span class="pre">grompp</span> <span class="pre">-f</span> <span class="pre">em-vac-pme.mdp</span> <span class="pre">-c</span> <span class="pre">fws-PBC.gro</span> <span class="pre">-p</span> <span class="pre">fws.top</span> <span class="pre">-o</span> <span class="pre">em-vac.tpr</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># using convenience function for mdp file</span>
<span class="n">minimization</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">from_mdpfile</span><span class="p">(</span><span class="n">mdpfile</span><span class="o">=</span><span class="s1">&#39;em-vac-pmd.mdp&#39;</span><span class="p">,</span>
                                                <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">,</span>
                                                <span class="n">atoms</span><span class="o">=</span><span class="n">grofile</span><span class="p">,</span>
                                                <span class="p">)</span>
<span class="c1"># or</span>
<span class="n">minimization</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">from_mdpfile</span><span class="p">(</span><span class="n">mdpfile</span><span class="o">=</span><span class="s1">&#39;em-vac-pmd.mdp&#39;</span><span class="p">,</span>
                                                <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">,</span>
                                                <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span>
                                                <span class="p">)</span>
<span class="c1"># optionally</span>
<span class="c1"># save initialization file</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;em-vac.tpr&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>More granularly, we might use key-value parameters and access objects more directly.
periodic boundary conditions are already defined in the configuration box
no bond types are replaced by constraints, so we could ignore &#8220;constraints=none&#8221;.
If we were to replace bond types with constraints, is this really a
runtime parameter rather than a topology parameter? If so, the integrator
will have a reference to the constraint scheme and could configure it.</p>
<p>Implicitly created objects (e.g. the neighborlist and electrostatics)
have parameters that can be documented with the rest of the class,
so we should not use the matplotlib strategy of passing <code class="docutils literal"><span class="pre">**kwargs</span></code> along
such that it is hard to figure out what options are available and how they
are processed. If we want to provide convenience, we could bundle options
as dictionaries to be passed to, e.g., an nlist_params argument to the
integrator.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># With no arguments, use current gmx code to detect and allocate compute resources.</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="c1"># With default &#39;context=None&#39;, implicitly use gmx.Context()</span>
<span class="n">minimization</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">)</span>
<span class="n">minimizer</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">Steep</span><span class="p">(</span><span class="n">emtol</span><span class="o">=</span><span class="mf">500.</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">coulombtype</span><span class="o">=</span><span class="s1">&#39;PME&#39;</span><span class="p">,</span> <span class="n">nlist</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">)</span>

<span class="c1"># In practice, kwargs will likely come from parameters files.</span>
<span class="c1"># classes or module attibutes may have shorthand string names.</span>
<span class="n">minimization_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;emtol&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                       <span class="s1">&#39;nsteps&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>
<span class="n">integration_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;coulombtype&#39;</span><span class="p">:</span> <span class="s1">&#39;PME&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;constraints&#39;</span><span class="p">:</span> <span class="p">[],</span>
                      <span class="s1">&#39;nlist&#39;</span><span class="p">:</span> <span class="s1">&#39;grid&#39;</span><span class="p">}</span>
<span class="n">nlist_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;rcut&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>

<span class="c1"># bind the Integrator.</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">integrator</span><span class="p">(</span><span class="n">minimizer</span><span class="p">)</span>
</pre></div>
</div>
<p>For implicit creation and binding, use the class
methods <code class="docutils literal"><span class="pre">gmx.System.from_*()</span></code>, which avoid overly-complicated System
constructor and can be extended to package common sets of parameters
and simple workflows. E.g. maybe <code class="docutils literal"><span class="pre">gmx.System.from_minimization()</span></code>
Maybe the <code class="docutils literal"><span class="pre">from_</span></code> is cumbersome.</p>
<p>Optionally, add loggers</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># optionally</span>
<span class="c1"># get an energy group of all atoms in the system</span>
<span class="n">egroup</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">minimization</span><span class="o">.</span><span class="n">all_atoms</span><span class="p">())</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">LogEnergy</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="n">egroup</span><span class="p">]))</span>
</pre></div>
</div>
<p>Run energy minimizer.
e.g. <code class="docutils literal"><span class="pre">mdrun</span> <span class="pre">-v</span> <span class="pre">-deffnm</span> <span class="pre">em-vac</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># optionally set output behavior</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">filename_base</span><span class="p">(</span><span class="s1">&#39;em-vac&#39;</span><span class="p">)</span>
<span class="c1"># Run with execution context implicitly configured</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h4>Solvate.<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>Fill the box with water. e.g.
<code class="docutils literal"><span class="pre">genbox</span> <span class="pre">-cp</span> <span class="pre">em-vac.gro</span> <span class="pre">-cs</span> <span class="pre">spc216.gro</span> <span class="pre">-p</span> <span class="pre">fws.top</span> <span class="pre">-o</span> <span class="pre">fws-b4ion.gro</span></code></p>
<p>After adding atoms, we will use the same integration method with the
same electrostatics, topology, and neighborlist parameters, but a few
simulation parameters change.</p>
<p>For user-friendliness, AtomData can use getattr(x, to_pdata) or
something to see if an automatic conversion is possible, or objects in the
gmx.solvent submodule could already be AtomData objects.
Similarly, the solute and solvent arguments in solvate() could try to cast
to AtomData objects.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">solvent</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">AtomData</span><span class="p">(</span><span class="s1">&#39;spc216.gro&#39;</span><span class="p">)</span> <span class="c1"># load solvent molecule coordinates</span>
<span class="n">grofile</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">AtomData</span><span class="p">(</span><span class="s1">&#39;em-vac.gro&#39;</span><span class="p">)</span> <span class="c1"># load energy-minimized configuration</span>
<span class="n">atoms</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">solvate</span><span class="p">(</span><span class="n">solute</span><span class="o">=</span><span class="n">grofile</span><span class="p">,</span>
                 <span class="n">solvent</span><span class="o">=</span><span class="n">solvent</span><span class="p">,</span>
                 <span class="n">topology</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">Topology</span><span class="p">(</span><span class="s1">&#39;fws.top&#39;</span><span class="p">))</span>

<span class="c1"># or maybe</span>
<span class="n">solvent</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">AtomData</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">spc216</span><span class="p">)</span>
<span class="c1"># and we are still holding the topology object, which was extended</span>
<span class="c1"># earlier with a solvent definition from gmx.amber99sb-ildn.tip3p_flexible</span>
<span class="n">atoms</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">solvate</span><span class="p">(</span><span class="n">solute</span><span class="o">=</span><span class="n">grofile</span><span class="p">,</span> <span class="n">solvent</span><span class="o">=</span><span class="n">solvent</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">)</span>

<span class="c1"># or (alternate use)</span>

<span class="n">atoms</span> <span class="o">=</span> <span class="n">minimization</span><span class="o">.</span><span class="n">atoms</span> <span class="c1"># load energy-minimized configuration</span>
<span class="n">atoms</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">solvate</span><span class="p">(</span><span class="n">configuration</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span>
                 <span class="n">solvent</span><span class="o">=</span><span class="n">solvent</span><span class="p">,</span>
                 <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">)</span>
<span class="c1"># Note that &#39;atoms&#39; now refers to a new object and will need to be reattached.</span>
<span class="n">system</span><span class="o">.</span><span class="n">load_configuration</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

<span class="c1"># or (implementation option)</span>

<span class="c1"># Use utility to solvate a loaded system</span>
<span class="n">atoms</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">solvate</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="n">minimization</span><span class="p">)</span>

<span class="c1"># Optionally save configuration to file</span>
<span class="n">atoms</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;fws-b4ion.gro&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that &#8216;atoms&#8217; now refers to a new object and will need to be reattached with
<code class="docutils literal"><span class="pre">system.load_configuration(atoms)</span></code>
This invalidates the neighborlist, domain decomposition, etc.
The validity of the topology (i.e. does it define the solvent?) could be
checked with the solvate command, but should definitely be checked whenever
load_configuration() is called. If done at the call, we impose a requirement
that topology must be updated before configuration, which seems reasonable.
Again, some refinement may still need to occur conceptually on the
encapsulation of structure data versus topology data in terms of configuration,
atom typing, molecule / residue type definitions, full system topology,
and miscellaneous metadata, such as the &#8220;names&#8221; and such used for file
I/O and/or due to differences in conventions for the contents of molecular
data files.</p>
</div>
<div class="section" id="add-ions-to-solvated-system">
<h4>Add ions to solvated system.<a class="headerlink" href="#add-ions-to-solvated-system" title="Permalink to this headline">¶</a></h4>
<p>e.g.
<code class="docutils literal"><span class="pre">grompp</span> <span class="pre">-f</span> <span class="pre">em-sol-pme.mdp</span> <span class="pre">-c</span> <span class="pre">fws-b4ion.gro</span> <span class="pre">-p</span> <span class="pre">fws.top</span> <span class="pre">-o</span> <span class="pre">ion.tpr</span></code></p>
<p>Presumably we need a tpr to get the PME and neighbor parameters from the mdp file?
Need to figure out what is really needed by genion. It may be that it is
more appropriate as an integrator, like Steep(). Maybe we need a different
term. Integrator is too specific, and so is MD. Simply Updater?</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">minimization</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">from_mdpfile</span><span class="p">(</span>
                                <span class="n">mdpfile</span><span class="o">=</span><span class="s1">&#39;em-sol-pmd.mdp&#39;</span><span class="p">,</span>
                                <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">,</span>
                                <span class="n">atoms</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">AtomData</span><span class="p">(</span><span class="s1">&#39;fws-b4ion.gro&#39;</span><span class="p">),</span>
                                <span class="p">)</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;ion.tpr&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use utility to insert ions. e.g. <code class="docutils literal"><span class="pre">genion</span> <span class="pre">-s</span> <span class="pre">ion.tpr</span> <span class="pre">-o</span> <span class="pre">fws-b4em.gro</span> <span class="pre">-neutral</span> <span class="pre">-conc</span> <span class="pre">0.15</span> <span class="pre">-p</span> <span class="pre">fws.top</span> <span class="pre">-g</span> <span class="pre">ion.log</span></code></p>
<p>Solvate, insert-molecule, and genion perform similar functions with different
algorithms and options.
This should probably be
reconsidered as something more abstract. I.e. an alchemy module or
add/change atom methods to invoke these algorithms with appropriate
parameters as arguments.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Should the utility be allowed to modify the input in place?</span>
<span class="c1"># e.g. gmx.util.genion(system=minimization)</span>
<span class="c1"># For early iterations, I think not...</span>
<span class="c1"># Create a new System from the input System</span>
<span class="n">minimization</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">genion</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="n">minimization</span><span class="p">,</span> <span class="n">conc</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">neutral</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># implementation alternative: return AtomData</span>

<span class="n">atoms</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">genion</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="n">minimization</span><span class="p">,</span> <span class="n">conc</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">neutral</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">load_configuration</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

<span class="c1"># or (implementation alternative) is genion sufficiently coupled</span>
<span class="c1"># to System objects to simply be a fancy construction helper?</span>

<span class="n">minimization</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">genion</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="n">minimization</span><span class="p">,</span> <span class="n">conc</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">neutral</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Alternatively...</span>

<span class="n">minimization</span><span class="o">.</span><span class="n">change_residues</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;solvate&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">change_residues</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;pack&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="c1"># genion</span>
<span class="c1"># mode=&#39;trans&#39; or mode=&#39;trans_rot&#39;</span>
<span class="c1"># for the two filling mechanims in insert-molecule</span>

<span class="n">minimization</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;fws-b4em.gro&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="minimize-energy-in-solvated-system">
<h4>Minimize energy in solvated system.<a class="headerlink" href="#minimize-energy-in-solvated-system" title="Permalink to this headline">¶</a></h4>
<p>e.g. <code class="docutils literal"><span class="pre">grompp</span> <span class="pre">-f</span> <span class="pre">em-sol-pme.mdp</span> <span class="pre">-c</span> <span class="pre">fws-b4em.gro</span> <span class="pre">-p</span> <span class="pre">fws.top</span> <span class="pre">-o</span> <span class="pre">em-sol.tpr</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Prep simulation</span>
<span class="n">minimization</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">from_mdpfile</span><span class="p">(</span>
                                <span class="n">mdpfile</span><span class="o">=</span><span class="s1">&#39;em-sol-pmd.mdp&#39;</span><span class="p">,</span>
                                <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">,</span>
                                <span class="n">atoms</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">AtomData</span><span class="p">(</span><span class="s1">&#39;fws-b4em.gro&#39;</span><span class="p">),</span>
                                <span class="p">)</span>

<span class="c1"># Optionally: suppress output configured in mdp file</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">minimization</span><span class="o">.</span><span class="n">reporters</span><span class="p">:</span>
    <span class="n">minimization</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c1"># or maybe `del r`</span>

<span class="c1"># Optionally, If we already have a handle to mimimizer, we can just reuse it.</span>
<span class="n">minimimizer</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">emtol</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
<span class="c1"># The minimizer will notice that its convergence is invalidated both by the</span>
<span class="c1"># new value of emtol and by the updated atoms. The new nsteps parameter</span>
<span class="c1"># is used the next time it tries to converge.</span>

<span class="c1"># mdrun -v -deffnm em-sol</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">filename_base</span><span class="p">(</span><span class="s1">&#39;em-sol&#39;</span><span class="p">)</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="c1"># generates trajectory and other configured output</span>
</pre></div>
</div>
</div>
<div class="section" id="two-step-equilibration">
<h4>Two step equilibration.<a class="headerlink" href="#two-step-equilibration" title="Permalink to this headline">¶</a></h4>
<p>Compare to</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ grompp -f nvt-pr-md.mdp -c em-sol.gro -p fws.top -o nvt-pr.tpr
$ mdrun -deffnm nvt-pr
$ grompp -f npt-pr-md.mdp -c em-sol.gro -p fws.top -o npt-pr.tpr
$ mdrun -deffnm npt-pr
</pre></div>
</div>
<p>Set up and run two System objects in sequence.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># grompp -f nvt-pr-md.mdp -c em-sol.gro -p fws.top -o nvt-pr.tpr</span>
<span class="c1"># mdrun -deffnm nvt-pr</span>
<span class="n">nvt</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">from_mdpfile</span><span class="p">(</span><span class="n">mdpfile</span><span class="o">=</span><span class="s1">&#39;nvt-pr-md.mdp&#39;</span><span class="p">,</span>
                             <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">,</span>
                             <span class="n">atoms</span><span class="o">=</span><span class="s1">&#39;em-sol.gro&#39;</span><span class="p">,</span>
                             <span class="n">fname_base</span><span class="o">=</span><span class="s1">&#39;nvt-pr&#39;</span><span class="p">)</span>
<span class="c1"># implementation option: allow other parameter value types</span>
<span class="n">nvt</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">from_mdpfile</span><span class="p">(</span><span class="n">mdpfile</span><span class="o">=</span><span class="s1">&#39;nvt-pr-md.mdp&#39;</span><span class="p">,</span>
                             <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">,</span>
                             <span class="n">atoms</span><span class="o">=</span><span class="n">minimization</span><span class="p">,</span>
                             <span class="n">fname_base</span><span class="o">=</span><span class="s1">&#39;nvt-pr&#39;</span><span class="p">)</span>
<span class="c1"># optionally save input record</span>
<span class="n">nvt</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;nvt-pr.tpr&#39;</span><span class="p">)</span>

<span class="n">nvt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># grompp -f npt-pr-md.mdp -c em-sol.gro -p fws.top -o npt-pr.tpr</span>
<span class="c1"># mdrun -deffnm npt-pr</span>
<span class="n">npt</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">from_mdpfile</span><span class="p">(</span><span class="n">mdpfile</span><span class="o">=</span><span class="s1">&#39;npt-pr-md.mdp&#39;</span><span class="p">,</span>
                             <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">,</span>
                             <span class="n">atoms</span><span class="o">=</span><span class="s1">&#39;em-sol.gro&#39;</span><span class="p">,</span>
                             <span class="n">fname_base</span><span class="o">=</span><span class="s1">&#39;npt-pr&#39;</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="n">npt</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">from_mdpfile</span><span class="p">(</span><span class="n">mdpfile</span><span class="o">=</span><span class="s1">&#39;npt-pr-md.mdp&#39;</span><span class="p">,</span>
                             <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">,</span>
                             <span class="n">atoms</span><span class="o">=</span><span class="n">nvt</span><span class="p">,</span>
                             <span class="n">fname_base</span><span class="o">=</span><span class="s1">&#39;npt-pr&#39;</span><span class="p">)</span>

<span class="n">npt</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;npt-pr.tpr&#39;</span><span class="p">)</span>
<span class="n">npt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="construct-topology-and-structure-objects">
<h3>Construct topology and structure objects<a class="headerlink" href="#construct-topology-and-structure-objects" title="Permalink to this headline">¶</a></h3>
<p>There remains a question of the relationships between the AtomData,
Topology (system topology), and Molecule (molecular topology) structures.
I think this will be sorted out in part through examination of current Gromacs
architecture and in part through user input and/or inspiration from popular
tools like MDTraj and MDAnalysis. The interface to these data structures may
or may not have much in common with the implementation, as there is a lot of
opportunity for relational data and lazy attributes.</p>
<p>Note that system topologies and structure data are likely to be generated at the
same time, but common use cases may involve substituting entire sets of coordinates
or system topologies (in part or in whole).</p>
<div class="section" id="from-pdb-and-force-field-definitions">
<h4>From pdb and force field definitions<a class="headerlink" href="#from-pdb-and-force-field-definitions" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
<div class="section" id="from-raw-data-and-force-field-definitions">
<h4>From raw data and force field definitions<a class="headerlink" href="#from-raw-data-and-force-field-definitions" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
<div class="section" id="from-a-currently-instantiated-simulation">
<h4>From a currently instantiated simulation<a class="headerlink" href="#from-a-currently-instantiated-simulation" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
<div class="section" id="from-generic-structure-and-force-field-information">
<h4>From generic structure and force field information<a class="headerlink" href="#from-generic-structure-and-force-field-information" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
<div class="section" id="from-bare-metal">
<h4>From bare metal?<a class="headerlink" href="#from-bare-metal" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
</div>
<div class="section" id="run-with-frozen-n-and-c-terminals">
<h3>Run with frozen N and C terminals<a class="headerlink" href="#run-with-frozen-n-and-c-terminals" title="Permalink to this headline">¶</a></h3>
<div class="section" id="make-index-for-residue-groups">
<h4>Make index for residue groups<a class="headerlink" href="#make-index-for-residue-groups" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
<div class="section" id="configure-simulation-with-frozen-terminals">
<h4>Configure simulation with frozen terminals<a class="headerlink" href="#configure-simulation-with-frozen-terminals" title="Permalink to this headline">¶</a></h4>
<p>e.g.</p>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">make_ndx</span> <span class="pre">–f</span> <span class="pre">clg_b4md.pdb</span> <span class="pre">–o</span> <span class="pre">clg_ter.ndx</span></code></div>
<div class="line">Prompted input: <code class="docutils literal"><span class="pre">r</span> <span class="pre">1-36</span> <span class="pre">&amp;</span> <span class="pre">a</span> <span class="pre">C</span> <span class="pre">N</span> <span class="pre">CA</span></code> for residue selection, get the new group number and rename for convenience: <code class="docutils literal"><span class="pre">name</span> <span class="pre">15</span> <span class="pre">Terminal</span></code>, then <code class="docutils literal"><span class="pre">v</span></code> to view and verify.</div>
<div class="line">Additional MDP entries:</div>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">energygrp_excl</span> <span class="pre">=</span> <span class="pre">Terminal</span> <span class="pre">Terminal</span> <span class="pre">Terminal</span> <span class="pre">SOL</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">freezegrps</span> <span class="pre">=</span> <span class="pre">Terminal</span></code></div>
<div class="line"><code class="docutils literal"><span class="pre">freezedim</span> <span class="pre">=</span> <span class="pre">Y</span> <span class="pre">Y</span> <span class="pre">Y</span></code></div>
</div>
<div class="line"><code class="docutils literal"><span class="pre">grompp</span> <span class="pre">–f</span> <span class="pre">md.mdp</span> <span class="pre">–c</span> <span class="pre">pr.gro</span> <span class="pre">–p</span> <span class="pre">clg.top</span> <span class="pre">–n</span> <span class="pre">clg_ter.ndx</span> <span class="pre">–o</span> <span class="pre">md.tpr</span></code></div>
</div>
</div>
<div class="section" id="run-simulation-with-index">
<h4>Run simulation with index<a class="headerlink" href="#run-simulation-with-index" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
</div>
<div class="section" id="trajectory-manipulation-tasks">
<h3>Trajectory Manipulation tasks<a class="headerlink" href="#trajectory-manipulation-tasks" title="Permalink to this headline">¶</a></h3>
<p>Extract a simulation frame
<code class="docutils literal"><span class="pre">trjconv</span> <span class="pre">-f</span> <span class="pre">traj.xtc</span> <span class="pre">-s</span> <span class="pre">file.tpr</span> <span class="pre">-o</span> <span class="pre">time_3000ps.pdb</span> <span class="pre">-dump</span> <span class="pre">3000</span></code></p>
<p>Access atom coordinates from the trajectory</p>
<div class="line-block">
<div class="line">1a. Create Trajectory object from file</div>
<div class="line">1b. Get handle to Trajectory or Frame object held by simulation</div>
<div class="line">1c. Use Trajectory object created via API</div>
<div class="line">2. Retrieve Frame</div>
</div>
<p>Re-center a molecule
<code class="docutils literal"><span class="pre">trjconv</span> <span class="pre">–f</span> <span class="pre">traj.xtc</span> <span class="pre">–o</span> <span class="pre">traj_center.xtc</span> <span class="pre">–s</span> <span class="pre">str_b4md.gro</span> <span class="pre">–pbc</span> <span class="pre">nojump</span> <span class="pre">-center</span></code></p>
<p>Make the dummy gro file for the g_covar analysis.
<code class="docutils literal"><span class="pre">trjconv</span> <span class="pre">–s</span> <span class="pre">../md.tpr</span> <span class="pre">–f</span> <span class="pre">dangle.trr</span> <span class="pre">–o</span> <span class="pre">resiz.gro</span> <span class="pre">–n</span> <span class="pre">covar.ndx</span> <span class="pre">–e</span> <span class="pre">0</span></code></p>
<p>Concatenate trajectories
<code class="docutils literal"><span class="pre">trjcat</span> <span class="pre">–f</span> <span class="pre">md1.xtc</span> <span class="pre">md2.xtc</span> <span class="pre">md3.xtc</span> <span class="pre">...</span> <span class="pre">(etc)</span> <span class="pre">–o</span> <span class="pre">mdall.xtc</span> <span class="pre">-settime</span></code></p>
</div>
</div>
<div class="section" id="tensorflow-analogy">
<h2>TensorFlow analogy<a class="headerlink" href="#tensorflow-analogy" title="Permalink to this headline">¶</a></h2>
<p>The following is a mind-expanding thought experiment, not a goal. Taken to an
exterme, data flow and execution abstraction as a thin layer on top of
TensorFlow might look like the following.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">coordinates</span><span class="p">,</span> <span class="n">topology</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">pdb2gmx</span><span class="p">(</span><span class="n">force_field</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">amber99sb</span><span class="o">-</span><span class="n">ildn</span><span class="p">,</span>
                                <span class="n">pdb_file</span><span class="o">=</span><span class="s2">&quot;fws.pdb&quot;</span><span class="p">,</span>
                                <span class="n">coords_file</span><span class="o">=</span><span class="s2">&quot;fws.gro&quot;</span><span class="p">,</span>
                                <span class="n">topology_file</span><span class="o">=</span><span class="s2">&quot;fws.top&quot;</span><span class="p">,</span>
                                <span class="n">water</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">watermodel</span><span class="o">.</span><span class="n">tip3p</span><span class="p">)</span>
<span class="c1"># Create timestep variable</span>
<span class="n">current_step</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Step</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Create particle positions variable</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">ParticleCoordinates</span><span class="p">()</span>
<span class="n">xyz</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="c1"># operation deferred until &quot;graph&quot; is evaluated</span>

<span class="c1"># Create velocities variable</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Velocities</span><span class="p">()</span>
<span class="n">v</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">ThermalVelocities</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">))</span>

<span class="c1"># Create a node to hold system state at a time step</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">SystemState</span><span class="p">()</span>

<span class="c1"># Create operation to invoke non-bonded force compute kernel</span>
<span class="n">nonbonded</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">ForceCompute</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">topology</span><span class="p">)</span>

<span class="c1"># Create operation to invoke constraints kernel</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Constraints</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">topology</span><span class="p">)</span>

<span class="c1"># Create operation to invoke electrostatics kernel</span>
<span class="n">pme</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Electrostatics</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>

<span class="c1"># Operation to sum forces for integrator</span>
<span class="n">forces</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">SumForces</span><span class="p">(</span><span class="n">nonbonded</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">pme</span><span class="p">)</span>

<span class="c1"># Operation to perform integration, updating data handles and state</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Integrate</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">forces</span><span class="p">)</span>

<span class="c1"># Operation to perform simulation loop to advance to a given time step</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">RunUpTo</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">current_step</span><span class="p">,</span> <span class="n">gmx</span><span class="o">.</span><span class="n">Step</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>

<span class="k">with</span> <span class="n">gmx</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">**</span><span class="n">runtime_params</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="c1"># Create an operation that updates to the next timestep</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">session</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Step: {}, electrostatic energy: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">session</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">current_step</span><span class="p">),</span>
                <span class="n">session</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">pme</span><span class="p">)</span><span class="o">.</span><span class="n">energy</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="bindings.html" class="btn btn-neutral float-right" title="Low-level Python API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../layers.html" class="btn btn-neutral" title="Implementation layers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, M. Eric Irrgang and Peter Kasson.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>