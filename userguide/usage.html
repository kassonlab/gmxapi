
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Using the Python package &#8212; GROMACS External Interfaces</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="gmxapi Python module reference" href="pythonreference.html" />
    <link rel="prev" title="Full installation instructions" href="install.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pythonreference.html" title="gmxapi Python module reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Full installation instructions"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">gmxapi</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="userguide.html" accesskey="U">Python User Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="using-the-python-package">
<h1>Using the Python package<a class="headerlink" href="#using-the-python-package" title="Permalink to this headline">¶</a></h1>
<p>After installing GROMACS, sourcing the “GMXRC” (see GROMACS docs), and installing
the gmxapi Python package (see <a class="reference internal" href="install.html"><span class="doc">Full installation instructions</span></a>), import the package in a Python
script or interactive interpreter. This documentation assumes a convenient alias
of <code class="docutils literal notranslate"><span class="pre">gmx</span></code> to refer to the <code class="docutils literal notranslate"><span class="pre">gmxapi</span></code> Python package.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gmxapi</span> <span class="k">as</span> <span class="nn">gmx</span>
</pre></div>
</div>
<p>For full documentation of the Python-level interface and API, use the <code class="docutils literal notranslate"><span class="pre">pydoc</span></code>
command line tool or the <a class="reference external" href="https://docs.python.org/3/library/functions.html#help" title="(in Python v3.8)"><code class="xref py py-func docutils literal notranslate"><span class="pre">help()</span></code></a> interactive Python function, or refer to
the <a class="reference internal" href="pythonreference.html"><span class="doc">gmxapi Python module reference</span></a>.</p>
<p>Any Python <em>exception</em> raised by gmxapi
should be descended from (and catchable as) <a class="reference internal" href="pythonreference.html#gmxapi.exceptions.Error" title="gmxapi.exceptions.Error"><code class="xref py py-class docutils literal notranslate"><span class="pre">gmxapi.exceptions.Error</span></code></a>.
Additional status messages can be acquired through the <a class="reference internal" href="#gmxapi-logging"><span class="std std-ref">Logging</span></a>
facility.
Unfortunately, some errors occurring in the GROMACS library are not yet
recoverable at the Python level, and much of the standard GROMACS terminal
output is not yet accessible through Python.
If you find a particularly problematic scenario, please file a GROMACS bug report.</p>
<p>During installation, the <em>gmxapi</em> Python package becomes tied to a specific
GROMACS installation.
If you would like to access multiple GROMACS installations
from Python, build and install <em>gmxapi</em> in separate
<a class="reference internal" href="install.html#gmxapi-venv"><span class="std std-ref">virtual environments</span></a>.</p>
<p>In some cases <em>gmxapi</em> still needs help finding infrastructure from the
GROMACS installation.
For instance, <a class="reference internal" href="pythonreference.html#gmxapi.commandline_operation" title="gmxapi.commandline_operation"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.commandline_operation()</span></code></a> is not a pure API utility,
but a wrapper for command line tools.
Make sure that the command line tools you intend to use are discoverable in
your <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PATH</span></code>, such as by “source”ing your <code class="file docutils literal notranslate"><span class="pre">GMXRC</span></code> before launching
a <em>gmxapi</em> script.</p>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>Get relevant GROMACS paths in Python environment.</p>
<p><a class="reference internal" href="pythonreference.html#gmxapi.commandline_operation" title="gmxapi.commandline_operation"><code class="xref py py-class docutils literal notranslate"><span class="pre">gmxapi.commandline_operation</span></code></a> relies on the environment <span class="target" id="index-1"></span><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PATH</span></code>
to locate executables, including the <strong class="command">gmx</strong> wrapper binary.
Relates to <a class="reference external" href="https://redmine.gromacs.org/issues/2961">#2961</a>.</p>
</div>
<div class="section" id="notes-on-parallelism-and-mpi">
<span id="parallelism"></span><h2>Notes on parallelism and MPI<a class="headerlink" href="#notes-on-parallelism-and-mpi" title="Permalink to this headline">¶</a></h2>
<p>When launching a <em>gmxapi</em> script in an MPI environment,
such as with <strong class="command">mpiexec</strong> or <strong class="command">srun</strong>,
you must help <em>gmxapi</em> detect the MPI environment by ensuring that <code class="xref py py-mod docutils literal notranslate"><span class="pre">mpi4py</span></code>
is loaded.
Refer to <a class="reference internal" href="install.html#mpi-requirements"><span class="std std-ref">MPI requirements</span></a> for more on installing <code class="xref py py-mod docutils literal notranslate"><span class="pre">mpi4py</span></code>.</p>
<p>Assuming you use <strong class="command">mpiexec</strong> to launch MPI jobs in your environment,
run a <em>gmxapi</em> script on two ranks with something like the following.
Note that it can be helpful to provide <strong class="command">mpiexec</strong> with the full path to
the intended Python interpreter since new process environments are being created.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mpiexec -n 2 `which python` -m mpi4py myscript.py
</pre></div>
</div>
<p><em>gmxapi</em> 0.1 has limited parallelism, but future versions will include seemless
acceleration as integration improves with the GROMACS library and computing
environment runtime resources.
Currently, <em>gmxapi</em> and the GROMACS library do not have an effective way to
share an MPI environment.
Therefore, if you intend to run more than one simulation at a time, in parallel,
in a <em>gmxapi</em> script, you should build GROMACS with <em>thread-MPI</em> instead of a
standard MPI library.
I.e. configure GROMACS with the CMake flag <code class="docutils literal notranslate"><span class="pre">-DGMX_THREAD_MPI=ON</span></code>.
Then, launch your <em>gmxapi</em> script with one MPI rank per node, and <em>gmxapi</em> will
assign each (non-MPI) simulation to its own node, while keeping the full MPI
environment available for use via <code class="xref py py-mod docutils literal notranslate"><span class="pre">mpi4py</span></code>.</p>
</div>
<div class="section" id="running-simple-simulations">
<h2>Running simple simulations<a class="headerlink" href="#running-simple-simulations" title="Permalink to this headline">¶</a></h2>
<p>Once the <code class="docutils literal notranslate"><span class="pre">gmxapi</span></code> package is installed, running simulations is easy with
<a class="reference internal" href="pythonreference.html#gmxapi.read_tpr" title="gmxapi.read_tpr"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.read_tpr()</span></code></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gmxapi</span> <span class="k">as</span> <span class="nn">gmx</span>
<span class="n">simulation_input</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">read_tpr</span><span class="p">(</span><span class="n">tpr_filename</span><span class="p">)</span>
<span class="n">md</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">mdrun</span><span class="p">(</span><span class="n">simulation_input</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that this sets up the work you want to perform, but does not immediately
trigger execution. You can explicitly trigger execution with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">md</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>or you can let gmxapi automatically launch work in response to the data you
request.</p>
<p>The <a class="reference internal" href="pythonreference.html#gmxapi.mdrun" title="gmxapi.mdrun"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.mdrun()</span></code></a> operation produces a simulation trajectory output.
You can use <code class="docutils literal notranslate"><span class="pre">md.output.trajectory</span></code> as input to other operations,
or you can get the output directly by calling <code class="docutils literal notranslate"><span class="pre">md.output.trajectory.result()</span></code>.
If the simulation has not been run yet when <code class="docutils literal notranslate"><span class="pre">result()</span></code> is called,
the simulation will be run before the function returns.</p>
</div>
<div class="section" id="running-ensemble-simulations">
<h2>Running ensemble simulations<a class="headerlink" href="#running-ensemble-simulations" title="Permalink to this headline">¶</a></h2>
<p>To run a batch of simulations, just pass an array of inputs.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">md</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">read_tpr</span><span class="p">([</span><span class="n">tpr_filename1</span><span class="p">,</span> <span class="n">tpr_filename2</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
<span class="n">md</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Make sure to launch the script in an MPI environment with a sufficient number
of ranks to allow one rank per simulation.</p>
<p>For <em>gmxapi</em> 0.1, we recommend configuring the GROMACS build with
<code class="docutils literal notranslate"><span class="pre">GMX_THREAD_MPI=ON</span></code> and allowing one rank per node in order to allow each
simulation ensemble member to run on a separate node.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#parallelism"><span class="std std-ref">Notes on parallelism and MPI</span></a></p>
</div>
</div>
<div class="section" id="accessing-command-line-tools">
<span id="commandline"></span><h2>Accessing command line tools<a class="headerlink" href="#accessing-command-line-tools" title="Permalink to this headline">¶</a></h2>
<p>In <em>gmxapi</em> 0.1, most GROMACS tools are not yet exposed as <em>gmxapi</em> Python operations.
<a class="reference internal" href="pythonreference.html#gmxapi.commandline_operation" title="gmxapi.commandline_operation"><code class="xref py py-class docutils literal notranslate"><span class="pre">gmxapi.commandline_operation</span></code></a> provides a way to convert a <strong class="command">gmx</strong>
(or other) command line tool into an operation that can be used in a <em>gmxapi</em>
script.</p>
<p>In order to establish data dependencies, input and output files need to be
indicated with the <code class="docutils literal notranslate"><span class="pre">input_files</span></code> and <code class="docutils literal notranslate"><span class="pre">output_files</span></code> parameters.
<code class="docutils literal notranslate"><span class="pre">input_files</span></code> and <code class="docutils literal notranslate"><span class="pre">output_files</span></code> key word arguments are dictionaries
consisting of files keyed by command line flags.</p>
<p>For example, you might create a <strong class="command">gmx solvate</strong> operation as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">solvate</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">commandline_operation</span><span class="p">(</span><span class="s1">&#39;gmx&#39;</span><span class="p">,</span>
                                    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;solvate&#39;</span><span class="p">,</span> <span class="s1">&#39;-box&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">],</span>
                                    <span class="n">input_files</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;-cs&#39;</span><span class="p">:</span> <span class="n">structurefile</span><span class="p">},</span>
                                    <span class="n">output_files</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;-p&#39;</span><span class="p">:</span> <span class="n">topfile</span><span class="p">,</span>
                                                  <span class="s1">&#39;-o&#39;</span><span class="p">:</span> <span class="n">structurefile</span><span class="p">,</span>
                                                  <span class="p">}</span>
</pre></div>
</div>
<p>To check the status or error output of a command line operation, refer to the
<code class="docutils literal notranslate"><span class="pre">returncode</span></code> and <code class="docutils literal notranslate"><span class="pre">erroroutput</span></code> outputs.
To access the results from the output file arguments, use the command line flags
as keys in the <code class="docutils literal notranslate"><span class="pre">file</span></code> dictionary output.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">structurefile</span> <span class="o">=</span> <span class="n">solvate</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="s1">&#39;-o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="k">if</span> <span class="n">solvate</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">returncode</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">solvate</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">erroroutput</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="preparing-simulations">
<h2>Preparing simulations<a class="headerlink" href="#preparing-simulations" title="Permalink to this headline">¶</a></h2>
<p>Continuing the previous example, the output of <code class="docutils literal notranslate"><span class="pre">solvate</span></code> may be used as the
input for <code class="docutils literal notranslate"><span class="pre">grompp</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grompp</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">commandline_operation</span><span class="p">(</span><span class="s1">&#39;gmx&#39;</span><span class="p">,</span> <span class="s1">&#39;grompp&#39;</span><span class="p">,</span>
                                   <span class="n">input_files</span><span class="o">=</span><span class="p">{</span>
                                       <span class="s1">&#39;-f&#39;</span><span class="p">:</span> <span class="n">mdpfile</span><span class="p">,</span>
                                       <span class="s1">&#39;-p&#39;</span><span class="p">:</span> <span class="n">solvate</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="s1">&#39;-p&#39;</span><span class="p">],</span>
                                       <span class="s1">&#39;-c&#39;</span><span class="p">:</span> <span class="n">solvate</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="s1">&#39;-o&#39;</span><span class="p">],</span>
                                       <span class="s1">&#39;-po&#39;</span><span class="p">:</span> <span class="n">mdout_mdp</span><span class="p">,</span>
                                   <span class="p">},</span>
                                   <span class="n">output_files</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;-o&#39;</span><span class="p">:</span> <span class="n">tprfile</span><span class="p">})</span>
</pre></div>
</div>
<p>Then, <code class="docutils literal notranslate"><span class="pre">grompp.output.file['-o']</span></code> can be used as the input for <a class="reference internal" href="pythonreference.html#gmxapi.read_tpr" title="gmxapi.read_tpr"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.read_tpr()</span></code></a>.</p>
<p>Simulation input can be modified with the <a class="reference internal" href="pythonreference.html#gmxapi.modify_input" title="gmxapi.modify_input"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.modify_input()</span></code></a> operation
before being passed to <a class="reference internal" href="pythonreference.html#gmxapi.mdrun" title="gmxapi.mdrun"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.mdrun()</span></code></a>.
For <em>gmxapi</em> 0.1, a subset of MDP parameters may be overridden using the
dictionary passed with the <code class="docutils literal notranslate"><span class="pre">parameters</span></code> key word argument.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">simulation_input</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">read_tpr</span><span class="p">(</span><span class="n">grompp</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="s1">&#39;-o&#39;</span><span class="p">])</span>
<span class="n">modified_input</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">modify_input</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">simulation_input</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nsteps&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})</span>
<span class="n">md</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">mdrun</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">modified_input</span><span class="p">)</span>
<span class="n">md</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="using-arbitrary-python-functions">
<h2>Using arbitrary Python functions<a class="headerlink" href="#using-arbitrary-python-functions" title="Permalink to this headline">¶</a></h2>
<p>Generally, a function in the <em>gmxapi</em> package returns an object that references
a node in a work graph,
representing an operation that will be run when the graph executes.
The object has an <code class="docutils literal notranslate"><span class="pre">output</span></code> attribute providing access to data Futures that
can be provided as inputs to other operations before computation has actually
been performed.</p>
<p>You can also provide native Python data as input to operations,
or you can operate on native results retrieved from a Future’s <code class="docutils literal notranslate"><span class="pre">result()</span></code>
method.
However, it is trivial to convert most Python functions into <em>gmxapi</em> compatible
operations with <a class="reference internal" href="pythonreference.html#gmxapi.function_wrapper" title="gmxapi.function_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.function_wrapper()</span></code></a>.
All function inputs and outputs must have a name and type.
Additionally, functions should be stateless and importable
(e.g. via Python <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">some.module</span> <span class="pre">import</span> <span class="pre">myfunction</span></code>)
for future compatibility.</p>
<p>Simple functions can just use <code class="xref py py-func docutils literal notranslate"><span class="pre">return()</span></code> to publish their output,
as long as they are defined with a return value type annotation.
Functions with multiple outputs can accept an <code class="docutils literal notranslate"><span class="pre">output</span></code> key word argument and
assign values to named attributes on the received argument.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gmxapi</span> <span class="kn">import</span> <span class="n">function_wrapper</span>

<span class="nd">@function_wrapper</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">add_float</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>


<span class="nd">@function_wrapper</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">less_than</span><span class="p">(</span><span class="n">lhs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">output</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">lhs</span> <span class="o">&lt;</span> <span class="n">rhs</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For more on Python type hinting with function annotations,
check out <span class="target" id="index-2"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-3107"><strong>PEP 3107</strong></a>.</p>
</div>
</div>
<div class="section" id="subgraphs">
<h2>Subgraphs<a class="headerlink" href="#subgraphs" title="Permalink to this headline">¶</a></h2>
<p>Basic <em>gmxapi</em> work consists of a flow of data from operation outputs to
operation inputs, forming a directed acyclic graph (DAG).
In many cases, it can be useful to repeat execution of a subgraph with updated
inputs.
You may want a data reference that is not tied to the immutable result
of a single node in the work graph, but which instead refers to the most recent
result of a repeated operation.</p>
<p>One or more operations can be staged in a <code class="xref py py-class docutils literal notranslate"><span class="pre">gmxapi.operation.Subgraph</span></code>,
a sort of meta-operation factory that can store input binding behavior so that
instances can be created without providing input arguments.</p>
<p>The subgraph <em>variables</em> serve as input, output, and mutable internal data
references which can be updated by operations in the subgraph.
Variables also allow state to be propagated between iterations when a subgraph
is used in a <em>while</em> loop.</p>
<p>Use <a class="reference internal" href="pythonreference.html#gmxapi.subgraph" title="gmxapi.subgraph"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.subgraph()</span></code></a> to create a new empty subgraph.
The <code class="docutils literal notranslate"><span class="pre">variables</span></code> argument declares data handles that define the state of the
subgraph when it is run.
To initialize input to the subgraph, give each variable a name and a value.</p>
<p>To populate a subgraph, enter a SubgraphContext by using a <code class="xref py py-func docutils literal notranslate"><span class="pre">with()</span></code> statement.
Operations created in the <em>with</em> block will be captued by the SubgraphContext.
Define the subgraph outputs by assigning operation outputs to subgraph variables
within the <em>with</em> block.</p>
<p>After exiting the <em>with</em> block, the subgraph may be used to create operation
instances or may be executed repeatedly in a <em>while</em> loop.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The object returned by <a class="reference internal" href="pythonreference.html#gmxapi.subgraph" title="gmxapi.subgraph"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.subgraph()</span></code></a> is atypical of <em>gmxapi</em>
operations, and has some special behaviors. When used as a Python
<a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#context-managers">context manager</a>,
it enters a “builder” state that changes the behavior of its attribute
variables and of operaton instantiation. After exiting the <code class="xref py py-func docutils literal notranslate"><span class="pre">with()</span></code>
block, the subgraph variables are no longer assignable, and operation
references obtained within the block are no longer valid.</p>
</div>
</div>
<div class="section" id="looping">
<h2>Looping<a class="headerlink" href="#looping" title="Permalink to this headline">¶</a></h2>
<p>An operation can be executed an arbitrary number of times with a
<a class="reference internal" href="pythonreference.html#gmxapi.while_loop" title="gmxapi.while_loop"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.while_loop()</span></code></a> by providing a factory function as the
<em>operation</em> argument.
When the loop operation is run, the <em>operation</em> is instantiated and run repeatedly
until <em>condition</em> evaluates <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p><a class="reference internal" href="pythonreference.html#gmxapi.while_loop" title="gmxapi.while_loop"><code class="xref py py-func docutils literal notranslate"><span class="pre">gmxapi.while_loop()</span></code></a> does not provide a direct way to provide <em>operation</em>
arguments. Use a <em>subgraph</em> to define the data flow for iterative operations.</p>
<p>When a <em>condition</em> is a subgraph variable, the variable is evaluated in the
running subgraph instance at the beginning of an iteration.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subgraph</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">variables</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;float_with_default&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;bool_data&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="k">with</span> <span class="n">subgraph</span><span class="p">:</span>
    <span class="c1"># Define the update for float_with_default to come from an add_float operation.</span>
    <span class="n">subgraph</span><span class="o">.</span><span class="n">float_with_default</span> <span class="o">=</span> <span class="n">add_float</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">float_with_default</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">data</span>
    <span class="n">subgraph</span><span class="o">.</span><span class="n">bool_data</span> <span class="o">=</span> <span class="n">less_than</span><span class="p">(</span><span class="n">lhs</span><span class="o">=</span><span class="n">subgraph</span><span class="o">.</span><span class="n">float_with_default</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="mf">6.</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">data</span>
<span class="n">operation_instance</span> <span class="o">=</span> <span class="n">subgraph</span><span class="p">()</span>
<span class="n">operation_instance</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;float_with_default&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">2.</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="n">subgraph</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">subgraph</span><span class="o">.</span><span class="n">bool_data</span><span class="p">)</span>
<span class="n">handle</span> <span class="o">=</span> <span class="n">loop</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">handle</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">float_with_default</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="o">==</span> <span class="mi">6</span>
</pre></div>
</div>
</div>
<div class="section" id="logging">
<span id="gmxapi-logging"></span><h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p><em>gmxapi</em> uses the Python <a class="reference external" href="https://docs.python.org/3/library/logging.html#module-logging" title="(in Python v3.8)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">logging</span></code></a> module to provide hierarchical
logging, organized by submodule.
You can access the logger at <code class="docutils literal notranslate"><span class="pre">gmxapi.logger</span></code> or, after importing <em>gmxapi</em>,
through the Python logging framework:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gmxapi</span> <span class="k">as</span> <span class="nn">gmx</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="c1"># Get the root gmxapi logger.</span>
<span class="n">gmx_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;gmxapi&#39;</span><span class="p">)</span>
<span class="c1"># Set a low default logging level</span>
<span class="n">gmx_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
<span class="c1"># Make some tools very verbose</span>
<span class="c1">#  by descending the hierarchy</span>
<span class="n">gmx_logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;commandline&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="c1">#  or by direct reference</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;gmxapi.mdrun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</pre></div>
</div>
<p>You may prefer to adjust the log format or manipulate the log handlers.
For example, tag the log output with MPI rank:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
    <span class="n">rank_number</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">rank_number</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rank_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">MPI</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">rank_tag</span> <span class="o">=</span> <span class="s1">&#39;rank</span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rank_number</span><span class="p">)</span>

<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">rank_tag</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">:</span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># For additional console logging, create and attach a stream handler.</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</pre></div>
</div>
<p>For more information, refer to the Python <a class="reference external" href="https://docs.python.org/3/library/logging.html">logging documentation</a>.</p>
</div>
<div class="section" id="more">
<h2>More<a class="headerlink" href="#more" title="Permalink to this headline">¶</a></h2>
<p>Refer to the <a class="reference internal" href="pythonreference.html"><span class="doc">gmxapi Python module reference</span></a> for complete and granular documentation.</p>
<p>For more information on writing or using pluggable simulation extension code,
refer to <a class="reference external" href="https://redmine.gromacs.org/issues/3133">https://redmine.gromacs.org/issues/3133</a>.
(For gmxapi 0.0.7 and GROMACS 2019, see <a class="reference external" href="https://github.com/kassonlab/sample_restraint">https://github.com/kassonlab/sample_restraint</a>)</p>
<div class="admonition-todo admonition" id="id4">
<p class="admonition-title">Todo</p>
<p><a href="#id2"><span class="problematic" id="id3">:issue:`3133`</span></a>: Replace these links as resources for pluggable extension code become available.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Using the Python package</a><ul>
<li><a class="reference internal" href="#notes-on-parallelism-and-mpi">Notes on parallelism and MPI</a></li>
<li><a class="reference internal" href="#running-simple-simulations">Running simple simulations</a></li>
<li><a class="reference internal" href="#running-ensemble-simulations">Running ensemble simulations</a></li>
<li><a class="reference internal" href="#accessing-command-line-tools">Accessing command line tools</a></li>
<li><a class="reference internal" href="#preparing-simulations">Preparing simulations</a></li>
<li><a class="reference internal" href="#using-arbitrary-python-functions">Using arbitrary Python functions</a></li>
<li><a class="reference internal" href="#subgraphs">Subgraphs</a></li>
<li><a class="reference internal" href="#looping">Looping</a></li>
<li><a class="reference internal" href="#logging">Logging</a></li>
<li><a class="reference internal" href="#more">More</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="install.html"
                        title="previous chapter">Full installation instructions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="pythonreference.html"
                        title="next chapter">gmxapi Python module reference</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/userguide/usage.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pythonreference.html" title="gmxapi Python module reference"
             >next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Full installation instructions"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">gmxapi</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="userguide.html" >Python User Guide</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, M. Eric Irrgang and Peter Kasson; 2019, GROMACS development team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.2.
    </div>
  </body>
</html>