
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>gmxapi.operation &#8212; GROMACS External Interfaces</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">gmxapi</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gmxapi.operation</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># This file is part of the GROMACS molecular simulation package.</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2019, by the GROMACS development team, led by</span>
<span class="c1"># Mark Abraham, David van der Spoel, Berk Hess, and Erik Lindahl,</span>
<span class="c1"># and including many others, as listed in the AUTHORS file in the</span>
<span class="c1"># top-level source directory and at http://www.gromacs.org.</span>
<span class="c1">#</span>
<span class="c1"># GROMACS is free software; you can redistribute it and/or</span>
<span class="c1"># modify it under the terms of the GNU Lesser General Public License</span>
<span class="c1"># as published by the Free Software Foundation; either version 2.1</span>
<span class="c1"># of the License, or (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># GROMACS is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="c1"># Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public</span>
<span class="c1"># License along with GROMACS; if not, see</span>
<span class="c1"># http://www.gnu.org/licenses, or write to the Free Software Foundation,</span>
<span class="c1"># Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA.</span>
<span class="c1">#</span>
<span class="c1"># If you want to redistribute modifications to GROMACS, please</span>
<span class="c1"># consider that scientific software is very special. Version</span>
<span class="c1"># control is crucial - bugs must be traceable. We will be happy to</span>
<span class="c1"># consider code for inclusion in the official distribution, but</span>
<span class="c1"># derived work must not be called official GROMACS. Details are found</span>
<span class="c1"># in the README &amp; COPYING files - if they are missing, get the</span>
<span class="c1"># official version at http://www.gromacs.org.</span>
<span class="c1">#</span>
<span class="c1"># To help us fund GROMACS development, we humbly ask that you cite</span>
<span class="c1"># the research papers on the package. Check out http://www.gromacs.org.</span>

<span class="sd">&quot;&quot;&quot;Define gmxapi-compliant Operations</span>

<span class="sd">Provide decorators and base classes to generate and validate gmxapi Operations.</span>

<span class="sd">Nodes in a work graph are created as instances of Operations. An Operation factory</span>
<span class="sd">accepts well-defined inputs as key word arguments. The object returned by such</span>
<span class="sd">a factory is a handle to the node in the work graph. It&#39;s ``output`` attribute</span>
<span class="sd">is a collection of the Operation&#39;s results.</span>

<span class="sd">function_wrapper(...) produces a wrapper that converts a function to an Operation</span>
<span class="sd">factory. The Operation is defined when the wrapper is called. The Operation is</span>
<span class="sd">instantiated when the factory is called. The function is executed when the Operation</span>
<span class="sd">instance is run.</span>

<span class="sd">The framework ensures that an Operation instance is executed no more than once.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;computed_result&#39;</span><span class="p">,</span>
           <span class="s1">&#39;function_wrapper&#39;</span><span class="p">,</span>
           <span class="p">]</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>

<span class="kn">import</span> <span class="nn">gmxapi</span> <span class="k">as</span> <span class="nn">gmx</span>
<span class="kn">from</span> <span class="nn">gmxapi</span> <span class="k">import</span> <span class="n">datamodel</span>
<span class="kn">from</span> <span class="nn">gmxapi</span> <span class="k">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">gmxapi</span> <span class="k">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">root_logger</span>
<span class="kn">from</span> <span class="nn">gmxapi.abc</span> <span class="k">import</span> <span class="n">OperationImplementation</span><span class="p">,</span> <span class="n">MutableResource</span><span class="p">,</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">gmxapi.typing</span> <span class="k">import</span> <span class="n">_Context</span><span class="p">,</span> <span class="n">ResultTypeVar</span><span class="p">,</span> <span class="n">SourceTypeVar</span><span class="p">,</span> <span class="n">valid_result_types</span><span class="p">,</span> <span class="n">valid_source_types</span>
<span class="kn">from</span> <span class="nn">gmxapi.typing</span> <span class="k">import</span> <span class="n">Future</span> <span class="k">as</span> <span class="n">_Future</span>

<span class="c1"># Initialize module-level logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">root_logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;operation&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Importing </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">ResultDescription</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Describe what will be returned when `result()` is called.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">valid_result_types</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_width</span> <span class="o">=</span> <span class="n">width</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;node output type&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;ensemble width&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_width</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(dtype=</span><span class="si">{}</span><span class="s1">, width=</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">OutputData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encapsulate the description and storage of a data output.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">ResultDescription</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">ResultDescription</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="o">.</span><span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="o">.</span><span class="n">width</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The name of the published output.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="c1"># TODO: Change to regular member function and add ensemble member arg.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensemble completion status for this output.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">member</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access the raw data for localized output for the ensemble or the specified member.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Attempt to read before data has been published.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Data marked &quot;done&quot; but contains null value.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">member</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">member</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">member</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set local data and mark as completed.</span>

<span class="sd">        Used internally to maintain the data store.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">member</span><span class="p">]</span> <span class="o">=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">member</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">[</span><span class="n">member</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reinitialize the data store.</span>

<span class="sd">        Note:</span>
<span class="sd">            This is a workaround until the execution model is more developed.</span>

<span class="sd">        Todo:</span>
<span class="sd">            Remove this method when all operation handles provide factories to</span>
<span class="sd">            reinstantiate on new Contexts and/or with new inputs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="o">.</span><span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="o">.</span><span class="n">width</span>


<span class="k">class</span> <span class="nc">EnsembleDataSource</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">EnsembleDataSource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A single source of data with ensemble data flow annotations.</span>

<span class="sd">    Note that data sources may be Futures.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>

    <span class="k">def</span> <span class="nf">node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">member</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="n">member</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">protocols</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="s1">&#39;_reset&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)()</span>


<span class="k">class</span> <span class="nc">DataSourceCollection</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store and describe input data handles for an operation.</span>

<span class="sd">    When created from InputCollectionDescription.bind(), the DataSourceCollection</span>
<span class="sd">    has had default values inserted.</span>

<span class="sd">    Note: DataSourceCollection is the input resource collection type for NodeBuilder.</span>
<span class="sd">    To use with the NodeBuilder interface, first create the collection, then</span>
<span class="sd">    iteratively add its resources.</span>

<span class="sd">    TODO: We should probably normalize the collection aspect of input. Is this a</span>
<span class="sd">          single input? Are all inputs added as collections? Should this be split</span>
<span class="sd">          to a standard iterable? Does a resource factory always produce a mapping?</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize from key/value pairs of named data sources.</span>

<span class="sd">        Data sources may be any of the basic gmxapi data types, gmxapi Futures</span>
<span class="sd">        of those types, or gmxapi ensemble data bundles of the above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataSourceCollection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">SourceTypeVar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TypeError</span><span class="p">(</span><span class="s1">&#39;Data must be named with str type.&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: Encapsulate handling of proferred data sources to Context details.</span>
        <span class="c1"># Preprocessed input should be self-describing gmxapi data types. Structured</span>
        <span class="c1"># input must be recursively (depth-first) converted to gmxapi data types.</span>
        <span class="c1"># TODO: Handle gmxapi Futures stored as dictionary elements!</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">valid_source_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
                <span class="c1"># Iterables here are treated as arrays, but we do not have a robust typing system.</span>
                <span class="c1"># Warning: In the initial implementation, the iterable may contain Future objects.</span>
                <span class="c1"># TODO: (#2993) Revisit as we sort out data shape and Future protocol.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TypeError</span><span class="p">(</span><span class="s1">&#39;Iterable could not be converted to NDArray: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">):</span>
                <span class="c1"># A Future object.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Cannot process data source </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset all sources in the collection.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;reset&#39;</span><span class="p">):</span>
                <span class="n">source</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;_reset&#39;</span><span class="p">):</span>
                <span class="n">source</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide some sort of unique identifier.</span>

<span class="sd">        We need a more deterministic fingerprinting scheme with well-specified</span>
<span class="sd">        uniqueness semantics, but right now we just need something reasonably</span>
<span class="sd">        unique.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hashed_keys_and_values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">hashed_keys_and_values</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">computed_result</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorate a function to get a helper that produces an object with Result behavior.</span>

<span class="sd">    When called, the new function produces an ImmediateResult object.</span>

<span class="sd">    The new function has the same signature as the original function, but can accept</span>
<span class="sd">    gmxapi data proxies, assuming the provided proxy objects represent types</span>
<span class="sd">    compatible with the original signature.</span>

<span class="sd">    Calls to `result()` return the value that `function` would return when executed</span>
<span class="sd">    in the local context with the inputs fully resolved.</span>

<span class="sd">    The API does not specify when input data dependencies will be resolved</span>
<span class="sd">    or when the wrapped function will be executed. That is, ``@computed_result``</span>
<span class="sd">    functions may force immediate resolution of data dependencies and/or may</span>
<span class="sd">    be called more than once to satisfy dependent operation inputs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Attempt to inspect function signature. Introspection can fail, so we catch</span>
    <span class="c1"># the various exceptions. We re-raise as ApiError, indicating a bug, because</span>
    <span class="c1"># we should do more to handle this intelligently and provide better user</span>
    <span class="c1"># feedback.</span>
    <span class="c1"># TODO: Figure out what to do with exceptions where this introspection</span>
    <span class="c1">#  and rebinding won&#39;t work.</span>
    <span class="c1"># ref: https://docs.python.org/3/library/inspect.html#introspecting-callables-with-the-signature-object</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Can not inspect type of provided function argument.&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">T</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">V</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Can not inspect provided function signature.&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">V</span>

    <span class="n">wrapped_function</span> <span class="o">=</span> <span class="n">function_wrapper</span><span class="p">()(</span><span class="n">function</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">new_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># The signature of the new function will accept abstractions</span>
        <span class="c1"># of whatever types it originally accepted. This wrapper must</span>
        <span class="c1"># * Create a mapping to the original call signature from `input`</span>
        <span class="c1"># * Add handling for typed abstractions in wrapper function.</span>
        <span class="c1"># * Process arguments to the wrapper function into `input`</span>

        <span class="c1"># 1. Inspect the return annotation to determine valid gmxapi type(s)</span>
        <span class="c1"># 2. Generate a Result object advertising the correct type, bound to the</span>
        <span class="c1">#    Input and implementing function.</span>
        <span class="c1"># 3. Transform the result() data to the correct type.</span>

        <span class="c1"># TODO: (FR3+) create a serializable data structure for inputs discovered</span>
        <span class="c1">#  from function introspection.</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span>
        <span class="n">bound_arguments</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">wrapped_function</span><span class="p">(</span><span class="o">**</span><span class="n">bound_arguments</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">output</span>
        <span class="c1"># TODO: Find a type hinting / generic way to assert output attributes.</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">data</span>

    <span class="k">return</span> <span class="n">new_function</span>


<span class="k">class</span> <span class="nc">OutputCollectionDescription</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the output description for an operation node from a dictionary of names and types.&quot;&quot;&quot;</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">flavor</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TypeError</span><span class="p">(</span><span class="s1">&#39;Output descriptions are keyed by Python strings.&#39;</span><span class="p">)</span>
            <span class="c1"># Multidimensional outputs are explicitly NDArray</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">flavor</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">flavor</span> <span class="o">=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span>
            <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">flavor</span><span class="p">,</span> <span class="n">valid_result_types</span><span class="p">)</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">flavor</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">InputCollectionDescription</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describe acceptable inputs for an Operation.</span>

<span class="sd">    Generally, an InputCollectionDescription is an aspect of the public API by</span>
<span class="sd">    which an Operation expresses its possible inputs. This class includes details</span>
<span class="sd">    of the Python package.</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        parameters : A sequence of named parameter descriptions.</span>

<span class="sd">    Parameter descriptions are objects containing an `annotation` attribute</span>
<span class="sd">    declaring the data type of the parameter and, optionally, a `default`</span>
<span class="sd">    attribute declaring a default value for the parameter.</span>

<span class="sd">    Instances can be used as an ordered map of parameter names to gmxapi data types.</span>

<span class="sd">    Analogous to inspect.Signature, but generalized for gmxapi Operations.</span>
<span class="sd">    Additional notable differences: typing is normalized at initialization, and</span>
<span class="sd">    the bind() method does not return an object that can be directly used as</span>
<span class="sd">    function input. The object returned from bind() is used to construct a data</span>
<span class="sd">    graph Edge for subsequent execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="p">]]):</span>
        <span class="sd">&quot;&quot;&quot;Create the input description for an operation node from a dictionary of names and types.&quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TypeError</span><span class="p">(</span><span class="s1">&#39;Input descriptions are keyed by Python strings.&#39;</span><span class="p">)</span>
            <span class="c1"># Multidimensional inputs are explicitly NDArray</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">)):</span>
                <span class="c1"># TODO: we can relax this with some more input conditioning.</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                        <span class="s1">&#39;Cannot accept input type </span><span class="si">{}</span><span class="s1">. Sequence type inputs must use NDArray.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
            <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">valid_result_types</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">):</span>
                <span class="n">disallowed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span><span class="p">,</span>
                                  <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
                                  <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">disallowed</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ProtocolError</span><span class="p">(</span>
                        <span class="s1">&#39;Cannot wrap function. Operations must have well-defined parameter names.&#39;</span><span class="p">)</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">):</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">([(</span><span class="nb">input</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_function</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inspect a function to be wrapped.</span>

<span class="sd">        Used internally by gmxapi.operation.function_wrapper()</span>

<span class="sd">            Raises:</span>
<span class="sd">                exceptions.ProtocolError if function signature cannot be determined to be valid.</span>

<span class="sd">            Returns:</span>
<span class="sd">                InputCollectionDescription for the function input signature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First, inspect the function.</span>
        <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="c1"># The function must have clear and static input schema</span>
        <span class="c1"># Make sure that all parameters have clear names, whether or not they are used in a call.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">disallowed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span><span class="p">,</span>
                              <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span>
                              <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">disallowed</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ProtocolError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot wrap function. Operations must have well-defined parameter names.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;Function signature includes the (reserved) &quot;input&quot; keyword argument.&#39;</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
                <span class="c1"># Wrapped functions may accept the output parameter to publish results, but</span>
                <span class="c1"># that is not part of the Operation input signature.</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;Could not infer parameter type for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">)):</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
            <span class="n">description</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">annotation</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">InputCollectionDescription</span><span class="p">(</span><span class="n">description</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataSourceCollection</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a compatible DataSourceCollection from provided arguments.</span>

<span class="sd">        Pre-process input and function signature to get named input arguments.</span>

<span class="sd">        This is a helper function to allow calling code to characterize the</span>
<span class="sd">        arguments in a Python function call with hints from the factory that is</span>
<span class="sd">        initializing an operation. Its most useful functionality is to  allows a</span>
<span class="sd">        factory to accept positional arguments where named inputs are usually</span>
<span class="sd">        required. It also allows data sources to participate in multiple</span>
<span class="sd">        DataSourceCollections with minimal constraints.</span>

<span class="sd">        Note that the returned object has had data populated from any defaults</span>
<span class="sd">        described in the InputCollectionDescription.</span>

<span class="sd">        See wrapped_function_runner() and describe_function_input().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For convenience, accept *args, but convert to **kwargs to pass to Operation.</span>
        <span class="c1"># Factory accepts an unadvertised `input` keyword argument that is used as a default kwargs dict.</span>
        <span class="c1"># If present, kwargs[&#39;input&#39;] is treated as an input &quot;pack&quot; providing _default_ values.</span>
        <span class="n">input_kwargs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;input&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">provided_input</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">provided_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">input_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">provided_input</span><span class="p">)</span>
        <span class="c1"># `function` may accept an `output` keyword argument that should not be supplied to the factory.</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Invalid keyword argument: output (reserved).&#39;</span><span class="p">)</span>
            <span class="n">input_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bound_arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">bind_partial</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">input_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Could not bind operation parameters to function signature.&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">assert</span> <span class="s1">&#39;output&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bound_arguments</span><span class="o">.</span><span class="n">arguments</span>
        <span class="n">bound_arguments</span><span class="o">.</span><span class="n">apply_defaults</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;input&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bound_arguments</span><span class="o">.</span><span class="n">arguments</span>
        <span class="n">input_kwargs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([</span><span class="n">pair</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">bound_arguments</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">if</span> <span class="s1">&#39;output&#39;</span> <span class="ow">in</span> <span class="n">input_kwargs</span><span class="p">:</span>
            <span class="n">input_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DataSourceCollection</span><span class="p">(</span><span class="o">**</span><span class="n">input_kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ProxyDataDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for data descriptors used in DataProxyBase subclasses.</span>

<span class="sd">    Subclasses should either not define __init__ or should call the base class</span>
<span class="sd">    __init__ explicitly: super().__init__(self, name, dtype)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">ResultTypeVar</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># TODO: We should not allow dtype==None, but we currently have a weak data</span>
        <span class="c1">#  model that does not allow good support of structured Futures.</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">valid_result_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>


<span class="k">class</span> <span class="nc">DataProxyMeta</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="c1"># Key word arguments consumed by __prepare__</span>
    <span class="n">_prepare_keywords</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;descriptors&#39;</span><span class="p">,)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__prepare__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow dynamic sub-classing.</span>

<span class="sd">        DataProxy class definitions are collections of data descriptors. This</span>
<span class="sd">        class method allows subclasses to give the descriptor names and type(s)</span>
<span class="sd">        in the class declaration as arguments instead of as class attribute</span>
<span class="sd">        assignments.</span>

<span class="sd">            class MyProxy(DataProxyBase, descriptors={name: MyDescriptor() for name in datanames}): pass</span>

<span class="sd">        Note:</span>
<span class="sd">            If we are only using this metaclass for the __prepare__ hook by the</span>
<span class="sd">            time we require Python &gt;= 3.6, we could reimplement __prepare__ as</span>
<span class="sd">            DataProxyBase.__init_subclass__ and remove this metaclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">descriptors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descriptors</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">d</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">namespace</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descriptors</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">descriptors</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Iterable</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DataProxyMeta</span><span class="o">.</span><span class="n">_prepare_keywords</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Unexpected class creation keyword: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="c1"># See note about DataProxyBase._reserved.</span>
        <span class="k">if</span> <span class="s1">&#39;_reserved&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namespace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;_reserved&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span>
                <span class="s1">&#39;We currently expect DataProxy classes to provide a list of reserved attribute names.&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">namespace</span><span class="p">:</span>
            <span class="c1"># Here we can check conformance with naming and typing rules.</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
                <span class="c1"># Skip non-public attributes.</span>
                <span class="k">continue</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">namespace</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="c1"># The purpose of the current data proxies is to serve as a limited namespace</span>
            <span class="c1"># containing only descriptors of a certain type. In the future, these proxies</span>
            <span class="c1"># may be flattened into a facet of a richer OperationHandle class</span>
            <span class="c1"># (this metaclass may become a decorator on an implementation class),</span>
            <span class="c1"># but for now we check that the class is being used according to the</span>
            <span class="c1"># documented framework. A nearer term update could be to restrict the</span>
            <span class="c1"># type of the data descriptor:</span>
            <span class="c1"># TODO: Use a member type of the derived cls (or a mix-in base) to specify a particular</span>
            <span class="c1">#  ProxyDataDescriptor subclass.</span>
            <span class="c1"># Also, see note about DataProxyBase._reserved</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">ProxyDataDescriptor</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namespace</span><span class="p">[</span><span class="s1">&#39;_reserved&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;_reserved&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span>
                                                                 <span class="n">bases</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;_reserved&#39;</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Unexpected data proxy attribute </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">ProxyDataDescriptor</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descriptor</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">descriptor</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">key</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="n">key</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span>
                            <span class="s1">&#39;Descriptor internal name </span><span class="si">{}</span><span class="s1"> does not match attribute name </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">descriptor</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

    <span class="c1"># TODO: This keyword argument stripping is not necessary in more recent Python versions.</span>
    <span class="c1"># When Python minimum required version is increased, check if we can remove this.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DataProxyMeta</span><span class="o">.</span><span class="n">_prepare_keywords</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Unexpected class initialization keyword: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

    <span class="c1"># TODO: See if we can use __dir__ in the metaclass to help hint class attributes for better tab completion.</span>
    <span class="c1">#  Ref: https://ipython.readthedocs.io/en/stable/config/integrating.html#tab-completion</span>
    <span class="c1"># def __dir__(self) -&gt; Iterable[str]:</span>
    <span class="c1">#     return super().__dir__()</span>


<span class="k">class</span> <span class="nc">DataProxyBase</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">DataProxyMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Limited interface to managed resources.</span>

<span class="sd">    Inherit from DataProxy to specialize an interface to an ``instance``.</span>
<span class="sd">    In the derived class, either do not define ``__init__`` or be sure to</span>
<span class="sd">    initialize the super class (DataProxy) with an instance of the object</span>
<span class="sd">    to be proxied.</span>

<span class="sd">    A class deriving from DataProxyBase allows its instances to provide a namespace</span>
<span class="sd">    for proxies to named data by defining attributes that are data descriptors</span>
<span class="sd">    (subclasses of ProxyDataDescriptor).</span>
<span class="sd">    The ProxyDataDescriptors are accessed as attributes of the</span>
<span class="sd">    data proxy instance or by iterating on items(). Attributes that are not</span>
<span class="sd">    ProxyDataDescriptors are possible, but will not be returned by items() which</span>
<span class="sd">    is a necessary part of gmxapi execution protocol.</span>

<span class="sd">    Acts as an owning handle to the resources provide by ``instance``,</span>
<span class="sd">    preventing the reference count of ``instance`` from going to zero for the</span>
<span class="sd">    lifetime of the proxy object.</span>

<span class="sd">    When sub-classing DataProxyBase, data descriptors can be passed as a mapping</span>
<span class="sd">    to the ``descriptors`` key word argument in the class declaration. This</span>
<span class="sd">    allows data proxy subclasses to be easily defined dynamically.</span>

<span class="sd">        mydescriptors = {&#39;foo&#39;: Publisher(&#39;foo&#39;, int), &#39;data&#39;: Publisher(&#39;data&#39;, float)}</span>
<span class="sd">        ...</span>
<span class="sd">        class MyDataProxy(DataProxyBase, descriptors=mydescriptors): pass</span>
<span class="sd">        assert hasattr(MyDataProxy, &#39;foo&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This class attribute (which subclasses are free to replace to augment) is an</span>
    <span class="c1"># indication of a problem with the current data model. If we are allowing</span>
    <span class="c1"># reserved words that would otherwise be valid data names, there is not a</span>
    <span class="c1"># compelling reason for separate data proxy classes: we throw away the assertion</span>
    <span class="c1"># that we are preparing a clean namespace and we could have accomplished the</span>
    <span class="c1"># class responsibilities in the Operation handle with just descriptor classes.</span>
    <span class="c1"># If we want the clean namespace, we should figure out how to keep this interface</span>
    <span class="c1"># from growing and/or have some &quot;hidden&quot; internal interface.</span>
    <span class="n">_reserved</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ensemble_width&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="s1">&#39;_reserved&#39;</span><span class="p">)</span>

    <span class="c1"># This class can be expanded to be the attachment point for a metaclass for</span>
    <span class="c1"># data proxies such as PublishingDataProxy or OutputDataProxy, which may be</span>
    <span class="c1"># defined very dynamically and concisely as a set of Descriptors and a type()</span>
    <span class="c1"># call.</span>
    <span class="c1"># If development in this direction does not materialize, then this base</span>
    <span class="c1"># class is not very useful and should be removed.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="s1">&#39;SourceResource&#39;</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get partial ownership of a resource provider.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            instance : resource-owning object</span>
<span class="sd">            client_id : identifier for client holding the resource handle (e.g. ensemble member id)</span>

<span class="sd">        If client_id is not provided, the proxy scope is for all clients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Decide whether _resource_instance is public or not.</span>
        <span class="c1"># Note: currently commonly needed for subclass implementations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_instance</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="c1"># Developer note subclasses should handle self._client_identifier == None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_identifier</span> <span class="o">=</span> <span class="n">client_id</span>
        <span class="c1"># Collection is fixed by the time of instance creation, so cache it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__keys</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__keys</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ensemble_width</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_instance</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator for tuples of attribute name and descriptor instance.</span>

<span class="sd">        This almost certainly doesn&#39;t do quite what we want...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ProxyDataDescriptor</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__length</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__keys</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">key</span>


<span class="k">class</span> <span class="nc">Publisher</span><span class="p">(</span><span class="n">ProxyDataDescriptor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Data descriptor for write access to a specific named data resource.</span>

<span class="sd">    For a wrapped function receiving an ``output`` argument, provides the</span>
<span class="sd">    accessors for an attribute on the object passed as ``output``. Maps</span>
<span class="sd">    read and write access by the wrapped function to appropriate details of</span>
<span class="sd">    the resource manager.</span>

<span class="sd">    Used internally to implement settable attributes on PublishingDataProxy.</span>
<span class="sd">    Allows PublishingDataProxy to be dynamically defined in the scope of the</span>
<span class="sd">    operation.function_wrapper closure. Each named output is represented by</span>
<span class="sd">    an instance of Publisher in the PublishingDataProxy class definition for</span>
<span class="sd">    the operation.</span>

<span class="sd">    Ref: https://docs.python.org/3/reference/datamodel.html#implementing-descriptors</span>

<span class="sd">    Collaborations:</span>
<span class="sd">    Relies on implementation details of ResourceManager.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">DataProxyBase</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># The current access has come through the class attribute of owner class</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">resource_manager</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_resource_instance</span>
        <span class="n">client_id</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_client_identifier</span>
        <span class="c1"># TODO: Fix API scope.</span>
        <span class="c1"># Either this class is a detail of the same implementation as ResourceManager,</span>
        <span class="c1"># or we need to enforce that instance._resource_instance provides _data (or equivalent)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource_manager</span><span class="p">,</span> <span class="n">ResourceManager</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">client_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">resource_manager</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">resource_manager</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)[</span><span class="n">client_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">DataProxyBase</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">resource_manager</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_resource_instance</span>
        <span class="c1"># TODO: Fix API scope.</span>
        <span class="c1"># Either this class is a detail of the same implementation as ResourceManager,</span>
        <span class="c1"># or we need to enforce that instance._resource_instance provides _data (or equivalent)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource_manager</span><span class="p">,</span> <span class="n">ResourceManager</span><span class="p">)</span>
        <span class="n">client_id</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_client_identifier</span>
        <span class="n">resource_manager</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="n">client_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(name=</span><span class="si">{}</span><span class="s1">, dtype=</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">define_publishing_data_proxy</span><span class="p">(</span><span class="n">output_description</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">DataProxyBase</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Returns a class definition for a PublishingDataProxy for the provided output description.&quot;&quot;&quot;</span>
    <span class="c1"># This dynamic type creation hides collaborations with things like make_datastore.</span>
    <span class="c1"># We should encapsulate these relationships in Context details, explicit collaborations</span>
    <span class="c1"># between specific operations and Contexts, and in groups of Operation definition helpers.</span>

    <span class="n">descriptors</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">name</span><span class="p">,</span> <span class="n">Publisher</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">output_description</span><span class="p">])</span>

    <span class="k">class</span> <span class="nc">PublishingDataProxy</span><span class="p">(</span><span class="n">DataProxyBase</span><span class="p">,</span> <span class="n">descriptors</span><span class="o">=</span><span class="n">descriptors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handler for write access to the `output` of an operation.</span>

<span class="sd">        Acts as a sort of PublisherCollection.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">PublishingDataProxy</span>


<span class="c1"># get symbols we can use to annotate input and output types more specifically.</span>
<span class="n">_OutputDataProxyType</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;_OutputDataProxyType&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">DataProxyBase</span><span class="p">)</span>
<span class="n">_PublishingDataProxyType</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;_PublishingDataProxyType&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">DataProxyBase</span><span class="p">)</span>
<span class="c1"># Currently, the ClientID type is an integer, but this may change.</span>
<span class="n">ClientID</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;ClientID&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Resources</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">Generic</span><span class="p">[</span><span class="n">_PublishingDataProxyType</span><span class="p">]):</span>
    <span class="k">pass</span>


<span class="c1"># TODO: Why generic in publishingdataproxytype?</span>
<span class="k">class</span> <span class="nc">SourceResource</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">Generic</span><span class="p">[</span><span class="n">_OutputDataProxyType</span><span class="p">,</span> <span class="n">_PublishingDataProxyType</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Resource Manager for a data provider.</span>

<span class="sd">    Supports Future instances in a particular context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Note: ResourceManager members not yet included:</span>
    <span class="c1"># future(), _data, set_result.</span>

    <span class="c1"># This might not belong here. Maybe separate out for a OperationHandleManager?</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputDataProxyType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the output data proxy.&quot;&quot;&quot;</span>
        <span class="c1"># Warning: this should probably be renamed, but &quot;output_data_proxy&quot; is already</span>
        <span class="c1"># a member in at least one derived class.</span>
        <span class="o">...</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OutputData&#39;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">update_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bring the _data member up to date and local.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recursively reinitialize resources.</span>

<span class="sd">        Set the resource manager to its initialized state.</span>
<span class="sd">        All outputs are marked not &quot;done&quot;.</span>
<span class="sd">        All inputs supporting the interface have ``_reset()`` called on them.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Ensemble width of the managed resources.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">ResultDescription</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Future&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a Future handle for managed data.</span>

<span class="sd">        Resource managers owned by subclasses of gmx.operation.Context provide</span>
<span class="sd">        this method to get references to output data.</span>

<span class="sd">        In addition to the interface described by gmx.abc.Future, returned objects</span>
<span class="sd">        provide the interface described by gmx.operation.Future.</span>
<span class="sd">        &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">StaticSourceManager</span><span class="p">(</span><span class="n">SourceResource</span><span class="p">[</span><span class="n">_OutputDataProxyType</span><span class="p">,</span> <span class="n">_PublishingDataProxyType</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Provide the resource manager interface for local static data.</span>

<span class="sd">    Allow data transformations on the proxied resource.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        proxied_data: A gmxapi supported data object.</span>
<span class="sd">        width: Size of (one-dimensional) shaped data produced by function.</span>
<span class="sd">        function: Transformation to perform on the managed data.</span>

<span class="sd">    The callable passed as ``function`` must accept a single argument. The</span>
<span class="sd">    argument will be an iterable when proxied_data represents an ensemble,</span>
<span class="sd">    or an object of the same type as proxied_data otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">proxied_data</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proxied_data</span><span class="p">,</span> <span class="n">Future</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">proxied_data</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">):</span>
            <span class="c1"># Ensemble data source</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">proxied_data</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">proxied_data</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">proxied_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="c1"># In this case, do not implicitly broadcast</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;function&quot; produced data incompatible with &quot;width&quot;.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DataShapeError</span><span class="p">(</span>
                        <span class="s1">&#39;Expected iterable of size </span><span class="si">{}</span><span class="s1"> but &quot;function&quot; result is not iterable.&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">width</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DataShapeError</span><span class="p">(</span>
                    <span class="s1">&#39;Expected iterable of size </span><span class="si">{}</span><span class="s1"> but &quot;function&quot; produced a </span><span class="si">{}</span><span class="s1"> of size </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
                                                                                                  <span class="n">size</span><span class="p">))</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;width must be an integer 1 or greater.&#39;</span><span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">datamodel</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Expecting width 1 but &quot;function&quot; produced iterable type </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="nb">str</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">]</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">ResultDescription</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">OutputData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">member</span><span class="p">],</span> <span class="n">member</span><span class="o">=</span><span class="n">member</span><span class="p">)</span>

        <span class="n">output_collection_description</span> <span class="o">=</span> <span class="n">OutputCollectionDescription</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">dtype</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_data_proxy</span> <span class="o">=</span> <span class="n">define_output_data_proxy</span><span class="p">(</span><span class="n">output_description</span><span class="o">=</span><span class="n">output_collection_description</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OutputData&#39;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputDataProxyType</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_data_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># TODO: It looks like the OutputData ResultDescription probably belongs</span>
        <span class="c1">#  in the public interface.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_description</span><span class="o">.</span><span class="n">width</span>

    <span class="k">def</span> <span class="nf">update_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">ResultDescription</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Future&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ProxyResourceManager</span><span class="p">(</span><span class="n">SourceResource</span><span class="p">[</span><span class="n">_OutputDataProxyType</span><span class="p">,</span> <span class="n">_PublishingDataProxyType</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Act as a resource manager for data managed by another resource manager.</span>

<span class="sd">    Allow data transformations on the proxied resource.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        proxied_future: An object implementing the Future interface.</span>
<span class="sd">        width: Size of (one-dimensional) shaped data produced by function.</span>
<span class="sd">        function: Transformation to perform on the result of proxied_future.</span>

<span class="sd">    The callable passed as ``function`` must accept a single argument, which will</span>
<span class="sd">    be an iterable when proxied_future represents an ensemble, or an object of</span>
<span class="sd">    type proxied_future.description.dtype otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxied_future</span><span class="p">:</span> <span class="s1">&#39;Future&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proxied_future</span> <span class="o">=</span> <span class="n">proxied_future</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied_future</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span>

    <span class="k">def</span> <span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_width</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proxied_future</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;Request for unknown data.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;Data not ready.&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_width</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># TODO Fix this typing nightmare:</span>
            <span class="c1">#  ResultDescription should be fully knowable and defined when the resource manager is initialized.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">OutputData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">ResultDescription</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_width</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">member</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">OutputData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">ResultDescription</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_width</span><span class="p">))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">update_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputDataProxyType</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;ProxyResourceManager cannot yet manage a full OutputDataProxy.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">ResultDescription</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AbstractOperation</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">Generic</span><span class="p">[</span><span class="n">_OutputDataProxyType</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Client interface to an operation instance (graph node).</span>

<span class="sd">    Note that this is a generic abstract class. Subclasses should provide a</span>
<span class="sd">    class subscript to help static type checkers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assert execution of an operation.</span>

<span class="sd">        After calling run(), the operation results are guaranteed to be available</span>
<span class="sd">        in the local context.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputDataProxyType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a proxy collection to the output of the operation.</span>

<span class="sd">        Developer note: The &#39;output&#39; property exists to isolate the namespace of</span>
<span class="sd">        output data from other operation handle attributes and we should consider</span>
<span class="sd">        whether it is actually necessary or helpful. To facilitate its possible</span>
<span class="sd">        future removal, do not enrich its interface beyond that of a collection</span>
<span class="sd">        of OutputDescriptor attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>


<span class="k">class</span> <span class="nc">OperationRegistryKey</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;OperationRegistryKey&#39;</span><span class="p">,</span> <span class="s1">&#39;namespace name&#39;</span><span class="p">),</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Hashable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to define the key type for OperationRegistry.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test equivalence rather than identity.</span>

<span class="sd">        Note: Use `is` to test identity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">namespace</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(namespace=</span><span class="si">{}</span><span class="s1">, name=</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_make_registry_key</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationRegistryKey</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Normalize input to an OperationRegistryKey.</span>

<span class="sd">    Used to implement OperationRegistry.__getitem__(), which catches and converts</span>
<span class="sd">    the various exceptions this helper function can produce.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OperationRegistryKey</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Empty index value passed to OperationRegistry instance[].&#39;</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">OperationRegistryKey</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">namespace</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">OperationRegistryKey</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># Item could be a class object or an instance object...</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;namespace&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">namespace</span><span class="p">):</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">namespace</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">namespace</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">OperationRegistryKey</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;Not a usable OperationRegistryKey: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">OperationRegistry</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">UserDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to map identifiers to Operation implementation instances.</span>

<span class="sd">    This is an implementation detail of gmxapi.operation and should not be used from</span>
<span class="sd">    outside of the package until a stable interface can be specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@typing</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">OperationRegistryKey</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@typing</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch the requested operation registrant.</span>

<span class="sd">        The getter is overloaded to support look-ups in multiple forms.</span>

<span class="sd">        The key can be given in the following forms.</span>
<span class="sd">        * As a period-delimited string of the form &quot;namespace.operation&quot;.</span>
<span class="sd">        * As an OperationRegistryKey object.</span>
<span class="sd">        * As a sequence of positional arguments accepted by OperationRegistryKey.</span>
<span class="sd">        * As an object conforming to the OperationRegistryKey interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">_make_registry_key</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not interpret key as a OperationRegistryKey.&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>


<span class="c1"># Module level data store for locating operation implementations at run time.</span>
<span class="c1"># TODO: This may make sense as instance data of a root Context instance, but we</span>
<span class="c1">#  don&#39;t have a stable interface for communicating between Contexts yet.</span>
<span class="c1"># Alternatively, it could be held as class data in a RegisteredOperation class,</span>
<span class="c1"># but note that the &quot;register&quot; member function would behave less like the abc.ABCMeta</span>
<span class="c1"># support for &quot;virtual subclassing&quot; and more like the generic function machinery</span>
<span class="c1"># of e.g. functools.singledispatch.</span>
<span class="n">_operation_registry</span> <span class="o">=</span> <span class="n">OperationRegistry</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_register_operation</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">OperationImplementation</span><span class="p">]):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">OperationImplementation</span><span class="p">)</span>
    <span class="n">operation</span> <span class="o">=</span> <span class="n">_make_registry_key</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">_operation_registry</span><span class="p">:</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;Attempting to redefine operation </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_name</span><span class="p">))</span>
    <span class="n">_operation_registry</span><span class="p">[</span><span class="n">operation</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>


<span class="c1"># TODO: replace with a generic function that we dispatch on so the type checker can infer a return type.</span>
<span class="k">def</span> <span class="nf">_get_operation_director</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">gmx</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param operation:</span>
<span class="sd">    :param context:</span>
<span class="sd">    :return: gmxapi.abc.OperationDirector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">registrant</span> <span class="o">=</span> <span class="n">_operation_registry</span><span class="p">[</span><span class="n">operation</span><span class="p">]</span>
    <span class="n">director</span> <span class="o">=</span> <span class="n">registrant</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">director</span>


<span class="k">class</span> <span class="nc">InputDescription</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Node input description for gmxapi.operation module.</span>

<span class="sd">    Provides the support needed to understand operation inputs in gmxapi.operation</span>
<span class="sd">    module Contexts.</span>

<span class="sd">    .. todo:: Implementation base class with heritable behavior and/or helpers to</span>
<span class="sd">              compose this functionality from more normative description of</span>
<span class="sd">              operation inputs. This will probably become a facet of the ResourceDirector</span>
<span class="sd">              when specialized for gmxapi.operation.Context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InputCollectionDescription</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Mapping of named inputs and input type.</span>

<span class="sd">        Used to determine valid inputs before an Operation node is created.</span>

<span class="sd">        Collaborations:</span>
<span class="sd">            Related to the operation resource factory for this context.</span>

<span class="sd">        ..  todo::</span>
<span class="sd">            Better unification of this protocol, InputCollectionDescription, and</span>
<span class="sd">            resource factory.</span>
<span class="sd">            Note, also, that the *bind* method of the returned InputCollectionDescription</span>
<span class="sd">            serves as the resource factory for input to the node builder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">make_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="s1">&#39;DataEdge&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The unique identity of an operation node tags the output with respect to the input.</span>

<span class="sd">        Combines information on the Operation details and the input to uniquely</span>
<span class="sd">        identify the Operation node.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            input : A (collection of) data source(s) that can provide Fingerprints.</span>

<span class="sd">        Used internally by the Context to manage ownership of data sources, to</span>
<span class="sd">        locate resources for nodes in work graphs, and to manage serialization,</span>
<span class="sd">        deserialization, and checkpointing of the work graph.</span>

<span class="sd">        The UID is a detail of the generic Operation that _should_ be independent</span>
<span class="sd">        of the Context details to allow the framework to manage when and where</span>
<span class="sd">        an operation is executed.</span>

<span class="sd">        TODO: We probably don&#39;t want to allow Operations to single-handedly determine their</span>
<span class="sd">         own uniqueness, but they probably should participate in the determination with the Context.</span>

<span class="sd">        TODO: Context implementations should be allowed to optimize handling of</span>
<span class="sd">         equivalent operations in different sessions or work graphs, but we do not</span>
<span class="sd">         yet guarantee that UIDs are globally unique!</span>

<span class="sd">        To be refined...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>


<span class="k">class</span> <span class="nc">ConcreteInputDescription</span><span class="p">(</span><span class="n">InputDescription</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple composed InputDescription.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">input_signature</span><span class="p">:</span> <span class="n">InputCollectionDescription</span><span class="p">,</span>
                 <span class="n">uid_helper</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="s1">&#39;DataEdge&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>
                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_signature_description</span> <span class="o">=</span> <span class="n">input_signature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uid_helper</span> <span class="o">=</span> <span class="n">uid_helper</span>

    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InputCollectionDescription</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_signature_description</span>

    <span class="k">def</span> <span class="nf">make_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="s1">&#39;DataEdge&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid_helper</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">OperationMeta</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metaclass to manage the definition of Operation implementation classes.</span>

<span class="sd">    Note that this metaclass can be superseded by `__init_subclass__()` when</span>
<span class="sd">    the minimum Python version is increased to Python 3.6+.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">)</span>
        <span class="c1"># Register subclasses, but not the base class.</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">OperationImplementation</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">OperationImplementation</span><span class="p">:</span>
            <span class="c1"># TODO: Remove OperationDetailsBase layer and this extra check.</span>
            <span class="c1"># Note: we do not yet register the Operations built dynamically because we</span>
            <span class="c1"># don&#39;t have a clear definition of unique implementations yet. For instance,</span>
            <span class="c1"># a new OperationDetails class is defined for each call to gmx.join_arrays</span>
            <span class="c1"># TODO: Properly register and reuse Operations defined dynamically</span>
            <span class="c1">#  through function_wrapper (currently encompassed by OperationDetailsBase subclasses)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;OperationDetailsBase&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">OperationDetailsBase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
                    <span class="n">_register_operation</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span>


<span class="k">class</span> <span class="nc">OperationDetailsBase</span><span class="p">(</span><span class="n">OperationImplementation</span><span class="p">,</span> <span class="n">InputDescription</span><span class="p">,</span>
                           <span class="n">metaclass</span><span class="o">=</span><span class="n">OperationMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for Operation details in this module&#39;s Python Context.</span>

<span class="sd">    Provides necessary interface for use with gmxapi.operation.ResourceManager.</span>
<span class="sd">    Separates the details of an Operation from those of the ResourceManager in</span>
<span class="sd">    a given Context.</span>

<span class="sd">    OperationDetails classes are almost stateless, serving mainly to compose implementation</span>
<span class="sd">    details. Instances (operation objects) provide the Context-dependent interfaces</span>
<span class="sd">    for a specific node in a work graph.</span>

<span class="sd">    OperationDetails subclasses are created dynamically by function_wrapper and</span>
<span class="sd">    make_operation.</span>

<span class="sd">    Developer note: when subclassing, note that the ResourceManager is responsible</span>
<span class="sd">    for managing Operation state. Do not add instance data members related to</span>
<span class="sd">    computation or output state.</span>

<span class="sd">    TODO: determine what is acceptable instance data and/or initialization information.</span>
<span class="sd">    Note that currently the subclass in function_wrapper has _no_ initialization input,</span>
<span class="sd">    but does not yet handle input-dependent output specification or node fingerprinting.</span>
<span class="sd">    It seems likely that instance initialization will require some characterization of</span>
<span class="sd">    supplied input, but nothing else. Even that much is not necessary if the instance</span>
<span class="sd">    is completely stateless, but that would require additional parameters to the member</span>
<span class="sd">    functions. However, an instance should be tied to a specific ResourceManager and</span>
<span class="sd">    Context, so weak references to these would be reasonable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">output_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OutputCollectionDescription</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Mapping of available outputs and types for an existing Operation node.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">publishing_data_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                              <span class="n">instance</span><span class="p">:</span> <span class="n">SourceResource</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">_PublishingDataProxyType</span><span class="p">],</span>
                              <span class="n">client_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_PublishingDataProxyType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Factory for Operation output publishing resources.</span>

<span class="sd">        Used internally when the operation is run with resources provided by instance.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">output_data_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">instance</span><span class="p">:</span> <span class="n">SourceResource</span><span class="p">[</span><span class="n">_OutputDataProxyType</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>
                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputDataProxyType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get an object that can provide Futures for output data managed by instance.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="n">_Resources</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the operation with provided resources.</span>

<span class="sd">        Resources are prepared in an execution context with aid of resource_director()</span>

<span class="sd">        After the first call, output data has been published and is trivially</span>
<span class="sd">        available through the output_data_proxy()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">resource_director</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">_PublishingDataProxyType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Resources</span><span class="p">[</span><span class="n">_PublishingDataProxyType</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;a Director factory that helps build the Session Resources for the function.</span>

<span class="sd">        The Session launcher provides the director with all of the resources previously</span>
<span class="sd">        requested/negotiated/registered by the Operation. The director uses details of</span>
<span class="sd">        the operation to build the resources object required by the operation runner.</span>

<span class="sd">        For the Python Context, the protocol is for the Context to call the</span>
<span class="sd">        resource_director instance method, passing input and output containers.</span>
<span class="sd">        (See, for example, gmxapi.operation.PyFunctionRunnerResources)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="c1"># TODO: Don&#39;t run the director. Just return the correct callable.</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">operation_director</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractOperation</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Dispatching Director for adding a work node.</span>

<span class="sd">        A Director for input of a particular sort knows how to reconcile</span>
<span class="sd">        input with the requirements of the Operation and Context node builder.</span>
<span class="sd">        The Director (using a less flexible / more standard interface)</span>
<span class="sd">        builds the operation node using a node builder provided by the Context.</span>

<span class="sd">        This is essentially the creation method, instead of __init__, but the</span>
<span class="sd">        object is created and owned by the framework, and the caller receives</span>
<span class="sd">        an OperationHandle instead of a reference to an instance of cls.</span>

<span class="sd">        # TODO: We need a way to compose this functionality for arbitrary Contexts.</span>
<span class="sd">        # That likely requires traits on the Contexts, and registration of Context</span>
<span class="sd">        # implementations. It seems likely that an Operation will register Director</span>
<span class="sd">        # implementations on import, and dispatching will be moved to the Context</span>
<span class="sd">        # implementations, which can either find an appropriate OperationDirector</span>
<span class="sd">        # or raise a compatibility error. To avoid requirements on import order of</span>
<span class="sd">        # Operations and Context implementations, we can change this to a non-abstract</span>
<span class="sd">        # dispatching method, requiring registration in the global gmxapi.context</span>
<span class="sd">        # module, or get rid of this method and use something like pkg_resources</span>
<span class="sd">        # &quot;entry point&quot; groups for independent registration of Directors and Contexts,</span>
<span class="sd">        # each annotated with relevant traits. E.g.:</span>
<span class="sd">        # https://setuptools.readthedocs.io/en/latest/setuptools.html#dynamic-discovery-of-services-and-plugins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Context</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Context instance needed for dispatch.&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: use Context characteristics rather than isinstance checks.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ModuleContext</span><span class="p">):</span>
            <span class="n">construct</span> <span class="o">=</span> <span class="n">OperationDirector</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">operation_details</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">construct</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">SubgraphContext</span><span class="p">):</span>
            <span class="n">construct</span> <span class="o">=</span> <span class="n">OperationDirector</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">operation_details</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">construct</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Cannot dispatch operation_director for context </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>


<span class="c1"># TODO: Implement observer pattern for edge-&gt;node data flow.</span>
<span class="c1"># Step 0: implement subject interface subscribe()</span>
<span class="c1"># Step 1: implement subject interface get_state()</span>
<span class="c1"># Step 2: implement observer interface update()</span>
<span class="c1"># Step 3: implement subject interface notify()</span>
<span class="c1"># Step 4: implement observer hook to support substantial change in source that</span>
<span class="c1">#         invalidates downstream fingerprinting, such as a new subgraph iteration.</span>
<span class="c1"># class Observer(object):</span>
<span class="c1">#     &quot;&quot;&quot;Abstract base class for data observers.&quot;&quot;&quot;</span>
<span class="c1">#     def rebind(self, edge: DataEdge):</span>
<span class="c1">#         &quot;&quot;&quot;Recreate the Operation at the consuming end of the DataEdge.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">Future</span><span class="p">(</span><span class="n">_Future</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;gmxapi data handle.</span>

<span class="sd">    Future is currently more than a Future right now. (should be corrected / clarified.)</span>
<span class="sd">    Future is also a facade to other features of the data provider.</span>

<span class="sd">    Future objects are the most atomic interface between Contexts. User scripts</span>
<span class="sd">    may hold Futures from which they extract data with result(). Operation output</span>
<span class="sd">    used as input for another Operation can be decomposed such that the Operation</span>
<span class="sd">    factory has only Future objects in its input.</span>

<span class="sd">    TODO: ``subscribe`` method allows consumers to bind as Observers.</span>

<span class="sd">    TODO: extract the abstract class for input inspection?</span>
<span class="sd">    Currently abstraction is handled through SourceResource subclassing.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        description (ResultDescription): Describes the result to be obtained from this Future.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_manager</span><span class="p">:</span> <span class="n">SourceResource</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">ResultDescription</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">ResultDescription</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;Need description of requested data.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>  <span class="c1"># type: ResultDescription</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_manager</span> <span class="o">=</span> <span class="n">resource_manager</span>

        <span class="c1"># Deprecated. We should not &quot;reset&quot; futures, but reconstitute them, but we</span>
        <span class="c1"># need to move the data model to a subscription-based system so that we can</span>
        <span class="c1"># make Futures properly immutable and issue new ones across subgraph iterations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_resets</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># This function is defined because we have defined __hash__().</span>
        <span class="c1"># Before customizing __eq__(), recall that Python objects that compare</span>
        <span class="c1"># equal should hash to the same value.</span>
        <span class="c1"># Please keep the two functions semantically correct.</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We cannot properly determine equivalency beyond the scope of a ResourceManager instance</span>
        <span class="c1"># without more developed data flow fingerprinting.</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_manager</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_resets</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Future: name=</span><span class="si">{}</span><span class="s1">, description=</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResultTypeVar</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch data to the caller&#39;s Context.</span>

<span class="sd">        Returns an object of the concrete type specified according to</span>
<span class="sd">        the operation that produces this Result.</span>

<span class="sd">        Ensemble data are returned as a list. Scalar results or results from single</span>
<span class="sd">        member ensembles are returned as scalars.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_manager</span><span class="o">.</span><span class="n">update_output</span><span class="p">()</span>
        <span class="c1"># Return ownership of concrete data</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># For intuitive use in non-ensemble cases, we represent data as bare scalars</span>
        <span class="c1"># when possible. It is easier for users to cast scalars to lists of length 1</span>
        <span class="c1"># than to introspect their own code to determine if a list of length 1 is</span>
        <span class="c1"># part of an ensemble or not. The data model will become clearer as we</span>
        <span class="c1"># develop more robust handling of multidimensional data and data flow topologies.</span>
        <span class="c1"># In the future,</span>
        <span class="c1"># we may distinguish between data of shape () and shape (1,), but we will need</span>
        <span class="c1"># to be careful with semantics. We are already starting to adopt a rule-of-thumb</span>
        <span class="c1"># that data objects assume the minimum dimensionality necessary unless told</span>
        <span class="c1"># otherwise, and we could make that a hard rule if it doesn&#39;t make other things</span>
        <span class="c1"># too difficult.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">handle</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">member</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">handle</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="c1"># TODO: Richer output behavior.</span>
        <span class="c1"># return self._Result(self)</span>

    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark the Future &quot;not done&quot; to allow reexecution.</span>

<span class="sd">        Invalidates cached results, resets &quot;done&quot; markers in data sources, and</span>
<span class="sd">        triggers _reset recursively.</span>

<span class="sd">        Note: this is a hack that is inconsistent with the plan of unique mappings</span>
<span class="sd">        of inputs to outputs, but allows a quick prototype for looping operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_resets</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_manager</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">dtype</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a more limited view on the Future.&quot;&quot;&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">ResultDescription</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="c1"># TODO: Use explicit typing when we have more thorough typing.</span>
        <span class="n">description</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">ProxyResourceManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="n">width</span><span class="o">=</span><span class="n">description</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                         <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">item</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">ProxyResourceManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="n">width</span><span class="o">=</span><span class="n">description</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                         <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">item</span><span class="p">:</span>
                                         <span class="p">[</span><span class="n">subscriptable</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">subscriptable</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">proxy</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">OutputDataDescriptor</span><span class="p">(</span><span class="n">ProxyDataDescriptor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read-only data descriptor for proxied access to output data.</span>

<span class="sd">    Knows how to get a Future from the resource manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: Reconcile the internal implementation details with the visibility and</span>
    <span class="c1">#  usages of this class.</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">:</span> <span class="n">DataProxyBase</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Access through class attribute of owner class</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">result_description</span> <span class="o">=</span> <span class="n">ResultDescription</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">proxy</span><span class="o">.</span><span class="n">ensemble_width</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">proxy</span><span class="o">.</span><span class="n">_resource_instance</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">result_description</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MutableResourceDescriptor</span><span class="p">(</span><span class="n">ProxyDataDescriptor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Accessor for rich binding interfaces.</span>

<span class="sd">    Allows operations to access resources beyond the scope of the current</span>
<span class="sd">    resource manager. Used by operations whose interactions are more complicated</span>
<span class="sd">    than standard typed data flow at the scope of the current Context.</span>

<span class="sd">    Instead of a Future interface, the returned object is a MutableResource with</span>
<span class="sd">    which a subscriber can collaborate with lower-level protocols.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">:</span> <span class="n">DataProxyBase</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">MutableResource</span><span class="p">,</span> <span class="s1">&#39;MutableResourceDescriptor&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Access through class attribute of owner class. We don&#39;t have a</span>
            <span class="c1"># specified use case for that, so allow inspection of the data</span>
            <span class="c1"># descriptor instance, itself.</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="c1"># TODO: implement.</span>
        <span class="c1"># The protocol for MD extension plugins requires that the simulation operation</span>
        <span class="c1"># subscribe to the plugin. Then the Context allows the plugin to access the</span>
        <span class="c1"># MdRunner interface as the simulation is launched.</span>
        <span class="c1"># The protocol for modify_input and for mdrun to consume the TPR payload</span>
        <span class="c1"># of read_tpr or modify_input should allow us to use the gmxapi 0.0.7</span>
        <span class="c1"># WorkSpec to configure and launch a simulation, which we can do by feeding</span>
        <span class="c1"># forward and building a fused operation at the mdrun node. The information</span>
        <span class="c1"># fed forward can just be references to the inputs and parameters of the</span>
        <span class="c1"># earlier operations, with annotations so that we know the intended behavior.</span>


<span class="k">def</span> <span class="nf">define_output_data_proxy</span><span class="p">(</span><span class="n">output_description</span><span class="p">:</span> <span class="n">OutputCollectionDescription</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">DataProxyBase</span><span class="p">]:</span>
    <span class="n">descriptors</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">OutputDataDescriptor</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">output_description</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">class</span> <span class="nc">OutputDataProxy</span><span class="p">(</span><span class="n">DataProxyBase</span><span class="p">,</span> <span class="n">descriptors</span><span class="o">=</span><span class="n">descriptors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handler for read access to the `output` member of an operation handle.</span>

<span class="sd">        Acts as a sort of ResultCollection.</span>

<span class="sd">        A ResourceManager creates an OutputDataProxy instance at initialization to</span>
<span class="sd">        provide the ``output`` property of an operation handle.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="c1"># Note: the OutputDataProxy has an inherent ensemble shape in the context</span>
    <span class="c1"># in which it is used, but that is an instance characteristic, not part of this type definition.</span>
    <span class="c1"># TODO: (FR5) The current tool does not support topology changing operations.</span>
    <span class="k">return</span> <span class="n">OutputDataProxy</span>


<span class="c1"># Encapsulate the description of the input data flow.</span>
<span class="n">PyFuncInput</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Input&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="s1">&#39;kwargs&#39;</span><span class="p">,</span> <span class="s1">&#39;dependencies&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">SinkTerminal</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Operation input end of a data edge.</span>

<span class="sd">    In addition to the information in an InputCollectionDescription, includes</span>
<span class="sd">    topological information for the Operation node (ensemble width).</span>

<span class="sd">    Collaborations: Required for creation of a DataEdge. Created with knowledge</span>
<span class="sd">    of a DataSourceCollection instance and a InputCollectionDescription.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: This clearly maps to a Builder pattern.</span>
    <span class="c1"># I think we want to get the sink terminal builder from a factory parameterized by InputCollectionDescription,</span>
    <span class="c1"># add data source collections, and then build the sink terminal for the data edge.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_collection_description</span><span class="p">:</span> <span class="n">InputCollectionDescription</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define an appropriate data sink for a new operation node.</span>

<span class="sd">        Resolve data sources and input description to determine connectability,</span>
<span class="sd">        topology, and any necessary implicit data transformations.</span>

<span class="sd">        :param input_collection_description: Available inputs for Operation</span>
<span class="sd">        :return: Fully formed description of the Sink terminal for a data edge to be created.</span>

<span class="sd">        Collaborations: Execution Context implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">input_collection_description</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;SinkTerminal: ensemble_width=</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TypeError</span><span class="p">(</span><span class="s1">&#39;Need an integer width &gt; 0.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;Nonsensical ensemble width: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot change ensemble width </span><span class="si">{}</span><span class="s1"> to width </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span> <span class="o">=</span> <span class="n">width</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source_collection</span><span class="p">:</span> <span class="n">DataSourceCollection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the SinkTerminal with the proposed data provider.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sink_dtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_source_collection</span><span class="p">:</span>
                <span class="c1"># If/when we accept data from multiple sources, we&#39;ll need some additional sanity checking.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="s1">&#39;default&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;No data or default for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># With a single data source, we need data to be in the source or have a default</span>
                <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data_source_collection</span>
                <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">sink_dtype</span><span class="p">,</span> <span class="n">valid_result_types</span><span class="p">)</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">data_source_collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Updating Sink for source </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink_dtype</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Source matches sink. No update necessary.&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">)):</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sink_dtype</span> <span class="o">!=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
                            <span class="c1"># Source is NDArray, but sink is not. Implicitly scatter.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">update_width</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">):</span>
                        <span class="n">source_description</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">ResultDescription</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                        <span class="n">source_dtype</span> <span class="o">=</span> <span class="n">source_description</span><span class="o">.</span><span class="n">dtype</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sink_dtype</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
                        <span class="c1"># TODO: Handle typing of Future slices when we have a better data model.</span>
                        <span class="k">if</span> <span class="n">source_dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">source_dtype</span><span class="p">,</span> <span class="n">sink_dtype</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TypeError</span><span class="p">(</span><span class="s1">&#39;Expected </span><span class="si">{}</span><span class="s1"> but got </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sink_dtype</span><span class="p">,</span> <span class="n">source_dtype</span><span class="p">))</span>
                        <span class="n">source_width</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">width</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_width</span><span class="p">(</span><span class="n">source_width</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DataEdge</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;State and description of a data flow edge.</span>

<span class="sd">    A DataEdge connects a data source collection to a data sink. A sink is an</span>
<span class="sd">    input or collection of inputs of an operation (or fused operation). An operation&#39;s</span>
<span class="sd">    inputs may be fed from multiple data source collections, but an operation</span>
<span class="sd">    cannot be fully instantiated until all of its inputs are bound, so the DataEdge</span>
<span class="sd">    is instantiated at the same time the operation is instantiated because the</span>
<span class="sd">    required topology of a graph edge may be determined by the required topology</span>
<span class="sd">    of another graph edge.</span>

<span class="sd">    A data edge has a well-defined topology only when it is terminated by both</span>
<span class="sd">    a source and sink. Creation requires that a source collection is compared to</span>
<span class="sd">    a sink description.</span>

<span class="sd">    Calling code initiates edge creation by passing well-described data sources</span>
<span class="sd">    to an operation factory. The data sources may be annotated with explicit scatter</span>
<span class="sd">    or gather commands.</span>

<span class="sd">    The resource manager for the new operation determines the</span>
<span class="sd">    required shape of the sink to handle all of the offered input.</span>

<span class="sd">    Broadcasting</span>
<span class="sd">    and transformations of the data sources are then determined and the edge is</span>
<span class="sd">    established.</span>

<span class="sd">    At that point, the fingerprint of the input data at each operation</span>
<span class="sd">    becomes available to the resource manager for the operation. The fingerprint</span>
<span class="sd">    has sufficient information for the resource manager of the operation to</span>
<span class="sd">    request and receive data through the execution context.</span>

<span class="sd">    Instantiating operations and data edges implicitly involves collaboration with</span>
<span class="sd">    a Context instance. The state of a given Context or the availability of a</span>
<span class="sd">    default Context through a module function may affect the ability to instantiate</span>
<span class="sd">    an operation or edge. In other words, behavior may be different for connections</span>
<span class="sd">    being made in the scripting environment versus the running Session, and implementation</span>
<span class="sd">    details can determine whether or not new operations or data flow can occur in</span>
<span class="sd">    different code environments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">ConstantResolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_collection</span><span class="p">:</span> <span class="n">DataSourceCollection</span><span class="p">,</span> <span class="n">sink_terminal</span><span class="p">:</span> <span class="n">SinkTerminal</span><span class="p">):</span>
        <span class="c1"># Adapters are callables that transform a source and node ID to local data.</span>
        <span class="c1"># Every key in the sink has an adapter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_collection</span> <span class="o">=</span> <span class="n">source_collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink_terminal</span> <span class="o">=</span> <span class="n">sink_terminal</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sink_terminal</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source_collection</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sink_terminal</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="s1">&#39;default&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConstantResolver</span><span class="p">(</span><span class="n">sink_terminal</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># TODO: Initialize with multiple DataSourceCollections?</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;No source or default for required input &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">source_collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">sink</span> <span class="o">=</span> <span class="n">sink_terminal</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConstantResolver</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConstantResolver</span><span class="p">(</span><span class="n">datamodel</span><span class="o">.</span><span class="n">ndarray</span><span class="p">([</span><span class="n">source</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">):</span>
                        <span class="c1"># TODO: shape checking</span>
                        <span class="c1"># Implicit broadcast may not be what is intended</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConstantResolver</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sink_terminal</span><span class="o">.</span><span class="n">ensemble_width</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span>
                                <span class="s1">&#39;Implicit broadcast could not match array source to ensemble sink&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">member</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">:</span> <span class="n">source</span><span class="p">[</span><span class="n">member</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">):</span>
                    <span class="c1"># Handle data futures...</span>
                    <span class="c1"># If the Future is part of an ensemble, result() will return a list.</span>
                    <span class="c1"># Otherwise, it will return a single object.</span>
                    <span class="n">ensemble_width</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">width</span>
                    <span class="c1"># TODO: subscribe to futures so results can be pushed.</span>
                    <span class="k">if</span> <span class="n">ensemble_width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">member</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">member</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">result</span><span class="p">()[</span><span class="n">member</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">EnsembleDataSource</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">member</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;DataEdge: source_collection=</span><span class="si">{}</span><span class="s1">, sink_terminal=</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink_terminal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_collection</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">member</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">member</span><span class="o">=</span><span class="n">member</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Consume data for the specified sink terminal node.</span>

<span class="sd">        Run-time utility delivers data from the bound data source(s) for the</span>
<span class="sd">        specified terminal that was configured when the edge was created.</span>

<span class="sd">        Terminal node is identified by a member index number.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A Python dictionary of the provided inputs as local data (not Future).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sink_ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink_terminal</span><span class="o">.</span><span class="n">inputs</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sink_ports</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>


<span class="k">class</span> <span class="nc">ResourceManager</span><span class="p">(</span><span class="n">SourceResource</span><span class="p">[</span><span class="n">_OutputDataProxyType</span><span class="p">,</span> <span class="n">_PublishingDataProxyType</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Provides data publication and subscription services.</span>

<span class="sd">        Owns the data published by the operation implementation or served to consumers.</span>
<span class="sd">        Mediates read and write access to the managed data streams.</span>

<span class="sd">        This ResourceManager implementation is defined in conjunction with a</span>
<span class="sd">        run-time definition of an Operation that wraps a Python callable (function).</span>
<span class="sd">        ResourceManager is instantiated with a reference to the callable.</span>

<span class="sd">        When the Operation is run, the resource manager prepares resources for the wrapped</span>
<span class="sd">        function. Inputs provided to the Operation factory are provided to the</span>
<span class="sd">        function as keyword arguments. The wrapped function publishes its output</span>
<span class="sd">        through the (additional) ``output`` key word argument. This argument is</span>
<span class="sd">        a short-lived resource, prepared by the ResourceManager, with writable</span>
<span class="sd">        attributes named in the call to function_wrapper().</span>

<span class="sd">        After the Operation has run and the outputs published, the data managed</span>
<span class="sd">        by the ResourceManager is marked &quot;done.&quot;</span>

<span class="sd">        Protocols:</span>

<span class="sd">        The data() method produces a read-only collection of outputs named for</span>
<span class="sd">        the Operation when the Operation&#39;s ``output`` attribute is accessed.</span>

<span class="sd">        publishing_resources() can be called once during the ResourceManager lifetime</span>
<span class="sd">        to provide the ``output`` object for the wrapped function. (Used by update_output().)</span>

<span class="sd">        update_output() brings the managed output data up-to-date with the input</span>
<span class="sd">        when the Operation results are needed. If the Operation has not run, an</span>
<span class="sd">        execution session is prepared with input and output arguments for the</span>
<span class="sd">        wrapped Python callable. Output is publishable only during this session.</span>

<span class="sd">    TODO: This functionality should evolve to be a facet of Context implementations.</span>
<span class="sd">     There should be no more than one ResourceManager instance per work graph</span>
<span class="sd">     node in a Context. This will soon be at odds with letting the ResourceManager</span>
<span class="sd">     be owned by an operation instance handle.</span>
<span class="sd">    TODO: The publisher and data objects can be more strongly defined through</span>
<span class="sd">     interaction between the Context and clients.</span>

<span class="sd">    Design notes:</span>

<span class="sd">    The normative pattern for updating data is to execute a node in the work</span>
<span class="sd">    graph, passing Resources for an execution Session to an operation runner.</span>
<span class="sd">    The resources and runner are dependent on the implementation details of</span>
<span class="sd">    the operation and the execution context, so logical execution may look</span>
<span class="sd">    like the following.</span>

<span class="sd">        resource_builder = ResourcesBuilder()</span>
<span class="sd">        runner_builder = RunnerBuilder()</span>
<span class="sd">        input_resource_director = input_resource_factory.director(input)</span>
<span class="sd">        output_resource_director = publishing_resource_factory.director(output)</span>
<span class="sd">        input_resource_director(resource_builder, runner_builder)</span>
<span class="sd">        output_resource_director(resource_builder, runner_builder)</span>
<span class="sd">        resources = resource_builder.build()</span>
<span class="sd">        runner = runner_builder.build()</span>
<span class="sd">        runner(resources)</span>

<span class="sd">    Only the final line is intended to be literal. The preceding code, if it</span>
<span class="sd">    exists in entirety, may be spread across several code comments.</span>

<span class="sd">    TODO: Data should be pushed, not pulled.</span>
<span class="sd">    Early implementations executed operation code and extracted results directly.</span>
<span class="sd">    While we need to be able to &quot;wait for&quot; results and alert the data provider that</span>
<span class="sd">    we are ready for input, we want to defer execution management and data flow to</span>
<span class="sd">    the framework.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">__publishing_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ensemble_member</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="n">_PublishingDataProxyType</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get a context manager for resolving the data dependencies of this node.</span>

<span class="sd">        The returned object is a Python context manager (used to open a `with` block)</span>
<span class="sd">        to define the scope in which the operation&#39;s output can be published.</span>
<span class="sd">        &#39;output&#39; type resources can be published exactly once, and only while the</span>
<span class="sd">        publishing context is active. (See operation.function_wrapper())</span>

<span class="sd">        Used internally to implement ResourceManager.publishing_resources()</span>

<span class="sd">        Responsibilities of the context manager are to:</span>
<span class="sd">            * (TODO) Make sure dependencies are resolved.</span>
<span class="sd">            * Make sure outputs are marked &#39;done&#39; when leaving the context.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO:</span>
        <span class="c1"># if self._data.done():</span>
        <span class="c1">#     raise exceptions.ProtocolError(&#39;Resources have already been published.&#39;)</span>

        <span class="c1"># I don&#39;t think we want the OperationDetails to need to know about ensemble data,</span>
        <span class="c1"># (though the should probably be allowed to), so we may need a separate interface</span>
        <span class="c1"># for the resource manager with built-in scope-limiting to a single ensemble member.</span>
        <span class="c1"># Right now, one Operation handle owns one ResourceManager (which takes care of</span>
        <span class="c1"># the ensemble details), which owns one OperationDetails (which has no ensemble knowledge).</span>
        <span class="c1"># It is the responsibility of the calling code to make sure the PublishingDataProxy</span>
        <span class="c1"># gets used correctly.</span>

        <span class="c1"># ref: https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">[</span><span class="n">ensemble_member</span><span class="p">]:</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__publishing_data_proxy</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                                        <span class="n">client_id</span><span class="o">=</span><span class="n">ensemble_member</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">resource</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uncaught </span><span class="si">{}</span><span class="s1"> while providing output-publishing resources for </span><span class="si">{}</span><span class="s1">.&#39;</span>
            <span class="n">message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_id</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Published output for </span><span class="si">{}</span><span class="s1"> member </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operation_id</span><span class="p">,</span> <span class="n">ensemble_member</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">[</span><span class="n">ensemble_member</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">source</span><span class="p">:</span> <span class="n">DataEdge</span><span class="p">,</span>
                 <span class="n">operation_id</span><span class="p">,</span>
                 <span class="n">output_description</span><span class="p">:</span> <span class="n">OutputCollectionDescription</span><span class="p">,</span>
                 <span class="n">output_data_proxy</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">_OutputDataProxyType</span><span class="p">],</span>
                 <span class="n">publishing_data_proxy</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">_PublishingDataProxyType</span><span class="p">],</span>
                 <span class="n">resource_factory</span><span class="p">,</span>
                 <span class="n">runner_director</span><span class="p">,</span>
                 <span class="n">output_context</span><span class="p">:</span> <span class="s1">&#39;Context&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a resource manager for the inputs and outputs of an operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: This implementation assumes there is one ResourceManager instance per data source,</span>
        <span class="c1"># so we only stash the inputs and dependency information for a single set of resources.</span>
        <span class="c1"># TODO: validate input_fingerprint as its interface becomes clear.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_edge</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_edge</span><span class="o">.</span><span class="n">sink_terminal</span><span class="o">.</span><span class="n">ensemble_width</span>

        <span class="c1"># Node UID.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_id</span> <span class="o">=</span> <span class="n">operation_id</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_context</span><span class="p">,</span> <span class="n">Context</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_context</span> <span class="o">=</span> <span class="n">output_context</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Provide an instance of gmxapi.operation.Context for output_context&#39;</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_output_data_proxy</span> <span class="o">=</span> <span class="n">output_data_proxy</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_data_proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_data_proxy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_output_description</span> <span class="o">=</span> <span class="n">output_description</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__publishing_data_proxy</span> <span class="o">=</span> <span class="n">publishing_data_proxy</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__publishing_data_proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__publishing_data_proxy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_runner_director</span> <span class="o">=</span> <span class="n">runner_director</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runner_director</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_factory</span> <span class="o">=</span> <span class="n">resource_factory</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">_make_datastore</span><span class="p">(</span><span class="n">output_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_description</span><span class="p">,</span>
                                     <span class="n">ensemble_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span><span class="p">)</span>

        <span class="c1"># We store a rereference to the publishing context manager implementation</span>
        <span class="c1"># in a data structure that can only produce one per Python interpreter</span>
        <span class="c1"># (using list.pop()).</span>
        <span class="c1"># TODO: reimplement as a data descriptor</span>
        <span class="c1">#  so that PublishingDataProxy does not need a bound circular reference.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__publishing_resources</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__publishing_context</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__operation_entrance_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__operation_entrance_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__publishing_resources</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__publishing_context</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_edge</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__operation_entrance_counter</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">member</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">[</span><span class="n">member</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">member</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="c1"># In this specification, it is antithetical to publish Futures.</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Operation produced Future instead of real output.&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># Ignore when `item` is not iterable.</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="n">member</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">done</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Raises exceptions.ProtocolError if requested data is not local yet.</span>
<span class="sd">        Raises exceptions.ValueError if data is requested for an unknown name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;Request for unknown data.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;Data not ready.&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">OutputData</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="c1"># TODO: Normalize. This is the no-argument, no-return callable member of an</span>
    <span class="c1">#  operation handle that dispatches to another Context (the operation implementation).</span>
    <span class="c1"># TODO: Allow update of a single ensemble member. As written, this always updates all ensemble members. That can</span>
    <span class="c1">#  be the default behavior, but we don&#39;t want to require non-local updates in all cases.</span>
    <span class="k">def</span> <span class="nf">update_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bring the output of the bound operation up to date.</span>

<span class="sd">        Execute the bound operation once if and only if it has not</span>
<span class="sd">        yet been run in the lifetime of this resource manager.</span>

<span class="sd">        Used internally to implement Futures for the local operation</span>
<span class="sd">        associated with this resource manager.</span>

<span class="sd">        TODO: We need a different implementation for an operation whose output</span>
<span class="sd">         is served by multiple resource managers. E.g. an operation whose output</span>
<span class="sd">         is available across the ensemble, but which should only be executed on</span>
<span class="sd">         a single ensemble member.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This code is not intended to be reentrant. We make a modest attempt to</span>
        <span class="c1"># catch unexpected reentrance, but this is not (yet) intended to be a thread-safe</span>
        <span class="c1"># resource manager implementation.</span>
        <span class="c1"># TODO: Handle checking just the ensemble members this resource manager is responsible for.</span>
        <span class="c1"># TODO: Replace with a managed observer pattern. Update once when input is available in the Context.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="c1"># Note: This check could also be encapsulated in a run_once decorator that</span>
            <span class="c1"># could even set a data descriptor to change behavior.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__operation_entrance_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__operation_entrance_counter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ProtocolError</span><span class="p">(</span><span class="s1">&#39;Bug detected: resource manager tried to execute operation twice.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="c1"># Note! This is a detail of the ResourceManager in a SerialContext</span>
                <span class="c1"># TODO: rewrite with the pattern that this block is directing and then resolving an operation in the</span>
                <span class="c1">#  operation&#39;s library/implementation context.</span>
                <span class="n">publishing_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publishing_resources</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_width</span><span class="p">):</span>
                    <span class="c1"># TODO: rewrite the following expression as a call to a resource factory.</span>
                    <span class="c1"># TODO: Consider whether the resource_factory behavior should be normalized</span>
                    <span class="c1">#  to always use `with` blocks to indicate the lifetime of a resource handle.</span>
                    <span class="c1">#  That implies that an operation handle can expire, but the operation handle</span>
                    <span class="c1">#  could be &quot;yield&quot;ed</span>
                    <span class="c1">#  from within the `with` block to keep the resource scope alive until the resulting</span>
                    <span class="c1">#  generator is exhausted. Not sure what that looks like or what the use case would be.</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_input</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
                        <span class="c1"># Note: Resources are marked &quot;done&quot; by the publishing system</span>
                        <span class="c1"># before the following context manager finishes exiting.</span>
                        <span class="k">with</span> <span class="n">publishing_resources</span><span class="p">(</span><span class="n">ensemble_member</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
                            <span class="c1"># self._runner(*input.args, output=output, **input.kwargs)</span>
                            <span class="c1">####</span>
                            <span class="c1"># Here we can make _runner a thing that accepts session resources, and</span>
                            <span class="c1"># is created by specializable builders. Separate out the expression of</span>
                            <span class="c1"># inputs.</span>
                            <span class="c1">#</span>
                            <span class="c1"># resource_builder = OperationDetails.ResourcesBuilder(context)</span>
                            <span class="c1"># runner_builder = OperationDetails.RunnerBuilder(context)</span>
                            <span class="c1"># input_resource_director = self._input_resource_factory.director(input)</span>
                            <span class="c1"># output_resource_director = self._publishing_resource_factory.director(output)</span>
                            <span class="c1"># input_resource_director(resource_builder, runner_builder)</span>
                            <span class="c1"># output_resource_director(resource_builder, runner_builder)</span>
                            <span class="c1"># resources = resource_builder.build()</span>
                            <span class="c1"># runner = runner_builder.build()</span>
                            <span class="c1"># runner(resources)</span>
                            <span class="c1">#</span>
                            <span class="c1"># This resource factory signature might need to be inverted or broken up</span>
                            <span class="c1"># into a builder for consistency. I.e.</span>
                            <span class="c1"># option 1: Make the input and output resources with separate factories and add_resource on</span>
                            <span class="c1"># the runner builder.</span>
                            <span class="c1"># option 2: Pass resource_builder to input_director and then output_director.</span>
                            <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_factory</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
                            <span class="n">runner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runner_director</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
                            <span class="n">runner</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;update_output implementation failed to update all outputs.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">ResultDescription</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a Future for a named output.</span>

<span class="sd">        Provide a description of the expected result to check for compatibility or</span>
<span class="sd">        implicit topological conversion.</span>

<span class="sd">        TODO: (FR5+) Normalize this part of the interface between operation definitions and</span>
<span class="sd">         resource managers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;name&quot; argument must name an output.&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">requested_dtype</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">available_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_description</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="n">requested_dtype</span> <span class="o">!=</span> <span class="n">available_dtype</span><span class="p">:</span>
            <span class="c1"># TODO: framework to check for implicit conversions</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Requested Future of type </span><span class="si">{}</span><span class="s1"> is not compatible with available type </span><span class="si">{}</span><span class="s1">.&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">requested_dtype</span><span class="p">,</span> <span class="n">available_dtype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputDataProxyType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get an adapter to the output resources to access results.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_data_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">local_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">member</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;In an API session, get a handle to fully resolved locally available input data.</span>

<span class="sd">        Execution dependencies are resolved on creation of the context manager. Input data</span>
<span class="sd">        becomes available in the ``as`` object when entering the context manager, which</span>
<span class="sd">        becomes invalid after exiting the context manager. Resources allocated to hold the</span>
<span class="sd">        input data may be released when exiting the context manager.</span>

<span class="sd">        It is left as an implementation detail whether the context manager is reusable and</span>
<span class="sd">        under what circumstances one may be obtained.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Localize data</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_edge</span><span class="o">.</span><span class="n">sink</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">member</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;input&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span>

        <span class="c1"># Check that we have real data</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">)</span>
            <span class="n">value_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">):</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_values</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_list</span><span class="p">,</span> <span class="n">Future</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value_list</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value_list</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value_list</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">)</span>

        <span class="n">input_pack</span> <span class="o">=</span> <span class="n">InputPack</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Prepare input data structure</span>
        <span class="c1"># Note: we use &#39;yield&#39; instead of &#39;return&#39; for the protocol expected by</span>
        <span class="c1"># the @contextmanager decorator</span>
        <span class="k">yield</span> <span class="n">input_pack</span>

    <span class="k">def</span> <span class="nf">publishing_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a context manager for resolving the data dependencies of this node.</span>

<span class="sd">        Use the returned object as a Python context manager.</span>
<span class="sd">        &#39;output&#39; type resources can be published exactly once, and only while the</span>
<span class="sd">        publishing context is active.</span>

<span class="sd">        Write access to publishing resources can be granted exactly once during the</span>
<span class="sd">        resource manager lifetime and conveys exclusive access.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__publishing_resources</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">PyFunctionRunnerResources</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">UserDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runtime resources for Python functions.</span>

<span class="sd">    Produced by a ResourceDirector for a particular Operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;output&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;output&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">PyFunctionRunner</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span> <span class="n">output_description</span><span class="p">:</span> <span class="n">OutputCollectionDescription</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_description</span> <span class="o">=</span> <span class="n">output_description</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="n">PyFunctionRunnerResources</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">resources</span><span class="o">.</span><span class="n">output</span><span class="p">(),</span> <span class="o">**</span><span class="n">resources</span><span class="o">.</span><span class="n">input</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">CapturedOutputRunner</span><span class="p">(</span><span class="n">PyFunctionRunner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function runner that captures return value as output.data&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="n">PyFunctionRunnerResources</span><span class="p">):</span>
        <span class="n">resources</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">**</span><span class="n">resources</span><span class="o">.</span><span class="n">input</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">OutputParameterRunner</span><span class="p">(</span><span class="n">PyFunctionRunner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function runner that uses output parameter to let function publish output.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="n">PyFunctionRunnerResources</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">**</span><span class="n">resources</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">wrapped_function_runner</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">output_description</span><span class="p">:</span> <span class="n">OutputCollectionDescription</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PyFunctionRunner</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get an adapter for a function to be wrapped.</span>

<span class="sd">    If the function does not accept a publishing data proxy as an `output`</span>
<span class="sd">    key word argument, the returned object has a `capture_output` attribute that</span>
<span class="sd">    must be re-assigned by the calling code before calling the runner. `capture_output`</span>
<span class="sd">    must be assigned to be a callable that will receive the output of the wrapped</span>
<span class="sd">    function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Callable with a signature `__call__(*args, **kwargs)` and no return value</span>

<span class="sd">    Collaborations:</span>
<span class="sd">        OperationDetails.resource_director assigns the `capture_output` member of the returned object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

    <span class="c1"># Implementation note: this function dispatches an implementation with the</span>
    <span class="c1"># logic below. A better factoring would be a &quot;chain of responsibility&quot; in</span>
    <span class="c1"># which the concrete Runners would be tried in sequence and determine internally</span>
    <span class="c1"># whether to create a runner, raise an error, or defer.</span>

    <span class="c1"># Determine output details for proper dispatching.</span>
    <span class="c1"># First check for signature with output parameter.</span>
    <span class="c1"># TODO FR4: standardize typing</span>
    <span class="k">if</span> <span class="s1">&#39;output&#39;</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_description</span><span class="p">,</span> <span class="n">OutputCollectionDescription</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_description</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s1">&#39;Function passes output through call argument, but output is not described.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">OutputParameterRunner</span><span class="p">(</span>
                <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span>
                <span class="n">output_description</span><span class="o">=</span><span class="n">OutputCollectionDescription</span><span class="p">(</span><span class="o">**</span><span class="n">output_description</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OutputParameterRunner</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span>
                                         <span class="n">output_description</span><span class="o">=</span><span class="n">output_description</span><span class="p">)</span>
    <span class="c1"># Next try output_description parameter or function return annotation.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_description</span><span class="p">,</span> <span class="n">OutputCollectionDescription</span><span class="p">):</span>
            <span class="n">return_type</span> <span class="o">=</span> <span class="n">output_description</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gmxapi_datatype</span>
        <span class="k">elif</span> <span class="n">output_description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># output_description should be None for inferred output or</span>
            <span class="c1"># a singular mapping of the key &#39;data&#39; to a gmxapi type.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_description</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="nb">set</span><span class="p">(</span><span class="n">output_description</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">}:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span>
                    <span class="s1">&#39;invalid output description for wrapped function: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_description</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">signature</span><span class="o">.</span><span class="n">return_annotation</span> <span class="o">!=</span> <span class="n">signature</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">signature</span><span class="o">.</span><span class="n">return_annotation</span> <span class="o">!=</span> <span class="n">output_description</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span>
                        <span class="s1">&#39;Wrapped function with return-value-capture provided with non-matching output description.&#39;</span><span class="p">)</span>
            <span class="n">return_type</span> <span class="o">=</span> <span class="n">output_description</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use return type inferred from function signature.</span>
            <span class="n">return_type</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">return_annotation</span>
        <span class="k">if</span> <span class="n">return_type</span> <span class="o">==</span> <span class="n">signature</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">return_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;No return annotation or output_description for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">CapturedOutputRunner</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span>
                                    <span class="n">output_description</span><span class="o">=</span><span class="n">OutputCollectionDescription</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">return_type</span><span class="p">))</span>


<span class="c1"># TODO: Refactor in terms of reference to a node in a Context.</span>
<span class="c1">#  ResourceManager is an implementation detail of how the Context</span>
<span class="c1">#  manages a node.</span>
<span class="k">class</span> <span class="nc">OperationHandle</span><span class="p">(</span><span class="n">AbstractOperation</span><span class="p">[</span><span class="n">_OutputDataProxyType</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Generic Operation handle for dynamically defined operations.</span>

<span class="sd">    Define a gmxapi Operation for the functionality being wrapped by the enclosing code.</span>

<span class="sd">    An Operation type definition encapsulates description of allowed inputs</span>
<span class="sd">    of an Operation. An Operation instance represents a node in a work graph</span>
<span class="sd">    with uniquely fingerprinted inputs and well-defined output. The implementation</span>
<span class="sd">    of the operation is a collaboration with the resource managers resolving</span>
<span class="sd">    data flow for output Futures, which may depend on the execution context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_manager</span><span class="p">:</span> <span class="n">SourceResource</span><span class="p">[</span><span class="n">_OutputDataProxyType</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Initialization defines the unique input requirements of a work graph node.</span>

<span class="sd">        Initialization parameters map to the parameters of the wrapped function with</span>
<span class="sd">        addition(s) to support gmxapi data flow and deferred execution.</span>

<span class="sd">        If provided, an ``input`` keyword argument is interpreted as a parameter pack</span>
<span class="sd">        of base input. Inputs also present as standalone keyword arguments override</span>
<span class="sd">        values in ``input``.</span>

<span class="sd">        Inputs that are handles to gmxapi operations or outputs induce data flow</span>
<span class="sd">        dependencies that the framework promises to satisfy before the Operation</span>
<span class="sd">        executes and produces output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: When the resource manager can be kept alive by an enclosing or</span>
        <span class="c1">#  module-level Context, convert to a weakref.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__resource_manager</span> <span class="o">=</span> <span class="n">resource_manager</span>
        <span class="c1"># The unique identifier for the operation node allows the Context implementation</span>
        <span class="c1"># to manage the state of the handle. Reproducibility of node_uid is TBD, but</span>
        <span class="c1"># it must be unique in a Context where it references a different operation node.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_uid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputDataProxyType</span><span class="p">:</span>
        <span class="c1"># TODO: We can configure `output` as a data descriptor</span>
        <span class="c1">#  instead of a property so that we can get more information</span>
        <span class="c1">#  from the class attribute before creating an instance of OperationDetails.OutputDataProxy.</span>
        <span class="c1"># The C++ equivalence would probably be a templated free function for examining traits.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resource_manager</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a single attempt to resolve data flow conditions.</span>

<span class="sd">        This is a public method, but should not need to be called by users. Instead,</span>
<span class="sd">        just use the `output` data proxy for result handles, or force data flow to be</span>
<span class="sd">        resolved with the `result` methods on the result handles.</span>

<span class="sd">        `run()` may be useful to try to trigger computation (such as for remotely</span>
<span class="sd">        dispatched work) without retrieving results locally right away.</span>

<span class="sd">        `run()` is also useful internally as a facade to the Context implementation details</span>
<span class="sd">        that allow `result()` calls to ask for their data dependencies to be resolved.</span>
<span class="sd">        Typically, `run()` will cause results to be published to subscribing operations as</span>
<span class="sd">        they are calculated, so the `run()` hook allows execution dependency to be slightly</span>
<span class="sd">        decoupled from data dependency, as well as to allow some optimizations or to allow</span>
<span class="sd">        data flow to be resolved opportunistically. `result()` should not call `run()`</span>
<span class="sd">        directly, but should cause the resource manager / Context implementation to process</span>
<span class="sd">        the data flow graph.</span>

<span class="sd">        In one conception, `run()` can have a return value that supports control flow</span>
<span class="sd">        by itself being either runnable or not. The idea would be to support</span>
<span class="sd">        fault tolerance, implementations that require multiple iterations / triggers</span>
<span class="sd">        to complete, or looping operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: `run()` is a synonym for `resolve` or `update` or whatever we choose</span>
        <span class="c1">#  to generically describe the request to bring a node up-to-date: i.e. the</span>
        <span class="c1">#  non-returning callable on the object produced by a director.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__resource_manager</span><span class="o">.</span><span class="n">update_output</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">OperationPlaceholder</span><span class="p">(</span><span class="n">AbstractOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Placeholder for Operation handle during subgraph definition.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subgraph_resource_manager</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;This placeholder operation handle is not in an executable context.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow subgraph components to be connected without instantiating actual operations.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_context</span><span class="p">(),</span> <span class="n">SubgraphContext</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Invalid access to subgraph internals.&#39;</span><span class="p">)</span>


<span class="n">_HandleType</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;_HandleType&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">gmx</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">OperationReference</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NodeBuilder</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">NodeBuilder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add an operation node to be managed by a Context.</span>

<span class="sd">    The NodeBuilder interface implies minimal internal logic, and instead</span>
<span class="sd">    specifies the set of information that must or may be provided to construct</span>
<span class="sd">    a node.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">context</span><span class="p">:</span> <span class="s1">&#39;Context&#39;</span><span class="p">,</span>
                 <span class="n">operation</span><span class="p">,</span>
                 <span class="n">label</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the base NodeBuilder for gmxapi.operation module Nodes.</span>

<span class="sd">        TODO:</span>
<span class="sd">            Convert the *operation* argument to be the registrant in the Operation registry.</span>
<span class="sd">            Requires confirmation of conforming behavior for dynamically defined operations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">_make_registry_key</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Could not create an operation registry key from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: sensibly handle dynamically defined operations.</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_operation_registry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">OperationDetailsBase</span><span class="p">):</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> must be initialized with a registered operation. Got </span><span class="si">{}</span><span class="s1">.&#39;</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span> <span class="n">operation</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">DataSourceCollection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_description</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_factory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runner_director</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_factory</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span> <span class="o">=</span> <span class="n">ResourceManager</span>

    <span class="k">def</span> <span class="nf">set_input_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_description</span><span class="p">:</span> <span class="n">InputDescription</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_description</span> <span class="o">=</span> <span class="n">input_description</span>

    <span class="k">def</span> <span class="nf">set_resource_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_factory</span> <span class="o">=</span> <span class="n">factory</span>

    <span class="k">def</span> <span class="nf">set_runner_director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runner_director</span> <span class="o">=</span> <span class="n">factory</span>

    <span class="k">def</span> <span class="nf">set_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span> <span class="o">=</span> <span class="n">factory</span>

    <span class="k">def</span> <span class="nf">set_output_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">:</span> <span class="s1">&#39;OutputFactory&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_factory</span> <span class="o">=</span> <span class="n">factory</span>

    <span class="k">def</span> <span class="nf">set_resource_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">implementation</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">ResourceManager</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Allow overriding the default ResourceManager implementation.</span>

<span class="sd">        This is a workaround until we figure out what parts of the ResourceManager</span>
<span class="sd">        could be composed, registered separately with the Context, or be customized</span>
<span class="sd">        through other dispatching. One likely part of the solution is for clients</span>
<span class="sd">        of the NodeBuilder to assert requirements of the Context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">implementation</span><span class="p">,</span> <span class="n">ResourceManager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span> <span class="o">=</span> <span class="n">implementation</span>

    <span class="c1"># TODO: Let the Context use the handle factory to produce a dynamically typed handle,</span>
    <span class="c1">#  and figure out the right way to annotate the return value.</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create node and return a handle of the appropriate type.&quot;&quot;&quot;</span>

        <span class="c1"># Check for the ability to instantiate operations.</span>
        <span class="n">missing_details</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">builder_resource</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;input_description&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;resource_factory&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;runner_director&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;handle&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;output_factory&#39;</span><span class="p">]:</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">builder_resource</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missing_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">builder_resource</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_details</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                <span class="s1">&#39;Missing details needed for operation node: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_details</span><span class="p">)</span>
                <span class="p">))</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_description</span><span class="p">,</span> <span class="s1">&#39;signature&#39;</span><span class="p">)</span>
        <span class="n">input_sink</span> <span class="o">=</span> <span class="n">SinkTerminal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_description</span><span class="o">.</span><span class="n">signature</span><span class="p">())</span>
        <span class="n">input_sink</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;SinkTerminal configured: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SinkTerminal</span><span class="p">))</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="n">DataEdge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">input_sink</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Created data edge </span><span class="si">{}</span><span class="s1"> with Sink </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">sink_terminal</span><span class="p">))</span>
        <span class="c1"># TODO: Fingerprinting: Each operation instance has unique output based on the unique input.</span>
        <span class="c1">#            input_data_fingerprint = edge.fingerprint()</span>

        <span class="c1"># Set up output proxy.</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_description</span><span class="p">,</span> <span class="s1">&#39;make_uid&#39;</span><span class="p">)</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_description</span><span class="o">.</span><span class="n">make_uid</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
        <span class="c1"># TODO: ResourceManager should fetch the relevant factories from the Context</span>
        <span class="c1">#  instead of getting an OperationDetails instance.</span>
        <span class="n">output_data_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_factory</span><span class="o">.</span><span class="n">output_proxy</span><span class="p">()</span>
        <span class="n">output_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_factory</span><span class="o">.</span><span class="n">output_description</span><span class="p">()</span>
        <span class="n">publishing_data_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_factory</span><span class="o">.</span><span class="n">publishing_data_proxy</span><span class="p">()</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_manager</span><span class="p">(</span><span class="n">output_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                         <span class="n">source</span><span class="o">=</span><span class="n">edge</span><span class="p">,</span>
                                         <span class="n">operation_id</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
                                         <span class="n">output_data_proxy</span><span class="o">=</span><span class="n">output_data_proxy</span><span class="p">,</span>
                                         <span class="n">output_description</span><span class="o">=</span><span class="n">output_description</span><span class="p">,</span>
                                         <span class="n">publishing_data_proxy</span><span class="o">=</span><span class="n">publishing_data_proxy</span><span class="p">,</span>
                                         <span class="n">resource_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_factory</span><span class="p">,</span>
                                         <span class="n">runner_director</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_runner_director</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">work_graph</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="c1"># TODO: Replace with a call to Node.handle()</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">work_graph</span><span class="p">[</span><span class="n">uid</span><span class="p">])</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">node_uid</span> <span class="o">=</span> <span class="n">uid</span>
        <span class="k">return</span> <span class="n">handle</span>

    <span class="k">def</span> <span class="nf">add_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="c1"># TODO: We can move some input checking here as the data model matures.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>


<span class="k">class</span> <span class="nc">InputPack</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Input container for data sources provided to resource factories.</span>

<span class="sd">    When gmxapi.operation Contexts provide run time inputs to operations,</span>
<span class="sd">    instances of this class are provided to the operation&#39;s registered</span>
<span class="sd">    Resource factory.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        kwargs (dict): collection of named data sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SourceTypeVar</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>


<span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">gmx</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;API Context.</span>

<span class="sd">    All gmxapi data and operations are owned by a Context instance. The Context</span>
<span class="sd">    manages the details of how work is run and how data is managed.</span>

<span class="sd">    Context implementations are not required to inherit from gmxapi.context.Context,</span>
<span class="sd">    but this class definition serves to specify the current Context API.</span>

<span class="sd">    If subclassing is used to implement new Contexts, be sure to initialize the</span>
<span class="sd">    base class when providing a new __init__</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_graph</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_graph</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not find a node identified by </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_id</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_graph</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">node_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span>
                     <span class="n">label</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeBuilder</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a builder for a new work graph node.</span>

<span class="sd">        Nodes are elements of computational work, with resources and execution</span>
<span class="sd">        managed by the Context. The Context handles parallelism resources, data</span>
<span class="sd">        placement, work scheduling, and data flow / execution dependencies.</span>

<span class="sd">        This method is used by Operation director code and helper functions to</span>
<span class="sd">        add work to the graph.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            operation: a registered gmxapi operation</span>
<span class="sd">            label: optional user-provided identifier to provide human-readable node locators.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
    <span class="c1"># TODO: *node()* accessor.</span>
    <span class="c1"># @abc.abstractmethod</span>
    <span class="c1"># def node(self, node_identifier) -&gt; AbstractOperation:</span>
    <span class="c1">#     ...</span>


<span class="k">class</span> <span class="nc">ModuleNodeBuilder</span><span class="p">(</span><span class="n">NodeBuilder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Builder for work nodes in gmxapi.operation.ModuleContext.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ModuleContext</span><span class="p">(</span><span class="n">Context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context implementation for the gmxapi.operation module.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__version__</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">node_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeBuilder</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a builder for a new work node to add an operation in this context.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;Label </span><span class="si">{}</span><span class="s1"> is already in use.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The builder should update the labeled node when it is done.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">ModuleNodeBuilder</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>


<span class="c1"># Context stack.</span>
<span class="n">__current_context</span> <span class="o">=</span> <span class="p">[</span><span class="n">ModuleContext</span><span class="p">()]</span>


<span class="k">def</span> <span class="nf">current_context</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Context</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get a reference to the currently active Context.</span>

<span class="sd">    The imported gmxapi.context module maintains some state for the convenience</span>
<span class="sd">    of the scripting environment. Internally, all gmxapi activity occurs under</span>
<span class="sd">    the management of an API Context, explicitly or implicitly. Some actions or</span>
<span class="sd">    code constructs will generate separate contexts or sub-contexts. This utility</span>
<span class="sd">    command retrieves a reference to the currently active Context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__current_context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">push_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Context</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Enter a sub-context by pushing a context to the global context stack.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__current_context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">current_context</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">pop_context</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Context</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Exit the current Context by popping it from the stack.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__current_context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">OutputFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encapsulate the details of Operation output implementation in the gmxapi.operation Context.</span>

<span class="sd">    Currently, OutputFactory objects are containers that compose functionality</span>
<span class="sd">    with which to implement the required internal interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">output_proxy</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">SourceResource</span><span class="p">],</span> <span class="n">_OutputDataProxyType</span><span class="p">],</span>
                 <span class="n">output_description</span><span class="p">:</span> <span class="n">OutputCollectionDescription</span><span class="p">,</span>
                 <span class="n">publishing_data_proxy</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">SourceResource</span><span class="p">,</span> <span class="n">ClientID</span><span class="p">],</span> <span class="n">_PublishingDataProxyType</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Package the output details for an operation.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            output_proxy: factory to produce the *output* facet of an operation instance (node)</span>
<span class="sd">            output_description: fully formed output description</span>
<span class="sd">            publishing_data_proxy: factory to produce the run time output publishing resources</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">output_proxy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;output_proxy argument must be a callable.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">publishing_data_proxy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;publishing_data_proxy argument must be a callable.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_description</span><span class="p">,</span> <span class="n">OutputCollectionDescription</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;output_description must be an instance of &#39;</span>
                                        <span class="s1">&#39;gmxapi.operation.OutputCollectionDescription&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_proxy</span> <span class="o">=</span> <span class="n">output_proxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_description</span> <span class="o">=</span> <span class="n">output_description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_publishing_data_proxy</span> <span class="o">=</span> <span class="n">publishing_data_proxy</span>

    <span class="k">def</span> <span class="nf">output_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">_OutputDataProxyType</span><span class="p">,</span> <span class="n">SourceResource</span><span class="p">],</span> <span class="n">_OutputDataProxyType</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_proxy</span>

    <span class="k">def</span> <span class="nf">output_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OutputCollectionDescription</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_description</span>

    <span class="k">def</span> <span class="nf">publishing_data_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">SourceResource</span><span class="p">,</span> <span class="n">ClientID</span><span class="p">],</span>
                                                       <span class="n">_PublishingDataProxyType</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publishing_data_proxy</span>


<span class="c1"># TODO: Refactor in terms of gmx.abc.OperationDirector[_Op, gmx.operation.Context]</span>
<span class="c1"># Normalizing this OperationDirector may require other updates to the function_wrapper facilities.</span>
<span class="k">class</span> <span class="nc">OperationDirector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Direct the construction of an operation node in the gmxapi.operation module Context.</span>

<span class="sd">    Collaboration: used by OperationDetails.operation_director, which</span>
<span class="sd">    will likely dispatch to different implementations depending on</span>
<span class="sd">    requirements of work or context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                 <span class="n">operation_details</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">OperationDetailsBase</span><span class="p">],</span>
                 <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_details</span> <span class="o">=</span> <span class="n">operation_details</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractOperation</span><span class="p">:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">node_builder</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">operation_details</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">set_resource_factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operation_details</span><span class="o">.</span><span class="n">resource_director</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">set_input_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operation_details</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">set_handle</span><span class="p">(</span><span class="n">OperationHandle</span><span class="p">)</span>

        <span class="n">operation_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_details</span><span class="p">()</span>
        <span class="n">node_input_factory</span> <span class="o">=</span> <span class="n">operation_details</span><span class="o">.</span><span class="n">signature</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span>
        <span class="n">data_source_collection</span> <span class="o">=</span> <span class="n">node_input_factory</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">data_source_collection</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_input</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">runner_director</span><span class="p">(</span><span class="n">resources</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">runner</span><span class="p">():</span>
                <span class="n">operation_details</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">runner</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">set_runner_director</span><span class="p">(</span><span class="n">runner_director</span><span class="p">)</span>
        <span class="c1"># Note that the call-backs held by OutputFactory cannot be annotated with</span>
        <span class="c1"># key word arguments under PEP 484, producing a weak warning in some cases.</span>
        <span class="c1"># We can consider more in the future how to balance call-back simplicity,</span>
        <span class="c1"># type annotation, and key word explicitness in helper functions like these.</span>
        <span class="n">output_factory</span> <span class="o">=</span> <span class="n">OutputFactory</span><span class="p">(</span><span class="n">output_description</span><span class="o">=</span><span class="n">operation_details</span><span class="o">.</span><span class="n">output_description</span><span class="p">(),</span>
                                       <span class="n">output_proxy</span><span class="o">=</span><span class="n">operation_details</span><span class="o">.</span><span class="n">output_data_proxy</span><span class="p">,</span>
                                       <span class="n">publishing_data_proxy</span><span class="o">=</span><span class="n">operation_details</span><span class="o">.</span><span class="n">publishing_data_proxy</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">set_output_factory</span><span class="p">(</span><span class="n">output_factory</span><span class="p">)</span>

        <span class="n">handle</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">handle</span>


<span class="k">def</span> <span class="nf">_make_datastore</span><span class="p">(</span><span class="n">output_description</span><span class="p">:</span> <span class="n">OutputCollectionDescription</span><span class="p">,</span> <span class="n">ensemble_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create the data store for an operation with the described output.</span>

<span class="sd">    Create a container to hold the resources for an operation node.</span>
<span class="sd">    Used internally by the resource manager when setting up the node.</span>
<span class="sd">    Evolution of the C++ framework for creating the Operation SessionResources</span>
<span class="sd">    object will inform the future of this and the resource_director method, but</span>
<span class="sd">    this data store is how the Context manages output data sources for resources</span>
<span class="sd">    that it manages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">datastore</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">output_description</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="n">result_description</span> <span class="o">=</span> <span class="n">ResultDescription</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">ensemble_width</span><span class="p">)</span>
        <span class="n">datastore</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">OutputData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">result_description</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datastore</span>


<span class="c1"># TODO: For outputs, distinguish between &quot;results&quot; and &quot;events&quot;.</span>
<span class="c1">#  Both are published to the resource manager in the same way, but the relationship</span>
<span class="c1">#  with subscribers is potentially different.</span>
<div class="viewcode-block" id="function_wrapper"><a class="viewcode-back" href="../../userguide/pythonreference.html#gmxapi.function_wrapper">[docs]</a><span class="k">def</span> <span class="nf">function_wrapper</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Suppress warnings in the example code.</span>
    <span class="c1"># noinspection PyUnresolvedReferences</span>
    <span class="sd">&quot;&quot;&quot;Generate a decorator for wrapped functions with signature manipulation.</span>

<span class="sd">    New function accepts the same arguments, with additional arguments required by</span>
<span class="sd">    the API.</span>

<span class="sd">    The new function returns an object with an `output` attribute containing the named outputs.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; @function_wrapper(output={&#39;spam&#39;: str, &#39;foo&#39;: str})</span>
<span class="sd">        ... def myfunc(parameter: str = None, output=None):</span>
<span class="sd">        ...    output.spam = parameter</span>
<span class="sd">        ...    output.foo = parameter + &#39; &#39; + parameter</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; operation1 = myfunc(parameter=&#39;spam spam&#39;)</span>
<span class="sd">        &gt;&gt;&gt; assert operation1.output.spam.result() == &#39;spam spam&#39;</span>
<span class="sd">        &gt;&gt;&gt; assert operation1.output.foo.result() == &#39;spam spam spam spam&#39;</span>

<span class="sd">    If &#39;output&#39; is provided to the wrapper, a data structure will be passed to</span>
<span class="sd">    the wrapped functions with the named attributes so that the function can easily</span>
<span class="sd">    publish multiple named results. Otherwise, the `output` of the generated operation</span>
<span class="sd">    will just capture the return value of the wrapped function.</span>

<span class="sd">    .. todo:: gmxapi typing stub file(s).</span>
<span class="sd">              The way this wrapper uses parameter annotations is not completely</span>
<span class="sd">              compatible with static type checking (PEP 484). If we decide to</span>
<span class="sd">              keep the convenience functionality by which operation details are</span>
<span class="sd">              inferred from parameter annotations, we should provide a separate</span>
<span class="sd">              stub file (.pyi) to support static type checking of the API.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TypeError</span><span class="p">(</span><span class="s1">&#39;If provided, `output` argument must be a mapping of data names to types.&#39;</span><span class="p">)</span>

    <span class="c1"># TODO: (FR5+) gmxapi operations need to allow a context-dependent way to generate an implementation with input.</span>
    <span class="c1"># This function wrapper reproduces the wrapped function&#39;s kwargs, but does not allow chaining a</span>
    <span class="c1"># dynamic `input` kwarg and does not dispatch according to a `context` kwarg. We should allow</span>
    <span class="c1"># a default implementation and registration of alternate implementations. We don&#39;t have to do that</span>
    <span class="c1"># with functools.singledispatch, but we could, if we add yet another layer to generate a wrapper</span>
    <span class="c1"># that takes the context as the first argument. (`singledispatch` inspects the first argument rather</span>
    <span class="c1"># that a named argument)</span>

    <span class="c1"># Implementation note: The closure of the current function is used to</span>
    <span class="c1"># dynamically define several classes that support the operation to be</span>
    <span class="c1"># created by the returned decorator.</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">:</span>
        <span class="c1"># Explicitly capture `function` and `output` references.</span>
        <span class="n">provided_output_map</span> <span class="o">=</span> <span class="n">output</span>

        <span class="c1"># Note: Allow operations to be defined entirely in template headers to facilitate</span>
        <span class="c1"># compile-time optimization of fused operations. Consider what distinction, if any,</span>
        <span class="c1"># exists between a fused operation and a more basic operation. Probably it amounts</span>
        <span class="c1"># to aspects related to interaction with the Context that get combined in a fused</span>
        <span class="c1"># operation, such as the resource director, builder, etc.</span>
        <span class="k">class</span> <span class="nc">OperationDetails</span><span class="p">(</span><span class="n">OperationDetailsBase</span><span class="p">):</span>
            <span class="c1"># Warning: function.__qualname__ is not rigorous since function may be in a local scope.</span>
            <span class="c1"># TODO: Improve base identifier.</span>
            <span class="c1"># Suggest registering directly in the Context instead of in this local class definition.</span>
            <span class="n">__basename</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="vm">__module__</span><span class="p">),</span> <span class="n">function</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">))</span>
            <span class="n">__last_uid</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_input_signature_description</span> <span class="o">=</span> <span class="n">InputCollectionDescription</span><span class="o">.</span><span class="n">from_function</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
            <span class="c1"># TODO: Separate the class and instance logic for the runner.</span>
            <span class="c1"># Logically, the runner is a detail of a context-specific implementation class,</span>
            <span class="c1"># though the output is not generally fully knowable until an instance is initialized</span>
            <span class="c1"># for a certain input fingerprint.</span>
            <span class="c1"># Note: We are almost at a point where this class can be subsumed into two</span>
            <span class="c1"># possible return types for wrapped_function_runner, acting as an operation helper.</span>
            <span class="n">_runner</span> <span class="o">=</span> <span class="n">wrapped_function_runner</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">provided_output_map</span><span class="p">)</span>
            <span class="n">_output_description</span> <span class="o">=</span> <span class="n">_runner</span><span class="o">.</span><span class="n">output_description</span>
            <span class="n">_output_data_proxy_type</span> <span class="o">=</span> <span class="n">define_output_data_proxy</span><span class="p">(</span><span class="n">_output_description</span><span class="p">)</span>
            <span class="n">_publishing_data_proxy_type</span> <span class="o">=</span> <span class="n">define_publishing_data_proxy</span><span class="p">(</span><span class="n">_output_description</span><span class="p">)</span>
            <span class="n">_SourceResource</span> <span class="o">=</span> <span class="n">SourceResource</span><span class="p">[</span><span class="n">_output_data_proxy_type</span><span class="p">,</span> <span class="n">_publishing_data_proxy_type</span><span class="p">]</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__basename</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">director</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">_Context</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">operation_director</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InputCollectionDescription</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;Mapping of named inputs and input type.</span>

<span class="sd">                Used to determine valid inputs before an Operation node is created.</span>

<span class="sd">                Overrides OperationDetailsBase.signature() to provide an</span>
<span class="sd">                implementation for the bound operation.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_input_signature_description</span>

            <span class="k">def</span> <span class="nf">output_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OutputCollectionDescription</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;Mapping of available outputs and types for an existing Operation node.</span>

<span class="sd">                Overrides OperationDetailsBase.output_description() to provide an</span>
<span class="sd">                implementation for the bound operation.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_description</span>

            <span class="k">def</span> <span class="nf">publishing_data_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                                      <span class="n">instance</span><span class="p">:</span> <span class="n">_SourceResource</span><span class="p">,</span>
                                      <span class="n">client_id</span><span class="p">:</span> <span class="nb">int</span>
                                      <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_publishing_data_proxy_type</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;Factory for Operation output publishing resources.</span>

<span class="sd">                Used internally when the operation is run with resources provided by instance.</span>

<span class="sd">                Overrides OperationDetailsBase.publishing_data_proxy() to provide an</span>
<span class="sd">                implementation for the bound operation.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">ResourceManager</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publishing_data_proxy_type</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">client_id</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">output_data_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">_SourceResource</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_output_data_proxy_type</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">ResourceManager</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_data_proxy_type</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="n">PyFunctionRunnerResources</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Execute the operation with provided resources.</span>

<span class="sd">                Resources are prepared in an execution context with aid of resource_director()</span>

<span class="sd">                After the first call, output data has been published and is trivially</span>
<span class="sd">                available through the output_data_proxy()</span>

<span class="sd">                Overrides OperationDetailsBase.__call__().</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">make_uid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;The unique identity of an operation node tags the output with respect to the input.</span>

<span class="sd">                Combines information on the Operation details and the input to uniquely</span>
<span class="sd">                identify the Operation node.</span>

<span class="sd">                Arguments:</span>
<span class="sd">                    input : A (collection of) data source(s) that can provide Fingerprints.</span>

<span class="sd">                Used internally by the Context to manage ownership of data sources, to</span>
<span class="sd">                locate resources for nodes in work graphs, and to manage serialization,</span>
<span class="sd">                deserialization, and checkpointing of the work graph.</span>

<span class="sd">                The UID is a detail of the generic Operation that _should_ be independent</span>
<span class="sd">                of the Context details to allow the framework to manage when and where</span>
<span class="sd">                an operation is executed.</span>

<span class="sd">                Design notes on further refinement:</span>
<span class="sd">                    TODO: Operations should not single-handedly determine their own uniqueness</span>
<span class="sd">                    (but they should participate in the determination with the Context).</span>

<span class="sd">                    Context implementations should be allowed to optimize handling of</span>
<span class="sd">                    equivalent operations in different sessions or work graphs, but we do not</span>
<span class="sd">                    yet TODO: guarantee that UIDs are globally unique!</span>

<span class="sd">                    The UID should uniquely indicate an operation node based on that node&#39;s input.</span>
<span class="sd">                    We need input fingerprinting to identify equivalent nodes in a work graph</span>
<span class="sd">                    or distinguish nodes across work graphs.</span>

<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__basename</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__last_uid</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__last_uid</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">uid</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">resource_director</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">output</span><span class="p">:</span> <span class="n">_publishing_data_proxy_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PyFunctionRunnerResources</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;a Director factory that helps build the Session Resources for the function.</span>

<span class="sd">                The Session launcher provides the director with all of the resources previously</span>
<span class="sd">                requested/negotiated/registered by the Operation. The director uses details of</span>
<span class="sd">                the operation to build the resources object required by the operation runner.</span>

<span class="sd">                For the Python Context, the protocol is for the Context to call the</span>
<span class="sd">                resource_director instance method, passing input and output containers.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">resources</span> <span class="o">=</span> <span class="n">PyFunctionRunnerResources</span><span class="p">()</span>
                <span class="n">resources</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">resources</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">output</span><span class="p">})</span>

                <span class="c1"># TODO: Remove this hack when we can better handle Futures of Containers and Future slicing.</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resources</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                        <span class="n">resources</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">resources</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

                <span class="c1"># Check data compatibility</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
                        <span class="n">expected</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">signature</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
                        <span class="n">got</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">got</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">TypeError</span><span class="p">(</span><span class="s1">&#39;Expected </span><span class="si">{}</span><span class="s1"> but got </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">got</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">resources</span>

        <span class="c1"># TODO: (FR4) Update annotations with gmxapi data types. E.g. return -&gt; Future.</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">helper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Description of the Operation input (and output) occurs in the</span>
            <span class="c1"># decorator closure. By the time this factory is (dynamically) defined,</span>
            <span class="c1"># the OperationDetails and ResourceManager are well defined, but not</span>
            <span class="c1"># yet instantiated.</span>
            <span class="c1"># Inspection of the offered input occurs when this factory is called,</span>
            <span class="c1"># and OperationDetails, ResourceManager, and Operation are instantiated.</span>

            <span class="c1"># This operation factory is specialized for the default package Context.</span>
            <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">current_context</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Non-default context handling not implemented.&#39;</span><span class="p">)</span>

            <span class="c1"># This calls a dispatching function that may not be able to reconcile the input</span>
            <span class="c1"># and Context capabilities. This is the place to handle various exceptions for</span>
            <span class="c1"># whatever reasons this reconciliation cannot occur.</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">OperationDetails</span><span class="o">.</span><span class="n">operation_director</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># TODO: NOW: The input fingerprint describes the provided input</span>
            <span class="c1"># as (a) ensemble input, (b) static, (c) future. By the time the</span>
            <span class="c1"># operation is instantiated, the topology of the node is known.</span>
            <span class="c1"># When compared to the InputCollectionDescription, the data compatibility</span>
            <span class="c1"># can be determined.</span>

            <span class="k">return</span> <span class="n">handle</span>

        <span class="c1"># to do: The factory itself needs to be able to register a factory with</span>
        <span class="c1"># the context that will be responsible for the Operation handle.</span>
        <span class="c1"># The factories need to be able to serve as dispatchers for themselves,</span>
        <span class="c1"># since an operation in one context may need to be reconstituted in a</span>
        <span class="c1"># different context.</span>
        <span class="c1"># The dispatching factory produces a director for a Context,</span>
        <span class="c1"># which will register a factory with the operation in that context.</span>

        <span class="c1"># The factory function has a DirectorFactory. Director instances talk to a NodeBuilder for a Context to</span>
        <span class="c1"># get handles to new operation nodes managed by the context. Part of that process includes registering</span>
        <span class="c1"># a DirectorFactory with the Context.</span>
        <span class="k">return</span> <span class="n">helper</span>

    <span class="k">return</span> <span class="n">decorator</span></div>


<span class="k">class</span> <span class="nc">GraphVariableDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">internal_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Access is through the class attribute of the owning class.</span>
            <span class="c1"># Allows the descriptor itself to be inspected or reconfigured after</span>
            <span class="c1"># class definition.</span>
            <span class="c1"># TODO: There is probably some usage checking that can be performed here.</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span>
            <span class="c1"># Lazily initialize the instance value from the class default.</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Could not assign default value to </span><span class="si">{}</span><span class="s1"> attribute of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">internal_name</span><span class="p">,</span>
                        <span class="n">instance</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="c1"># Implementation note: If we have a version of the descriptor class with no `__set__` method,</span>
    <span class="c1"># it is a non-data descriptor that can be overridden by a data descriptor on an instance.</span>
    <span class="c1"># This could be one way to handle the polymorphism associated with state changes.</span>
    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">_editing</span><span class="p">:</span>
            <span class="c1"># Update the internal connections defining the subgraph.</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not assignable on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">instance</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">GraphMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta-class for gmxapi data flow graphs and subgraphs.</span>

<span class="sd">    Used to implement ``subgraph`` as GraphMeta.__new__(...).</span>
<span class="sd">    Also allows subgraphs to be defined as Python class definitions by inheriting</span>
<span class="sd">    from Subgraph or by using the ``metaclass=GraphMeta`` hint in the class</span>
<span class="sd">    statement arguments.</span>

<span class="sd">    The Python class creation protocol allows Subgraphs to be defined in as follows.</span>

<span class="sd">    See the Subgraph class documentation for customization of instances through</span>
<span class="sd">    the Python context manager protocol.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_prepare_keywords</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;variables&#39;</span><span class="p">,)</span>

    <span class="c1"># TODO: Python 3.7.2 introduces typing.OrderedDict</span>
    <span class="c1"># In practice, we are using collections.OrderedDict, but we should use the generic</span>
    <span class="c1"># ABC from the typing module to avoid being overly restrictive with type hints.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">OrderedDict</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__prepare__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">OrderedDict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the class namespace.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">              variables: mapping of persistent graph variables to type / default value (optional)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Python runs this before executing the class body of Subgraph or its</span>
        <span class="c1"># subclasses. This is our chance to handle key word arguments given in the</span>
        <span class="c1"># class declaration.</span>

        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Unexpected key word argument: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyword</span><span class="p">))</span>

        <span class="n">namespace</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">):</span>
                            <span class="n">default</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">default</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">default</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
                            <span class="n">dtype</span> <span class="o">=</span> <span class="n">default</span><span class="o">.</span><span class="n">dtype</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
                    <span class="n">namespace</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">GraphVariableDescriptor</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="c1"># Note: we are not currently using the hook used by `inspect`</span>
                    <span class="c1"># to annotate with the class that defined the attribute.</span>
                    <span class="c1"># namespace[name].__objclass__ = mcs</span>
                    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="s1">&#39;__objclass__&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;variables&quot; must be a mapping of graph variables to types or defaults.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">namespace</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">GraphMeta</span><span class="o">.</span><span class="n">_prepare_keywords</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Unexpected class creation keyword: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

    <span class="c1"># TODO: This is keyword argument stripping is not necessary in more recent Python versions.</span>
    <span class="c1"># When Python minimum required version is increased, check if we can remove this.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">GraphMeta</span><span class="o">.</span><span class="n">_prepare_keywords</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ApiError</span><span class="p">(</span><span class="s1">&#39;Unexpected class initialization keyword: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SubgraphNodeBuilder</span><span class="p">(</span><span class="n">NodeBuilder</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">context</span><span class="p">:</span> <span class="s1">&#39;SubgraphContext&#39;</span><span class="p">,</span>
                 <span class="n">operation</span><span class="p">,</span>
                 <span class="n">label</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an input resource for the Node under construction.</span>

<span class="sd">        Extends NodeBuilder.add_input()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Inspect inputs.</span>
        <span class="c1">#  * Are they from outside the subgraph?</span>
        <span class="c1">#  * Subgraph variables?</span>
        <span class="c1">#  * Subgraph internal nodes?</span>
        <span class="c1"># Inputs from outside the subgraph are (provisionally) subgraph inputs.</span>
        <span class="c1"># Inputs that are subgraph variables or subgraph internal nodes mark operations that will need to be re-run.</span>
        <span class="c1"># For first implementation, let all operations be recreated, but we need to</span>
        <span class="c1"># manage the right input proxies.</span>
        <span class="c1"># For zeroeth implementation, try just tracking the entities that need a reset() method called.</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">SubgraphContext</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;reset&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_resetter</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">reset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;_reset&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_resetter</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">_reset</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_input</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationPlaceholder</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a reference to the internal node in the subgraph definition.</span>

<span class="sd">        In the SubgraphContext, these handles cannot represent uniquely identifiable</span>
<span class="sd">        results. They are placeholders for relative positions in graphs that are</span>
<span class="sd">        not defined until the subgraph is being executed.</span>

<span class="sd">        Such references should be tracked and invalidated when exiting the</span>
<span class="sd">        subgraph context. Within the subgraph context, they are used to establish</span>
<span class="sd">        the recipe for updating the subgraph&#39;s outputs or persistent data during</span>
<span class="sd">        execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Placeholder handles in the subgraph definition don&#39;t have real resource managers.</span>
        <span class="c1"># Check for the ability to instantiate operations.</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="c1"># handle = OperationPlaceholder()</span>
        <span class="k">return</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">OperationPlaceholder</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SubgraphContext</span><span class="p">(</span><span class="n">Context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide a Python context manager in which to set up a graph of operations.</span>

<span class="sd">    Allows operations to be configured without adding nodes to the global execution</span>
<span class="sd">    context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">node_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeBuilder</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;Label </span><span class="si">{}</span><span class="s1"> is already in use.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The builder should update the labeled node when it is done.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">SubgraphNodeBuilder</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_resetter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Subgraph</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">GraphMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    When subclassing from Subgraph, aspects of the subgraph&#39;s data ports can be</span>
<span class="sd">    specified with keyword arguments in the class statement. Example::</span>

<span class="sd">        &gt;&gt;&gt; class MySubgraph(Subgraph, variables={&#39;int_with_default&#39;: 1, &#39;boolData&#39;: bool}): pass</span>
<span class="sd">        ...</span>

<span class="sd">    The key word *variables* is used in the class declaration to map the types</span>
<span class="sd">    of subgraph Variables with (optional) default values.</span>

<span class="sd">    Execution model:</span>
<span class="sd">        Subgraph execution must follow a well-defined protocol in order to sensibly</span>
<span class="sd">        resolve data Futures at predictable points. Note that subgraphs act as operations</span>
<span class="sd">        that can be automatically redefined at run time (in limited cases), such as</span>
<span class="sd">        to automatically form iteration chains to implement &quot;while&quot; loops. We refer</span>
<span class="sd">        to one copy / iteration / generation of a subgraph as an &quot;element&quot; below.</span>

<span class="sd">        When a subgraph element begins execution, each of its variables with an</span>
<span class="sd">        &quot;updated&quot; state from the previous iteration has the &quot;updated&quot; state moved</span>
<span class="sd">        to the new element&#39;s &quot;initial&quot; state, and the &quot;updated&quot; state is voided.</span>

<span class="sd">        Subgraph.next() appends an element of the subgraph to the chain. Subsequent</span>
<span class="sd">        calls to Subgraph.run() bring the new outputs up to date (and then call next()).</span>
<span class="sd">        Thus, for a subgraph with an output called ``is_converged``, calling</span>
<span class="sd">        ``while (not subgraph.is_converged): subgraph.run()`` has the desired effect,</span>
<span class="sd">        but is likely suboptimal for execution. Instead use the gmxapi while_loop.</span>

<span class="sd">        If the subgraph is not currently executing, it can be in one of two states:</span>
<span class="sd">        &quot;editing&quot; or &quot;ready&quot;. In the &quot;ready&quot; state, class and instance Variables</span>
<span class="sd">        cannot be assigned, but can be read through the data descriptors. In this</span>
<span class="sd">        state, the descriptors only have a single state.</span>

<span class="sd">        If &quot;editing,&quot; variables on the class object can be assigned to update the</span>
<span class="sd">        data flow defined for the subgraph. While &quot;editing&quot;, reading or writing</span>
<span class="sd">        instance Variables is undefined behavior.</span>

<span class="sd">        When &quot;editing&quot; begins, each variable is readable as a proxy to the &quot;initial&quot;</span>
<span class="sd">        state in an element. Assignments while &quot;editing&quot; put variables in temporary</span>
<span class="sd">        states accessible only during editing.</span>
<span class="sd">        When &quot;editing&quot; finishes, the &quot;updated&quot; output data source of each</span>
<span class="sd">        variable for the element is set, if appropriate.</span>

<span class="sd">        # TODO: Use a get_context to allow operation factories or accessors to mark</span>
<span class="sd">        #  references for update/annotation when exiting the &#39;with&#39; block.</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">SubgraphBuilder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper for defining new Subgraphs.</span>

<span class="sd">    Manages a Python context in which to define a new Subgraph type. Can be used</span>
<span class="sd">    in a Python ``with`` construct exactly once to provide the Subgraph class body.</span>
<span class="sd">    When the ``with`` block is exited (or ``build()`` is called explicitly), a</span>
<span class="sd">    new type instance becomes available. Subsequent calls to SubgraphBuilder.__call__(self, ...)</span>
<span class="sd">    are dispatched to the Subgraph constructor.</span>

<span class="sd">    Outside of the ``with`` block, read access to data members is proxied to</span>
<span class="sd">    descriptors on the built Subgraph.</span>

<span class="sd">    Instances of SubgraphBuilder are returned by the ``subgraph()`` utility function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;variables&#39;</span><span class="p">:</span> <span class="n">variables</span><span class="p">,</span>
                              <span class="s1">&#39;_staging&#39;</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(),</span>
                              <span class="s1">&#39;_editing&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="s1">&#39;_subgraph_context&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="s1">&#39;_subgraph_instance&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="s1">&#39;_fused_operation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="s1">&#39;_factory&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
        <span class="c1"># Return a placeholder that we can update during iteration.</span>
        <span class="c1"># Long term, this is probably implemented with data descriptors</span>
        <span class="c1"># that will be moved to a new Subgraph type object.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">Future</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">make_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

        <span class="c1"># class MySubgraph(Subgraph, variables=variables):</span>
        <span class="c1">#     pass</span>
        <span class="c1">#</span>
        <span class="c1"># self._subgraph_instance = MySubgraph()</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_editing</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staging</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Read access to intermediate value of subgraph variable </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staging</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Read access to subgraph variable </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Invalid attribute: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: this is not quite the described interface...</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Part of the builder interface.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_editing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_update</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Subgraph is not in an editable state.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a variable update to the internal subgraph.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;No such attribute: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_editing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Subgraph is not in an editable state.&#39;</span><span class="p">)</span>
        <span class="c1"># Else, stage the potential final value for the iteration.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Staging subgraph update </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="c1"># Return a placeholder that we can update during iteration.</span>
        <span class="c1"># Long term, this is probably implemented with data descriptors</span>
        <span class="c1"># that will be moved to a new Subgraph type object.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Future</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">make_constant</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staging</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staging</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enter a Context managed by the subgraph to capture operation additions.</span>

<span class="sd">        Allows the internal data flow of the subgraph to be defined in the same</span>
<span class="sd">        manner as the default work graph while the Python context manager is active.</span>

<span class="sd">        The subgraph Context is activated when entering a ``with`` block and</span>
<span class="sd">        finalized at the end of the block.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># While editing the subgraph in the SubgraphContext, we need __get__ and __set__</span>
        <span class="c1"># data descriptor access on the Subgraph subclass type, but outside of the</span>
        <span class="c1"># context manager, the descriptor should be non-writable and more opaque,</span>
        <span class="c1"># while the instance should be readable, but not writable.</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_editing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># TODO: this probably needs to be configured with variables...</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_subgraph_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubgraphContext</span><span class="p">()</span>
        <span class="n">push_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgraph_context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the subgraph by defining some new operations.</span>

<span class="sd">        Examine the subgraph variables. Variables with handles to data sources</span>
<span class="sd">        in the SubgraphContext represent work that needs to be executed on</span>
<span class="sd">        a subgraph execution or iteration. Variables with handles to data sources</span>
<span class="sd">        outside of the subgraph represent work that needs to be executed once</span>
<span class="sd">        on only the first iteration to initialize the subgraph.</span>

<span class="sd">        Construct a factory for the fused operation that performs the work to</span>
<span class="sd">        update the variables on a single iteration.</span>

<span class="sd">        Construct a factory for the fused operation that performs the work to</span>
<span class="sd">        update the variables on subsequent iterations and which will be fed</span>
<span class="sd">        the outputs of a previous iteration. Both of the generated operations</span>
<span class="sd">        have the same output signature.</span>

<span class="sd">        Construct and wrap the generator function to recursively append work</span>
<span class="sd">        to the graph and update until condition is satisfied.</span>

<span class="sd">        TODO: Explore how to drop work from the graph once there are no more</span>
<span class="sd">         references to its output, including check-point machinery.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finalizing subgraph definition.&#39;</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># TODO: What if we don&#39;t want to provide default values?</span>
            <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">updates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staging</span>

        <span class="k">class</span> <span class="nc">Subgraph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_futures</span><span class="p">,</span> <span class="n">update_sources</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">result</span><span class="p">())</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">input_futures</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;subgraph initialized with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()])))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">futures</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">input_futures</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_sources</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">update_sources</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Subgraph updates staged:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">update</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_sources</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_sources</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Update: </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="c1"># Replace the data sources in the futures.</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_sources</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">resource_manager</span> <span class="o">=</span> <span class="n">gmx</span><span class="o">.</span><span class="n">make_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">])</span><span class="o">.</span><span class="n">resource_manager</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_sources</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_sources</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>

        <span class="n">subgraph</span> <span class="o">=</span> <span class="n">Subgraph</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">lambda</span> <span class="n">subgraph</span><span class="o">=</span><span class="n">subgraph</span><span class="p">:</span> <span class="n">subgraph</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End the Subgraph editing session and finalize the Subgraph build.</span>

<span class="sd">        After exiting, this instance forwards __call__() to a factory for an</span>
<span class="sd">        operation that carries out the work in the subgraph with inputs bound</span>
<span class="sd">        in the current context as defined by ``variables``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">pop_context</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subgraph_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_editing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Returning False causes exceptions in the `with` block to be reraised.</span>
        <span class="c1"># Remember to switch this to return True if we want to transform or suppress</span>
        <span class="c1"># such an exception (we probably do).</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got exception </span><span class="si">{}</span><span class="s1"> while editing subgraph </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc_val</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Subgraph exception traceback: </span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc_tb</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: After build() has been called, this should dispatch to a factory</span>
        <span class="c1">#  that returns an OperationHandle.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">()</span>


<div class="viewcode-block" id="while_loop"><a class="viewcode-back" href="../../userguide/pythonreference.html#gmxapi.while_loop">[docs]</a><span class="k">def</span> <span class="nf">while_loop</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">max_iteration</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate and run a chain of operations such that condition evaluates True.</span>

<span class="sd">    Returns and operation instance that acts like a single node in the current</span>
<span class="sd">    work graph, but which is a proxy to the operation at the end of a dynamically generated chain</span>
<span class="sd">    of operations. At run time, condition is evaluated for the last element in</span>
<span class="sd">    the current chain. If condition evaluates False, the chain is extended and</span>
<span class="sd">    the next element is executed. When condition evaluates True, the object</span>
<span class="sd">    returned by ``while_loop`` becomes a proxy for the last element in the chain.</span>

<span class="sd">    Equivalent to calling operation.while(condition), where available.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        operation: a callable that produces an instance of an operation when called with no arguments.</span>
<span class="sd">        condition: a callable that accepts an object (returned by ``operation``) that returns a boolean.</span>
<span class="sd">        max_iteration: execute the loop no more than this many times (default 10)</span>

<span class="sd">    Warning:</span>
<span class="sd">        *max_iteration* is provided in part to minimize the cost of bugs in early</span>
<span class="sd">        versions of this software. The default value may be changed or</span>
<span class="sd">        removed on short notice.</span>

<span class="sd">    Warning:</span>
<span class="sd">        The protocol by which ``while_loop`` interacts with ``operation`` and ``condition``</span>
<span class="sd">        is very unstable right now. Please refer to this documentation when installing new</span>
<span class="sd">        versions of the package.</span>

<span class="sd">    Protocol:</span>
<span class="sd">        Warning:</span>
<span class="sd">            This protocol will be changed before the 0.1 API is finalized.</span>

<span class="sd">        When called, ``while_loop`` calls ``operation`` without arguments</span>
<span class="sd">        and captures the return value captured as ``_operation``.</span>
<span class="sd">        The object produced by ``operation()`` must have a ``reset``,</span>
<span class="sd">        a ``run`` method, and an ``output`` attribute.</span>

<span class="sd">        This is inspected</span>
<span class="sd">        to determine the output data proxy for the operation produced by the call</span>
<span class="sd">        to ``while_loop``. When that operation is called, it does the equivalent of</span>

<span class="sd">            while(condition(self._operation)):</span>
<span class="sd">                self._operation.reset()</span>
<span class="sd">                self._operation.run()</span>

<span class="sd">        Then, the output data proxy of ``self`` is updated with the results from</span>
<span class="sd">        self._operation.output.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># In the first implementation, Subgraph is NOT and OperationHandle.</span>
    <span class="c1"># if not isinstance(obj, AbstractOperationHandle):</span>
    <span class="c1">#     raise exceptions.UsageError(</span>
    <span class="c1">#     &#39;&quot;operation&quot; key word argument must be a callable that produces an Operation handle.&#39;)</span>
    <span class="c1"># outputs = {}</span>
    <span class="c1"># for name, descriptor in obj.output.items():</span>
    <span class="c1">#     outputs[name] = descriptor._dtype</span>

    <span class="c1"># 1. Get the initial inputs.</span>
    <span class="c1"># 2. Initialize the subgraph with the initial inputs.</span>
    <span class="c1"># 3. Run the subgraph.</span>
    <span class="c1"># 4. Get the outputs.</span>
    <span class="c1"># 5. Initialize the subgraph with the outputs.</span>
    <span class="c1"># 6. Go to 3 if condition is not met.</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">operation</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="nd">@function_wrapper</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">run_loop</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">OutputCollectionDescription</span><span class="p">):</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">operation</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Created object </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Condition: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">condition</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">condition</span><span class="p">(</span><span class="n">obj</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running iteration </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">]))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Condition: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">condition</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
            <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">max_iteration</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">return</span> <span class="n">run_loop</span></div>


<div class="viewcode-block" id="subgraph"><a class="viewcode-back" href="../../userguide/pythonreference.html#gmxapi.subgraph">[docs]</a><span class="k">def</span> <span class="nf">subgraph</span><span class="p">(</span><span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allow operations to be configured in a sub-context.</span>

<span class="sd">    The object returned functions as a Python context manager. When entering the</span>
<span class="sd">    context manager (the beginning of the ``with`` block), the object has an</span>
<span class="sd">    attribute for each of the named ``variables``. Reading from these variables</span>
<span class="sd">    gets a proxy for the initial value or its update from a previous loop iteration.</span>
<span class="sd">    At the end of the ``with`` block, any values or data flows assigned to these</span>
<span class="sd">    attributes become the output for an iteration.</span>

<span class="sd">    After leaving the ``with`` block, the variables are no longer assignable, but</span>
<span class="sd">    can be called as bound methods to get the current value of a variable.</span>

<span class="sd">    When the object is run, operations bound to the variables are ``reset`` and</span>
<span class="sd">    run to update the variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Implementation note:</span>
    <span class="c1"># A Subgraph (type) has a subgraph context associated with it. The subgraph&#39;s</span>
    <span class="c1"># ability to capture operation additions is implemented in terms of the</span>
    <span class="c1"># subgraph context.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Declare a new subgraph with variables </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variables</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">SubgraphBuilder</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span></div>


<div class="viewcode-block" id="join_arrays"><a class="viewcode-back" href="../../userguide/pythonreference.html#gmxapi.join_arrays">[docs]</a><span class="nd">@computed_result</span>
<span class="k">def</span> <span class="nf">join_arrays</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">front</span><span class="p">:</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">back</span><span class="p">:</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Operation that consumes two sequences and produces a concatenated single sequence.</span>

<span class="sd">    Note that the exact signature of the operation is not determined until this</span>
<span class="sd">    helper is called. Helper functions may dispatch to factories for different</span>
<span class="sd">    operations based on the inputs. In this case, the dtype and shape of the</span>
<span class="sd">    inputs determines dtype and shape of the output. An operation instance must</span>
<span class="sd">    have strongly typed output, but the input must be strongly typed on an</span>
<span class="sd">    object definition so that a Context can make runtime decisions about</span>
<span class="sd">    dispatching work and data before instantiating.</span>
<span class="sd">    # TODO: elaborate and clarify.</span>
<span class="sd">    # TODO: check type and shape.</span>
<span class="sd">    # TODO: figure out a better annotation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: (FR4) Returned list should be an NDArray.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">front</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">back</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;Input must be a pair of lists.&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">front</span><span class="p">,</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">back</span><span class="p">,</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span>
    <span class="n">new_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">front</span><span class="o">.</span><span class="n">_values</span><span class="p">)</span>
    <span class="n">new_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">back</span><span class="o">.</span><span class="n">_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">(</span><span class="n">new_list</span><span class="p">)</span></div>


<span class="c1"># TODO: Constrain</span>
<span class="n">Scalar</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;Scalar&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="concatenate_lists"><a class="viewcode-back" href="../../userguide/pythonreference.html#gmxapi.concatenate_lists">[docs]</a><span class="k">def</span> <span class="nf">concatenate_lists</span><span class="p">(</span><span class="n">sublists</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="n">_Future</span><span class="p">[</span><span class="n">gmx</span><span class="o">.</span><span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Combine data sources into a single list.</span>

<span class="sd">    A trivial data flow restructuring operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sublists</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValueError</span><span class="p">(</span><span class="s1">&#39;Input must be a list of lists.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sublists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">ndarray</span><span class="p">([])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO: Fix the data model so that this can type-check properly.</span>
        <span class="k">return</span> <span class="n">join_arrays</span><span class="p">(</span><span class="n">front</span><span class="o">=</span><span class="n">sublists</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">back</span><span class="o">=</span><span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">datamodel</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
                                            <span class="n">concatenate_lists</span><span class="p">(</span><span class="n">sublists</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span></div>


<div class="viewcode-block" id="make_constant"><a class="viewcode-back" href="../../userguide/pythonreference.html#gmxapi.make_constant">[docs]</a><span class="k">def</span> <span class="nf">make_constant</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Scalar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Future</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Provide a predetermined value at run time.</span>

<span class="sd">    This is a trivial operation that provides a (typed) value, primarily for</span>
<span class="sd">    internally use to manage gmxapi data flow.</span>

<span class="sd">    Accepts a value of any type. The object returned has a definite type and</span>
<span class="sd">    provides same interface as other gmxapi outputs. Additional constraints or</span>
<span class="sd">    guarantees on data type may appear in future versions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">StaticSourceManager</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">proxied_data</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">ResultDescription</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">future</span></div>


<div class="viewcode-block" id="logical_not"><a class="viewcode-back" href="../../userguide/pythonreference.html#gmxapi.logical_not">[docs]</a><span class="k">def</span> <span class="nf">logical_not</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Future</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Boolean negation.</span>

<span class="sd">    If the argument is a gmxapi compatible Data or Future object, a new View or</span>
<span class="sd">    Future is created that proxies the boolean opposite of the input.</span>

<span class="sd">    If the argument is a callable, logical_not returns a wrapper function that</span>
<span class="sd">    returns a Future for the logical opposite of the callable&#39;s result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Small data transformations like this don&#39;t need to be formal Operations.</span>
    <span class="c1"># This could be essentially a data annotation that affects the resolver in a</span>
    <span class="c1"># DataEdge. As an API detail, coding for different Contexts and optimizations</span>
    <span class="c1"># within those Context implementations could be simplified.</span>
    <span class="n">operation</span> <span class="o">=</span> <span class="n">function_wrapper</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">})(</span><span class="k">lambda</span> <span class="n">data</span><span class="o">=</span><span class="nb">bool</span><span class="p">():</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">operation</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">data</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">gmxapi</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, M. Eric Irrgang and Peter Kasson; 2019, GROMACS development team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>